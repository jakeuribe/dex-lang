<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
body{font-family:"SF Mono","Fira Code",monospace;max-width:960px;margin:0 auto;padding:20px;background:#0d1117;color:#c9d1d9}
.code-block{background:#161b22;padding:12px;margin:6px 0;border-radius:6px;overflow-x:auto;font-size:14px}
.prose-block{padding:8px 0} .prose-block h1{color:#58a6ff;border-bottom:1px solid #30363d;padding-bottom:8px}
.prose-block h2{color:#58a6ff}
.result{background:#1c2128;padding:10px;margin:2px 0;border-left:3px solid #3fb950;border-radius:0 4px 4px 0;font-size:13px}
.error{background:#1c0000;padding:10px;margin:2px 0;border-left:3px solid #f85149;border-radius:0 4px 4px 0}
img.plot-img{max-width:100%;height:auto;display:block;margin:12px auto;border-radius:4px;border:1px solid #30363d}
svg{max-width:100%;height:auto;display:block;margin:12px auto}
pre{margin:0;white-space:pre-wrap}
span{white-space:pre-wrap}
</style></head><body>
<h1 style="color:#58a6ff;text-align:center">08-brownian-motion</h1><hr style="border-color:#30363d">
<div class="code-block"><span class="comment"></span></div>
<div class="prose-block"><h1>Virtual Brownian Motion and Sheet samplers</h1>
<p>This demo implements algorithms for stateless, constant-memory
sampling of entire functions from a Brownian motion of
any dimension.  This kind of sampler is useful in adaptive
stochastic partial differential equation solvers, since it
allows the noise to be sampled in a stateless manner.</p>
</div>
<div class="prose-block"><p>This code also demonstrates Dex's ability to do fast stateful for loops,
split random keys in a fine-grained way,
and how to use the typeclass system to implement
a form of recursion.</p>
</div>
<div class="prose-block"><h2>One-dimensional Brownian Motion on the Unit Interval</h2>
<p>The function below implements the virtual Brownian tree algorithm from <a href="https://arxiv.org/pdf/2001.01328.pdf">Scalable Gradients for Stochastic Differential Equations</a>.
It lazily evaluates the value of a function sampled from a
<a href="https://en.wikipedia.org/wiki/Brownian_bridge">Brownian bridge</a>
up to a specified input tolerance.</p>
</div>
<div class="prose-block"><p>The rest of the algorithms in this file simply translate and
scale calls to this function.</p>
</div>
<div class="code-block"><span class="keyword" id="span_5_2">struct</span><span> </span><span id="span_5_3">SamplerState</span><span class="symbol" id="span_5_5">(</span><span id="span_5_6">v</span><span class="symbol" id="span_5_7">)</span><span> </span><span class="symbol" id="span_5_8">=</span><span class="comment">
  </span><span id="span_5_9">k</span><span>      </span><span class="symbol" id="span_5_10">:</span><span> </span><span id="span_5_11">Key</span><span class="comment">
  </span><span id="span_5_12">y</span><span>      </span><span class="symbol" id="span_5_13">:</span><span> </span><span id="span_5_14">v</span><span class="comment">
  </span><span id="span_5_15">sigma</span><span>  </span><span class="symbol" id="span_5_16">:</span><span> </span><span id="span_5_17">Float</span><span class="comment">
  </span><span id="span_5_18">t</span><span>      </span><span class="symbol" id="span_5_19">:</span><span> </span><span id="span_5_20">Float</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_7_22">def</span><span> </span><span id="span_7_23">sample_unit_brownian_bridge</span><span class="symbol" id="span_7_25">(</span><span class="comment">
    </span><span id="span_7_26">tolerance</span><span class="symbol" id="span_7_27">:</span><span id="span_7_29">Float</span><span class="symbol" id="span_7_30">,</span><span class="comment">
    </span><span id="span_7_31">sampler</span><span class="symbol" id="span_7_32">:</span><span> </span><span class="symbol" id="span_7_35">(</span><span id="span_7_36">Key</span><span class="symbol" id="span_7_37">)</span><span class="symbol" id="span_7_38">-&gt;</span><span id="span_7_40">v</span><span class="symbol" id="span_7_41">,</span><span class="comment">
    </span><span id="span_7_42">key</span><span class="symbol" id="span_7_43">:</span><span id="span_7_45">Key</span><span class="symbol" id="span_7_46">,</span><span class="comment">
    </span><span id="span_7_47">t</span><span class="symbol" id="span_7_48">:</span><span id="span_7_50">Float</span><span class="comment">
    </span><span class="symbol" id="span_7_51">)</span><span> </span><span class="symbol" id="span_7_52">-&gt;</span><span> </span><span id="span_7_53">v</span><span> </span><span class="keyword" id="span_7_54">given</span><span> </span><span class="symbol" id="span_7_56">(</span><span id="span_7_57">v</span><span class="symbol" id="span_7_58">|</span><span id="span_7_60">VSpace</span><span class="symbol" id="span_7_61">)</span><span> </span><span class="symbol" id="span_7_62">=</span><span class="comment">
  # Can only handle t between 0 and 1.
  # iteratively subdivide to desired tolerance.
  </span><span id="span_7_65">num_iters</span><span> </span><span class="symbol" id="span_7_66">=</span><span> </span><span class="literal" id="span_7_67">10</span><span> </span><span class="symbol" id="span_7_68">+</span><span> </span><span id="span_7_70">f_to_n</span><span> </span><span class="symbol" id="span_7_73">(</span><span class="symbol" id="span_7_74">-</span><span id="span_7_76">log</span><span> </span><span id="span_7_78">tolerance</span><span class="symbol" id="span_7_79">)</span><span class="comment">
  </span><span id="span_7_81">init_state</span><span> </span><span class="symbol" id="span_7_82">=</span><span> </span><span id="span_7_83">SamplerState</span><span class="symbol" id="span_7_86">(</span><span id="span_7_87">key</span><span class="symbol" id="span_7_88">,</span><span> </span><span id="span_7_89">zero</span><span class="symbol" id="span_7_90">,</span><span> </span><span class="literal" id="span_7_91">1.0</span><span class="symbol" id="span_7_92">,</span><span> </span><span id="span_7_93">t</span><span class="symbol" id="span_7_94">)</span><span class="comment">
  </span><span id="span_7_96">result</span><span> </span><span class="symbol" id="span_7_97">=</span><span> </span><span id="span_7_98">fold</span><span> </span><span id="span_7_100">init_state</span><span> </span><span class="symbol" id="span_7_103">\</span><span id="span_7_104">i</span><span class="symbol" id="span_7_105">:</span><span class="symbol" id="span_7_108">(</span><span id="span_7_109">Fin</span><span> </span><span id="span_7_111">num_iters</span><span class="symbol" id="span_7_112">)</span><span> </span><span id="span_7_113">prev</span><span class="symbol" id="span_7_114">.</span><span class="comment">
      </span><span class="symbol" id="span_7_118">[</span><span id="span_7_119">key_draw</span><span class="symbol" id="span_7_120">,</span><span> </span><span id="span_7_121">key_left</span><span class="symbol" id="span_7_122">,</span><span> </span><span id="span_7_123">key_right</span><span class="symbol" id="span_7_124">]</span><span> </span><span class="symbol" id="span_7_125">=</span><span> </span><span id="span_7_126">split_key</span><span> </span><span id="span_7_128">key</span><span class="comment">
      # add scaled noise
      </span><span id="span_7_130">t&#39;</span><span> </span><span class="symbol" id="span_7_131">=</span><span> </span><span id="span_7_132">abs</span><span> </span><span class="symbol" id="span_7_135">(</span><span id="span_7_136">prev</span><span class="symbol" id="span_7_138">.</span><span id="span_7_139">t</span><span> </span><span class="symbol" id="span_7_140">-</span><span> </span><span class="literal" id="span_7_142">0.5</span><span class="symbol" id="span_7_143">)</span><span class="comment">
      </span><span id="span_7_145">new_y</span><span> </span><span class="symbol" id="span_7_146">=</span><span> </span><span id="span_7_147">prev</span><span class="symbol" id="span_7_149">.</span><span id="span_7_150">y</span><span> </span><span class="symbol" id="span_7_151">+</span><span> </span><span id="span_7_153">prev</span><span class="symbol" id="span_7_155">.</span><span id="span_7_156">sigma</span><span> </span><span class="symbol" id="span_7_157">*</span><span> </span><span class="symbol" id="span_7_160">(</span><span class="literal" id="span_7_161">0.5</span><span> </span><span class="symbol" id="span_7_162">-</span><span> </span><span id="span_7_164">t&#39;</span><span class="symbol" id="span_7_165">)</span><span> </span><span class="symbol" id="span_7_166">.*</span><span> </span><span id="span_7_168">sampler</span><span> </span><span id="span_7_170">key_draw</span><span class="comment">

      # zoom in left or right
      </span><span id="span_7_172">new_key</span><span> </span><span class="symbol" id="span_7_173">=</span><span> </span><span class="keyword" id="span_7_175">if</span><span> </span><span id="span_7_176">prev</span><span class="symbol" id="span_7_178">.</span><span id="span_7_179">t</span><span> </span><span class="symbol" id="span_7_180">&gt;</span><span> </span><span class="literal" id="span_7_182">0.5</span><span class="comment">
        </span><span class="keyword" id="span_7_183">then</span><span> </span><span id="span_7_184">key_left</span><span class="comment">
        </span><span class="keyword" id="span_7_185">else</span><span> </span><span id="span_7_186">key_right</span><span class="comment">
      </span><span id="span_7_188">new_sigma</span><span> </span><span class="symbol" id="span_7_189">=</span><span> </span><span id="span_7_190">prev</span><span class="symbol" id="span_7_192">.</span><span id="span_7_193">sigma</span><span> </span><span class="symbol" id="span_7_194">/</span><span> </span><span id="span_7_196">sqrt</span><span> </span><span class="literal" id="span_7_198">2.0</span><span class="comment">
      </span><span id="span_7_200">new_t</span><span> </span><span class="symbol" id="span_7_201">=</span><span> </span><span id="span_7_202">t&#39;</span><span> </span><span class="symbol" id="span_7_203">*</span><span> </span><span class="literal" id="span_7_205">2.0</span><span class="comment">
      </span><span id="span_7_207">SamplerState</span><span class="symbol" id="span_7_210">(</span><span id="span_7_211">new_key</span><span class="symbol" id="span_7_212">,</span><span> </span><span id="span_7_213">new_y</span><span class="symbol" id="span_7_214">,</span><span> </span><span id="span_7_215">new_sigma</span><span class="symbol" id="span_7_216">,</span><span> </span><span id="span_7_217">new_t</span><span class="symbol" id="span_7_218">)</span><span class="comment">
  </span><span id="span_7_220">result</span><span class="symbol" id="span_7_222">.</span><span id="span_7_223">y</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">

</span></div>
<div class="prose-block"><h3>One-dimensional Brownian motion anywhere on the real line</h3>
<p>These functions generalize the sampling of a Brownian bridge on the unit
interval to sample from a Brownian motion defined anywhere on the real line.
When evaluating at times larger than 1, an iterative doubling procedure
eventually produces values bracketing the desired time.
These bracketing values are then used to call the iterative
Brownian bridge sampler.</p>
</div>
<div class="code-block"><span class="keyword" id="span_10_225">def</span><span> </span><span id="span_10_226">scale_brownian_bridge</span><span class="symbol" id="span_10_228">(</span><span id="span_10_229">unit_bb</span><span class="symbol" id="span_10_230">:</span><span class="symbol" id="span_10_233">(</span><span id="span_10_234">Float</span><span class="symbol" id="span_10_235">)</span><span class="symbol" id="span_10_236">-&gt;</span><span id="span_10_238">v</span><span class="symbol" id="span_10_239">,</span><span> </span><span id="span_10_240">x0</span><span class="symbol" id="span_10_241">:</span><span id="span_10_243">Float</span><span class="symbol" id="span_10_244">,</span><span> </span><span id="span_10_245">x1</span><span class="symbol" id="span_10_246">:</span><span id="span_10_248">Float</span><span class="symbol" id="span_10_249">,</span><span> </span><span id="span_10_250">x</span><span class="symbol" id="span_10_251">:</span><span id="span_10_253">Float</span><span class="symbol" id="span_10_254">)</span><span> </span><span class="symbol" id="span_10_255">-&gt;</span><span> </span><span id="span_10_256">v</span><span> </span><span class="keyword" id="span_10_257">given</span><span> </span><span class="symbol" id="span_10_259">(</span><span id="span_10_260">v</span><span class="symbol" id="span_10_261">|</span><span id="span_10_263">VSpace</span><span class="symbol" id="span_10_264">)</span><span> </span><span class="symbol" id="span_10_265">=</span><span class="comment">
  </span><span id="span_10_268">sqrt</span><span> </span><span class="symbol" id="span_10_271">(</span><span id="span_10_272">x1</span><span> </span><span class="symbol" id="span_10_273">-</span><span> </span><span id="span_10_275">x0</span><span class="symbol" id="span_10_276">)</span><span> </span><span class="symbol" id="span_10_277">.*</span><span> </span><span id="span_10_279">unit_bb</span><span> </span><span class="symbol" id="span_10_282">(</span><span class="symbol" id="span_10_284">(</span><span id="span_10_285">x</span><span> </span><span class="symbol" id="span_10_286">-</span><span> </span><span id="span_10_288">x0</span><span class="symbol" id="span_10_289">)</span><span> </span><span class="symbol" id="span_10_290">/</span><span> </span><span class="symbol" id="span_10_293">(</span><span id="span_10_294">x1</span><span> </span><span class="symbol" id="span_10_295">-</span><span> </span><span id="span_10_297">x0</span><span class="symbol" id="span_10_298">)</span><span class="symbol" id="span_10_299">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_12_301">def</span><span> </span><span id="span_12_302">linear_interp</span><span class="symbol" id="span_12_304">(</span><span id="span_12_305">t0</span><span class="symbol" id="span_12_306">:</span><span id="span_12_308">Float</span><span class="symbol" id="span_12_309">,</span><span> </span><span id="span_12_310">x0</span><span class="symbol" id="span_12_311">:</span><span id="span_12_313">v</span><span class="symbol" id="span_12_314">,</span><span> </span><span id="span_12_315">t1</span><span class="symbol" id="span_12_316">:</span><span id="span_12_318">Float</span><span class="symbol" id="span_12_319">,</span><span> </span><span id="span_12_320">x1</span><span class="symbol" id="span_12_321">:</span><span id="span_12_323">v</span><span class="symbol" id="span_12_324">,</span><span> </span><span id="span_12_325">t</span><span class="symbol" id="span_12_326">:</span><span id="span_12_328">Float</span><span class="symbol" id="span_12_329">)</span><span> </span><span class="symbol" id="span_12_330">-&gt;</span><span> </span><span id="span_12_331">v</span><span> </span><span class="keyword" id="span_12_332">given</span><span> </span><span class="symbol" id="span_12_334">(</span><span id="span_12_335">v</span><span class="symbol" id="span_12_336">|</span><span id="span_12_338">VSpace</span><span class="symbol" id="span_12_339">)</span><span> </span><span class="symbol" id="span_12_340">=</span><span class="comment">
  </span><span id="span_12_343">unit_t</span><span> </span><span class="symbol" id="span_12_344">=</span><span> </span><span class="symbol" id="span_12_346">(</span><span id="span_12_347">t</span><span> </span><span class="symbol" id="span_12_348">-</span><span> </span><span id="span_12_350">t0</span><span class="symbol" id="span_12_351">)</span><span> </span><span class="symbol" id="span_12_352">/</span><span> </span><span class="symbol" id="span_12_355">(</span><span id="span_12_356">t1</span><span> </span><span class="symbol" id="span_12_357">-</span><span> </span><span id="span_12_359">t0</span><span class="symbol" id="span_12_360">)</span><span class="comment">
  </span><span class="symbol" id="span_12_363">(</span><span class="literal" id="span_12_364">1.0</span><span> </span><span class="symbol" id="span_12_365">-</span><span> </span><span id="span_12_367">unit_t</span><span class="symbol" id="span_12_368">)</span><span> </span><span class="symbol" id="span_12_369">.*</span><span> </span><span id="span_12_371">x0</span><span> </span><span class="symbol" id="span_12_372">+</span><span> </span><span id="span_12_374">unit_t</span><span> </span><span class="symbol" id="span_12_375">.*</span><span> </span><span id="span_12_377">x1</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_14_379">def</span><span> </span><span id="span_14_380">sample_brownian_bridge</span><span class="symbol" id="span_14_382">(</span><span class="comment">
    </span><span id="span_14_383">tolerance</span><span class="symbol" id="span_14_384">:</span><span id="span_14_386">Float</span><span class="symbol" id="span_14_387">,</span><span> </span><span id="span_14_388">sampler</span><span class="symbol" id="span_14_389">:</span><span> </span><span class="symbol" id="span_14_392">(</span><span id="span_14_393">Key</span><span class="symbol" id="span_14_394">)</span><span class="symbol" id="span_14_395">-&gt;</span><span id="span_14_397">v</span><span class="symbol" id="span_14_398">,</span><span class="comment">
    </span><span id="span_14_399">key</span><span class="symbol" id="span_14_400">:</span><span id="span_14_402">Key</span><span class="symbol" id="span_14_403">,</span><span>         </span><span id="span_14_404">t0</span><span class="symbol" id="span_14_405">:</span><span id="span_14_407">Float</span><span class="symbol" id="span_14_408">,</span><span class="comment">
    </span><span id="span_14_409">y0</span><span class="symbol" id="span_14_410">:</span><span id="span_14_412">v</span><span class="symbol" id="span_14_413">,</span><span>            </span><span id="span_14_414">t1</span><span class="symbol" id="span_14_415">:</span><span id="span_14_417">Float</span><span class="symbol" id="span_14_418">,</span><span class="comment">
    </span><span id="span_14_419">y1</span><span class="symbol" id="span_14_420">:</span><span id="span_14_422">v</span><span class="symbol" id="span_14_423">,</span><span>            </span><span id="span_14_424">t</span><span class="symbol" id="span_14_425">:</span><span id="span_14_427">Float</span><span class="comment">
    </span><span class="symbol" id="span_14_428">)</span><span> </span><span class="symbol" id="span_14_429">-&gt;</span><span> </span><span id="span_14_430">v</span><span> </span><span class="keyword" id="span_14_431">given</span><span> </span><span class="symbol" id="span_14_433">(</span><span id="span_14_434">v</span><span class="symbol" id="span_14_435">|</span><span id="span_14_437">VSpace</span><span class="symbol" id="span_14_438">)</span><span> </span><span class="symbol" id="span_14_439">=</span><span class="comment">
  # Linearly interpolate between the two bracketing samples
  # and add appropriately scaled Brownian bridge noise.
  </span><span id="span_14_442">unit_bb</span><span> </span><span class="symbol" id="span_14_443">=</span><span> </span><span class="symbol" id="span_14_445">\</span><span id="span_14_446">t</span><span class="symbol" id="span_14_447">.</span><span> </span><span id="span_14_448">sample_unit_brownian_bridge</span><span> </span><span class="symbol" id="span_14_451">(</span><span id="span_14_452">tolerance</span><span> </span><span class="symbol" id="span_14_453">/</span><span> </span><span class="symbol" id="span_14_456">(</span><span id="span_14_457">t1</span><span> </span><span class="symbol" id="span_14_458">-</span><span> </span><span id="span_14_460">t0</span><span class="symbol" id="span_14_461">)</span><span class="symbol" id="span_14_462">)</span><span> </span><span id="span_14_464">sampler</span><span> </span><span id="span_14_466">key</span><span> </span><span id="span_14_468">t</span><span class="comment">
  </span><span id="span_14_470">bridge_val</span><span> </span><span class="symbol" id="span_14_471">=</span><span> </span><span id="span_14_472">scale_brownian_bridge</span><span> </span><span id="span_14_474">unit_bb</span><span> </span><span id="span_14_476">t0</span><span> </span><span id="span_14_478">t1</span><span> </span><span id="span_14_480">t</span><span class="comment">
  </span><span id="span_14_482">interp_val</span><span> </span><span class="symbol" id="span_14_483">=</span><span> </span><span id="span_14_484">linear_interp</span><span> </span><span id="span_14_486">t0</span><span> </span><span id="span_14_488">y0</span><span> </span><span id="span_14_490">t1</span><span> </span><span id="span_14_492">y1</span><span> </span><span id="span_14_494">t</span><span class="comment">
  </span><span id="span_14_496">bridge_val</span><span> </span><span class="symbol" id="span_14_497">+</span><span> </span><span id="span_14_499">interp_val</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_16_501">def</span><span> </span><span id="span_16_502">sample_brownian_motion</span><span class="symbol" id="span_16_504">(</span><span class="comment">
    </span><span id="span_16_505">tolerance</span><span class="symbol" id="span_16_506">:</span><span id="span_16_508">Float</span><span class="symbol" id="span_16_509">,</span><span class="comment">
    </span><span id="span_16_510">sampler</span><span class="symbol" id="span_16_511">:</span><span> </span><span class="symbol" id="span_16_514">(</span><span id="span_16_515">Key</span><span class="symbol" id="span_16_516">)</span><span class="symbol" id="span_16_517">-&gt;</span><span id="span_16_519">v</span><span class="symbol" id="span_16_520">,</span><span class="comment">
    </span><span id="span_16_521">key</span><span class="symbol" id="span_16_522">:</span><span id="span_16_524">Key</span><span class="symbol" id="span_16_525">,</span><span class="comment">
    </span><span id="span_16_526">t&#39;</span><span class="symbol" id="span_16_527">:</span><span id="span_16_529">Float</span><span class="comment">
    </span><span class="symbol" id="span_16_530">)</span><span> </span><span class="symbol" id="span_16_531">-&gt;</span><span> </span><span id="span_16_532">v</span><span>   </span><span class="keyword" id="span_16_533">given</span><span> </span><span class="symbol" id="span_16_535">(</span><span id="span_16_536">v</span><span class="symbol" id="span_16_537">|</span><span id="span_16_539">VSpace</span><span class="symbol" id="span_16_540">)</span><span> </span><span class="symbol" id="span_16_541">=</span><span class="comment">
  # Can handle a t&#39; anywhere on the real line.
  # Handle negative times by reflecting and using a different key.
  </span><span class="symbol" id="span_16_545">[</span><span id="span_16_546">neg_key&#39;</span><span class="symbol" id="span_16_547">,</span><span> </span><span id="span_16_548">key&#39;</span><span class="symbol" id="span_16_549">]</span><span> </span><span class="symbol" id="span_16_550">=</span><span> </span><span id="span_16_551">split_key</span><span> </span><span id="span_16_553">key</span><span class="comment">
  </span><span class="symbol" id="span_16_556">(</span><span id="span_16_557">key</span><span class="symbol" id="span_16_558">,</span><span> </span><span id="span_16_559">t</span><span class="symbol" id="span_16_560">)</span><span> </span><span class="symbol" id="span_16_561">=</span><span> </span><span class="keyword" id="span_16_563">if</span><span> </span><span id="span_16_564">t&#39;</span><span> </span><span class="symbol" id="span_16_565">&lt;</span><span> </span><span class="literal" id="span_16_567">0.0</span><span class="comment">
    </span><span class="keyword" id="span_16_568">then</span><span> </span><span class="symbol" id="span_16_570">(</span><span id="span_16_571">neg_key&#39;</span><span class="symbol" id="span_16_572">,</span><span> </span><span class="symbol" id="span_16_573">-</span><span id="span_16_575">t&#39;</span><span class="symbol" id="span_16_576">)</span><span class="comment">
    </span><span class="keyword" id="span_16_577">else</span><span> </span><span class="symbol" id="span_16_579">(</span><span id="span_16_580">key&#39;</span><span class="symbol" id="span_16_581">,</span><span>      </span><span id="span_16_582">t&#39;</span><span class="symbol" id="span_16_583">)</span><span class="comment">

  </span><span class="symbol" id="span_16_586">[</span><span id="span_16_587">key_start</span><span class="symbol" id="span_16_588">,</span><span> </span><span id="span_16_589">key_rest</span><span class="symbol" id="span_16_590">]</span><span> </span><span class="symbol" id="span_16_591">=</span><span> </span><span id="span_16_592">split_key</span><span> </span><span id="span_16_594">key</span><span class="comment">
  </span><span id="span_16_596">first_f</span><span> </span><span class="symbol" id="span_16_597">=</span><span> </span><span id="span_16_598">sampler</span><span> </span><span id="span_16_600">key_start</span><span class="comment">

  # Iteratively sample a point twice as far ahead
  # until we bracket the query time.
  </span><span id="span_16_602">doublings</span><span> </span><span class="symbol" id="span_16_603">=</span><span> </span><span id="span_16_604">Fin</span><span> </span><span class="symbol" id="span_16_607">(</span><span class="literal" id="span_16_608">1</span><span> </span><span class="symbol" id="span_16_609">+</span><span> </span><span class="symbol" id="span_16_612">(</span><span id="span_16_613">natlog2</span><span> </span><span class="symbol" id="span_16_616">(</span><span id="span_16_617">f_to_n</span><span> </span><span id="span_16_619">t</span><span class="symbol" id="span_16_620">)</span><span class="symbol" id="span_16_621">)</span><span class="symbol" id="span_16_622">)</span><span class="comment">
  </span><span id="span_16_624">init_state</span><span> </span><span class="symbol" id="span_16_625">=</span><span> </span><span class="symbol" id="span_16_627">(</span><span class="literal" id="span_16_628">0.0</span><span class="symbol" id="span_16_629">,</span><span> </span><span id="span_16_630">zero</span><span class="symbol" id="span_16_631">,</span><span> </span><span class="literal" id="span_16_632">1.0</span><span class="symbol" id="span_16_633">,</span><span> </span><span id="span_16_634">first_f</span><span class="symbol" id="span_16_635">,</span><span> </span><span id="span_16_636">key_rest</span><span class="symbol" id="span_16_637">)</span><span class="comment">
  </span><span class="symbol" id="span_16_640">(</span><span id="span_16_641">t0</span><span class="symbol" id="span_16_642">,</span><span> </span><span id="span_16_643">left_f</span><span class="symbol" id="span_16_644">,</span><span> </span><span id="span_16_645">t1</span><span class="symbol" id="span_16_646">,</span><span> </span><span id="span_16_647">right_f</span><span class="symbol" id="span_16_648">,</span><span> </span><span id="span_16_649">key_draw</span><span class="symbol" id="span_16_650">)</span><span> </span><span class="symbol" id="span_16_651">=</span><span class="comment">
    </span><span id="span_16_654">fold</span><span> </span><span id="span_16_656">init_state</span><span> </span><span class="symbol" id="span_16_659">\</span><span id="span_16_660">i</span><span class="symbol" id="span_16_661">:</span><span id="span_16_663">doublings</span><span> </span><span id="span_16_664">state</span><span class="symbol" id="span_16_665">.</span><span class="comment">
      </span><span class="symbol" id="span_16_669">(</span><span id="span_16_670">t0</span><span class="symbol" id="span_16_671">,</span><span> </span><span id="span_16_672">left_f</span><span class="symbol" id="span_16_673">,</span><span> </span><span id="span_16_674">t1</span><span class="symbol" id="span_16_675">,</span><span> </span><span id="span_16_676">right_f</span><span class="symbol" id="span_16_677">,</span><span> </span><span id="span_16_678">key_inner</span><span class="symbol" id="span_16_679">)</span><span> </span><span class="symbol" id="span_16_680">=</span><span> </span><span id="span_16_681">state</span><span class="comment">
      </span><span class="symbol" id="span_16_684">[</span><span id="span_16_685">key_current</span><span class="symbol" id="span_16_686">,</span><span> </span><span id="span_16_687">key_continue</span><span class="symbol" id="span_16_688">]</span><span> </span><span class="symbol" id="span_16_689">=</span><span> </span><span id="span_16_690">split_key</span><span> </span><span id="span_16_692">key_rest</span><span class="comment">
      </span><span id="span_16_694">new_right_f</span><span> </span><span class="symbol" id="span_16_695">=</span><span> </span><span id="span_16_696">left_f</span><span> </span><span class="symbol" id="span_16_697">+</span><span> </span><span class="symbol" id="span_16_700">(</span><span id="span_16_701">sqrt</span><span> </span><span id="span_16_703">t1</span><span class="symbol" id="span_16_704">)</span><span> </span><span class="symbol" id="span_16_705">.*</span><span> </span><span id="span_16_707">sampler</span><span> </span><span id="span_16_709">key_current</span><span class="comment">
      </span><span class="symbol" id="span_16_712">(</span><span id="span_16_713">t1</span><span class="symbol" id="span_16_714">,</span><span> </span><span id="span_16_715">right_f</span><span class="symbol" id="span_16_716">,</span><span> </span><span id="span_16_717">t1</span><span> </span><span class="symbol" id="span_16_718">*</span><span> </span><span class="literal" id="span_16_720">2.0</span><span class="symbol" id="span_16_721">,</span><span> </span><span id="span_16_722">new_right_f</span><span class="symbol" id="span_16_723">,</span><span> </span><span id="span_16_724">key_continue</span><span class="symbol" id="span_16_725">)</span><span class="comment">
  # The above iterative loop could be mostly parallelized, but would
  # require some care to get the random keys right.

  </span><span id="span_16_727">sample_brownian_bridge</span><span> </span><span id="span_16_729">tolerance</span><span> </span><span id="span_16_731">sampler</span><span> </span><span id="span_16_733">key_draw</span><span> </span><span id="span_16_735">t0</span><span> </span><span id="span_16_737">left_f</span><span> </span><span id="span_16_739">t1</span><span> </span><span id="span_16_741">right_f</span><span> </span><span id="span_16_743">t</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">

</span></div>
<div class="prose-block"><h2>Demo: One-dimensional Brownian motion</h2>
</div>
<div class="code-block"><span class="keyword" id="span_19_744">import</span><span> </span><span id="span_19_745">plot</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_21_747">pixels</span><span> </span><span class="symbol" id="span_21_748">=</span><span> </span><span id="span_21_749">Fin</span><span> </span><span class="literal" id="span_21_751">400</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_22_753">xs</span><span> </span><span class="symbol" id="span_22_754">=</span><span> </span><span id="span_22_755">linspace</span><span> </span><span id="span_22_757">pixels</span><span> </span><span class="literal" id="span_22_759">0.3</span><span> </span><span class="literal" id="span_22_761">2.1</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_23_763">tolerance</span><span> </span><span class="symbol" id="span_23_764">=</span><span> </span><span id="span_23_765">xs</span><span class="symbol" id="span_23_768">[</span><span class="literal" id="span_23_769">1</span><span class="symbol" id="span_23_770">@</span><span class="symbol" id="span_23_773">_</span><span class="symbol" id="span_23_774">]</span><span> </span><span class="symbol" id="span_23_775">-</span><span> </span><span id="span_23_777">xs</span><span class="symbol" id="span_23_780">[</span><span class="literal" id="span_23_781">0</span><span class="symbol" id="span_23_782">@</span><span class="symbol" id="span_23_785">_</span><span class="symbol" id="span_23_786">]</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_24_788">fs</span><span> </span><span class="symbol" id="span_24_789">=</span><span> </span><span id="span_24_790">each</span><span> </span><span id="span_24_792">xs</span><span> </span><span class="symbol" id="span_24_795">\</span><span id="span_24_796">x</span><span class="symbol" id="span_24_797">.</span><span> </span><span id="span_24_798">sample_brownian_motion</span><span> </span><span id="span_24_800">tolerance</span><span> </span><span id="span_24_802">randn</span><span> </span><span class="symbol" id="span_24_805">(</span><span id="span_24_806">new_key</span><span> </span><span class="literal" id="span_24_808">0</span><span class="symbol" id="span_24_809">)</span><span> </span><span id="span_24_811">x</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">:</span><span id="span_25_812">html</span><span> </span><span id="span_25_813">show_plot</span><span> </span><span class="symbol" id="span_25_814">$</span><span> </span><span id="span_25_816">xy_plot</span><span> </span><span id="span_25_818">xs</span><span> </span><span id="span_25_820">fs</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="prose-block"><h4>Check that the finite differences look like white noise</h4>
</div>
<div class="code-block"><span id="span_28_822">fdiffs</span><span> </span><span class="symbol" id="span_28_823">=</span><span> </span><span class="keyword" id="span_28_825">for</span><span> </span><span id="span_28_826">i</span><span class="symbol" id="span_28_827">.</span><span class="comment">
  </span><span class="symbol" id="span_28_831">(</span><span id="span_28_832">fs</span><span class="symbol" id="span_28_835">[</span><span class="symbol" id="span_28_837">(</span><span class="symbol" id="span_28_839">(</span><span id="span_28_840">ordinal</span><span> </span><span id="span_28_842">i</span><span class="symbol" id="span_28_843">)</span><span> </span><span class="symbol" id="span_28_844">-|</span><span> </span><span class="literal" id="span_28_846">1</span><span class="symbol" id="span_28_847">)</span><span class="symbol" id="span_28_848">@</span><span class="symbol" id="span_28_851">_</span><span class="symbol" id="span_28_852">]</span><span> </span><span class="symbol" id="span_28_853">-</span><span> </span><span id="span_28_855">fs</span><span class="symbol" id="span_28_858">[</span><span id="span_28_859">i</span><span class="symbol" id="span_28_860">]</span><span class="symbol" id="span_28_861">)</span><span> </span><span class="symbol" id="span_28_862">/</span><span> </span><span id="span_28_864">sqrt</span><span> </span><span id="span_28_866">tolerance</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">:</span><span id="span_29_867">html</span><span> </span><span id="span_29_868">show_plot</span><span> </span><span class="symbol" id="span_29_869">$</span><span> </span><span id="span_29_871">xy_plot</span><span> </span><span id="span_29_873">xs</span><span> </span><span id="span_29_875">fdiffs</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="prose-block"><h3>Generalize the output type to any dimension</h3>
<p>This typeclass lets the output type of the Brownian sheet
be anything for which a Gaussian sampler can be written.</p>
</div>
<div class="code-block"><span class="keyword" id="span_32_877">interface</span><span> </span><span id="span_32_878">HasStandardNormal</span><span class="symbol" id="span_32_880">(</span><span id="span_32_881">a</span><span class="symbol" id="span_32_882">:</span><span id="span_32_884">Type</span><span class="symbol" id="span_32_885">)</span><span class="comment">
  </span><span id="span_32_886">rand_normal</span><span> </span><span class="symbol" id="span_32_887">:</span><span> </span><span class="symbol" id="span_32_889">(</span><span id="span_32_890">Key</span><span class="symbol" id="span_32_891">)</span><span> </span><span class="symbol" id="span_32_892">-&gt;</span><span> </span><span id="span_32_894">a</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_34_896">instance</span><span> </span><span id="span_34_897">HasStandardNormal</span><span class="symbol" id="span_34_899">(</span><span id="span_34_900">Float32</span><span class="symbol" id="span_34_901">)</span><span class="comment">
  </span><span class="keyword" id="span_34_903">def</span><span> </span><span id="span_34_904">rand_normal</span><span class="symbol" id="span_34_906">(</span><span id="span_34_907">k</span><span class="symbol" id="span_34_908">)</span><span> </span><span class="symbol" id="span_34_909">=</span><span> </span><span id="span_34_910">randn</span><span> </span><span id="span_34_912">k</span><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_35_914">instance</span><span> </span><span id="span_35_915">HasStandardNormal</span><span class="symbol" id="span_35_917">(</span><span id="span_35_918">n</span><span class="symbol" id="span_35_919">=&gt;</span><span id="span_35_921">a</span><span class="symbol" id="span_35_922">)</span><span> </span><span class="keyword" id="span_35_923">given</span><span> </span><span class="symbol" id="span_35_925">(</span><span id="span_35_926">a</span><span class="symbol" id="span_35_927">|</span><span id="span_35_929">HasStandardNormal</span><span class="symbol" id="span_35_930">,</span><span> </span><span id="span_35_931">n</span><span class="symbol" id="span_35_932">|</span><span id="span_35_934">Ix</span><span class="symbol" id="span_35_935">)</span><span class="comment">
  </span><span class="keyword" id="span_35_937">def</span><span> </span><span id="span_35_938">rand_normal</span><span class="symbol" id="span_35_940">(</span><span id="span_35_941">k</span><span class="symbol" id="span_35_942">)</span><span> </span><span class="symbol" id="span_35_943">=</span><span> </span><span class="keyword" id="span_35_945">for</span><span> </span><span id="span_35_946">i</span><span class="symbol" id="span_35_947">.</span><span> </span><span id="span_35_948">rand_normal</span><span> </span><span class="symbol" id="span_35_951">(</span><span id="span_35_952">ixkey</span><span> </span><span id="span_35_954">k</span><span> </span><span id="span_35_956">i</span><span class="symbol" id="span_35_957">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">

</span></div>
<div class="prose-block"><h3>Generalize the input type to any dimension</h3>
<p>Suprisinly, a sampler for 1D Brownian motion can easily be extended
to sample from a Brownian sheet of any dimension.
We simply have to replace the sampler used for scalar-valued
standard Gaussian noise with one that samples entire functions
from a Gaussian process.  In particular, we can re-use the
1D Brownian bridge sampler that we wrote above.
This process can be nested to arbitrarily many dimensions.</p>
</div>
<div class="code-block"><span class="keyword" id="span_38_959">interface</span><span> </span><span id="span_38_960">HasBrownianSheet</span><span class="symbol" id="span_38_962">(</span><span id="span_38_963">a</span><span class="symbol" id="span_38_964">:</span><span id="span_38_966">Type</span><span class="symbol" id="span_38_967">,</span><span> </span><span id="span_38_968">v</span><span class="symbol" id="span_38_969">|</span><span id="span_38_971">HasStandardNormal</span><span class="symbol" id="span_38_972">)</span><span class="comment">
                      # tolerance -&gt; key -&gt; input -&gt; output
  </span><span id="span_38_973">sample_brownian_sheet</span><span> </span><span class="symbol" id="span_38_974">:</span><span> </span><span class="symbol" id="span_38_976">(</span><span id="span_38_977">Float</span><span class="symbol" id="span_38_978">,</span><span> </span><span id="span_38_979">Key</span><span class="symbol" id="span_38_980">,</span><span> </span><span id="span_38_981">a</span><span class="symbol" id="span_38_982">)</span><span> </span><span class="symbol" id="span_38_983">-&gt;</span><span> </span><span id="span_38_985">v</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_40_987">instance</span><span> </span><span id="span_40_988">HasBrownianSheet</span><span class="symbol" id="span_40_990">(</span><span id="span_40_991">Float</span><span class="symbol" id="span_40_992">,</span><span> </span><span id="span_40_993">v</span><span class="symbol" id="span_40_994">)</span><span> </span><span class="keyword" id="span_40_995">given</span><span> </span><span class="symbol" id="span_40_997">(</span><span id="span_40_998">v</span><span class="symbol" id="span_40_999">|</span><span id="span_40_1001">HasStandardNormal</span><span class="symbol" id="span_40_1002">|</span><span id="span_40_1004">VSpace</span><span class="symbol" id="span_40_1005">)</span><span class="comment">
  </span><span class="keyword" id="span_40_1007">def</span><span> </span><span id="span_40_1008">sample_brownian_sheet</span><span class="symbol" id="span_40_1010">(</span><span id="span_40_1011">tol</span><span class="symbol" id="span_40_1012">,</span><span> </span><span id="span_40_1013">k</span><span class="symbol" id="span_40_1014">,</span><span> </span><span id="span_40_1015">x</span><span class="symbol" id="span_40_1016">)</span><span> </span><span class="symbol" id="span_40_1017">=</span><span class="comment">
    </span><span id="span_40_1020">sample_brownian_motion</span><span> </span><span id="span_40_1022">tol</span><span> </span><span id="span_40_1024">rand_normal</span><span> </span><span id="span_40_1026">k</span><span> </span><span id="span_40_1028">x</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_42_1030">instance</span><span> </span><span id="span_42_1031">HasBrownianSheet</span><span class="symbol" id="span_42_1033">(</span><span class="symbol" id="span_42_1035">(</span><span id="span_42_1036">a</span><span class="symbol" id="span_42_1037">,</span><span> </span><span id="span_42_1038">Float</span><span class="symbol" id="span_42_1039">)</span><span class="symbol" id="span_42_1040">,</span><span> </span><span id="span_42_1041">v</span><span class="symbol" id="span_42_1042">)</span><span> </span><span class="keyword" id="span_42_1043">given</span><span> </span><span class="symbol" id="span_42_1045">(</span><span id="span_42_1046">a</span><span class="symbol" id="span_42_1047">,</span><span> </span><span id="span_42_1048">v</span><span class="symbol" id="span_42_1049">|</span><span id="span_42_1051">VSpace</span><span class="symbol" id="span_42_1052">)</span><span> </span><span class="symbol" id="span_42_1054">(</span><span id="span_42_1055">HasBrownianSheet</span><span> </span><span id="span_42_1057">a</span><span> </span><span id="span_42_1059">v</span><span class="symbol" id="span_42_1060">)</span><span class="comment">
  </span><span class="keyword" id="span_42_1062">def</span><span> </span><span id="span_42_1063">sample_brownian_sheet</span><span class="symbol" id="span_42_1065">(</span><span id="span_42_1066">tol</span><span class="symbol" id="span_42_1067">,</span><span> </span><span id="span_42_1068">k</span><span class="symbol" id="span_42_1069">,</span><span> </span><span id="span_42_1070">xab</span><span class="symbol" id="span_42_1071">)</span><span> </span><span class="symbol" id="span_42_1072">=</span><span class="comment">
    # the call to `sample_brownian_sheet` below will recurse
    # until the input is one-dimensional.
    </span><span class="symbol" id="span_42_1076">(</span><span id="span_42_1077">xa</span><span class="symbol" id="span_42_1078">,</span><span> </span><span id="span_42_1079">xb</span><span class="symbol" id="span_42_1080">)</span><span> </span><span class="symbol" id="span_42_1081">=</span><span> </span><span id="span_42_1082">xab</span><span class="comment">
    </span><span id="span_42_1084">sample_a</span><span> </span><span class="symbol" id="span_42_1085">=</span><span> </span><span class="symbol" id="span_42_1087">\</span><span id="span_42_1088">k</span><span class="symbol" id="span_42_1089">.</span><span> </span><span id="span_42_1090">sample_brownian_sheet</span><span> </span><span id="span_42_1092">tol</span><span> </span><span id="span_42_1094">k</span><span> </span><span id="span_42_1096">xa</span><span class="comment">
    </span><span id="span_42_1098">sample_brownian_motion</span><span> </span><span id="span_42_1100">tol</span><span> </span><span id="span_42_1102">sample_a</span><span> </span><span id="span_42_1104">k</span><span> </span><span id="span_42_1106">xb</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">

</span></div>
<div class="prose-block"><h2>Demo: Two-dimensional Brownian sheet</h2>
<p>Next, we plot a single sample from a two-dimensional Brownian
sheet with a 3-dimensional (red, green, blue) output.</p>
</div>
<div class="code-block"><span class="keyword" id="span_45_1107">import</span><span> </span><span id="span_45_1108">png</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_47_1110">samp</span><span> </span><span class="symbol" id="span_47_1111">:</span><span> </span><span id="span_47_1113">pixels</span><span class="symbol" id="span_47_1114">=&gt;</span><span id="span_47_1116">pixels</span><span class="symbol" id="span_47_1117">=&gt;</span><span class="symbol" id="span_47_1120">(</span><span id="span_47_1121">Fin</span><span> </span><span class="literal" id="span_47_1123">3</span><span class="symbol" id="span_47_1124">)</span><span class="symbol" id="span_47_1125">=&gt;</span><span id="span_47_1127">Float</span><span> </span><span class="symbol" id="span_47_1128">=</span><span> </span><span class="keyword" id="span_47_1130">for</span><span> </span><span id="span_47_1131">i</span><span> </span><span id="span_47_1132">j</span><span class="symbol" id="span_47_1133">.</span><span class="comment">
  </span><span id="span_47_1136">sample_brownian_sheet</span><span> </span><span id="span_47_1138">tolerance</span><span> </span><span class="symbol" id="span_47_1141">(</span><span id="span_47_1142">new_key</span><span> </span><span class="literal" id="span_47_1144">0</span><span class="symbol" id="span_47_1145">)</span><span> </span><span class="symbol" id="span_47_1148">(</span><span id="span_47_1149">xs</span><span class="symbol" id="span_47_1152">[</span><span id="span_47_1153">i</span><span class="symbol" id="span_47_1154">]</span><span class="symbol" id="span_47_1155">,</span><span> </span><span id="span_47_1156">xs</span><span class="symbol" id="span_47_1159">[</span><span id="span_47_1160">j</span><span class="symbol" id="span_47_1161">]</span><span class="symbol" id="span_47_1162">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment">:</span><span id="span_49_1163">html</span><span> </span><span id="span_49_1164">imshow</span><span> </span><span id="span_49_1166">samp</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
</body></html>