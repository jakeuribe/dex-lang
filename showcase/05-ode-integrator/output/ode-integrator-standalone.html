<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
body{font-family:"SF Mono","Fira Code",monospace;max-width:960px;margin:0 auto;padding:20px;background:#0d1117;color:#c9d1d9}
.code-block{background:#161b22;padding:12px;margin:6px 0;border-radius:6px;overflow-x:auto;font-size:14px}
.prose-block{padding:8px 0} .prose-block h1{color:#58a6ff;border-bottom:1px solid #30363d;padding-bottom:8px}
.prose-block h2{color:#58a6ff}
.result{background:#1c2128;padding:10px;margin:2px 0;border-left:3px solid #3fb950;border-radius:0 4px 4px 0;font-size:13px}
.error{background:#1c0000;padding:10px;margin:2px 0;border-left:3px solid #f85149;border-radius:0 4px 4px 0}
img.plot-img{max-width:100%;height:auto;display:block;margin:12px auto;border-radius:4px;border:1px solid #30363d}
svg{max-width:100%;height:auto;display:block;margin:12px auto}
pre{margin:0;white-space:pre-wrap}
span{white-space:pre-wrap}
</style></head><body>
<h1 style="color:#58a6ff;text-align:center">05-ode-integrator</h1><hr style="border-color:#30363d">
<div class="code-block"><span class="comment"></span></div>
<div class="prose-block"><h1>ODE Integrator</h1>
</div>
<div class="prose-block"><p>Integrate systems of ordinary differential equations (ODEs) using the Dormand-Prince method for adaptive integration
stepsize calculation.
This version is a port of the <a href="https://github.com/google/jax/blob/4236eb2b5929b9643977553f7f988ca518b7df4e/jax/experimental/ode.py">Jax implementation</a>.
One difference is that it uses a lower-triangular
matrix type for the Butcher tableau, and so avoids zero-padding everywhere.</p>
</div>
<div class="code-block"><span class="keyword" id="span_3_1">import</span><span> </span><span id="span_3_2">plot</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_5_4">Time</span><span> </span><span class="symbol" id="span_5_5">=</span><span> </span><span id="span_5_6">Float</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># Should this go in the prelude?
</span></div>
<div class="code-block"><span class="keyword" id="span_8_8">def</span><span> </span><span id="span_8_9">length</span><span class="symbol" id="span_8_11">(</span><span id="span_8_12">x</span><span class="symbol" id="span_8_13">:</span><span> </span><span id="span_8_15">d</span><span class="symbol" id="span_8_16">=&gt;</span><span id="span_8_18">Float</span><span class="symbol" id="span_8_19">)</span><span> </span><span class="symbol" id="span_8_20">-&gt;</span><span> </span><span id="span_8_21">Float</span><span> </span><span class="keyword" id="span_8_22">given</span><span> </span><span class="symbol" id="span_8_24">(</span><span id="span_8_25">d</span><span class="symbol" id="span_8_26">|</span><span id="span_8_28">Ix</span><span class="symbol" id="span_8_29">)</span><span> </span><span class="symbol" id="span_8_30">=</span><span> </span><span id="span_8_31">sqrt</span><span> </span><span class="symbol" id="span_8_32">$</span><span> </span><span id="span_8_34">sum</span><span> </span><span class="keyword" id="span_8_37">for</span><span> </span><span id="span_8_38">i</span><span class="symbol" id="span_8_39">.</span><span> </span><span id="span_8_40">sq</span><span> </span><span id="span_8_42">x</span><span class="symbol" id="span_8_45">[</span><span id="span_8_46">i</span><span class="symbol" id="span_8_47">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_9_49">def</span><span> </span><span class="symbol" id="span_9_50">(./)</span><span class="symbol" id="span_9_52">(</span><span id="span_9_53">x</span><span class="symbol" id="span_9_54">:</span><span> </span><span id="span_9_56">d</span><span class="symbol" id="span_9_57">=&gt;</span><span id="span_9_59">Float</span><span class="symbol" id="span_9_60">,</span><span> </span><span id="span_9_61">y</span><span class="symbol" id="span_9_62">:</span><span> </span><span id="span_9_64">d</span><span class="symbol" id="span_9_65">=&gt;</span><span id="span_9_67">Float</span><span class="symbol" id="span_9_68">)</span><span> </span><span class="symbol" id="span_9_69">-&gt;</span><span> </span><span id="span_9_70">d</span><span class="symbol" id="span_9_71">=&gt;</span><span id="span_9_73">Float</span><span> </span><span class="keyword" id="span_9_74">given</span><span> </span><span class="symbol" id="span_9_76">(</span><span id="span_9_77">d</span><span class="symbol" id="span_9_78">|</span><span id="span_9_80">Ix</span><span class="symbol" id="span_9_81">)</span><span> </span><span class="symbol" id="span_9_82">=</span><span> </span><span class="keyword" id="span_9_84">for</span><span> </span><span id="span_9_85">i</span><span class="symbol" id="span_9_86">.</span><span> </span><span id="span_9_87">x</span><span class="symbol" id="span_9_90">[</span><span id="span_9_91">i</span><span class="symbol" id="span_9_92">]</span><span> </span><span class="symbol" id="span_9_93">/</span><span> </span><span id="span_9_95">y</span><span class="symbol" id="span_9_98">[</span><span id="span_9_99">i</span><span class="symbol" id="span_9_100">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_11_102">def</span><span> </span><span id="span_11_103">fit_4th_order_polynomial</span><span class="symbol" id="span_11_105">(</span><span id="span_11_106">z0</span><span class="symbol" id="span_11_107">:</span><span id="span_11_109">v</span><span class="symbol" id="span_11_110">,</span><span> </span><span id="span_11_111">z1</span><span class="symbol" id="span_11_112">:</span><span id="span_11_114">v</span><span class="symbol" id="span_11_115">,</span><span> </span><span id="span_11_116">z_mid</span><span class="symbol" id="span_11_117">:</span><span id="span_11_119">v</span><span class="symbol" id="span_11_120">,</span><span> </span><span id="span_11_121">dz0</span><span class="symbol" id="span_11_122">:</span><span id="span_11_124">v</span><span class="symbol" id="span_11_125">,</span><span> </span><span id="span_11_126">dz1</span><span class="symbol" id="span_11_127">:</span><span id="span_11_129">v</span><span class="symbol" id="span_11_130">,</span><span> </span><span id="span_11_131">dt</span><span class="symbol" id="span_11_132">:</span><span id="span_11_134">Time</span><span class="symbol" id="span_11_135">)</span><span class="comment">
    </span><span class="symbol" id="span_11_136">-&gt;</span><span> </span><span class="symbol" id="span_11_138">(</span><span id="span_11_139">Fin</span><span> </span><span class="literal" id="span_11_141">5</span><span class="symbol" id="span_11_142">)</span><span class="symbol" id="span_11_143">=&gt;</span><span id="span_11_145">v</span><span> </span><span class="keyword" id="span_11_146">given</span><span> </span><span class="symbol" id="span_11_148">(</span><span id="span_11_149">v</span><span class="symbol" id="span_11_150">|</span><span id="span_11_152">VSpace</span><span class="symbol" id="span_11_153">)</span><span> </span><span class="symbol" id="span_11_154">=</span><span class="comment">
  # dz0 and dz1 are gradient evaluations.
  </span><span id="span_11_157">a</span><span> </span><span class="symbol" id="span_11_158">=</span><span> </span><span class="symbol" id="span_11_159">-</span><span class="literal" id="span_11_161">2.</span><span> </span><span class="symbol" id="span_11_162">*</span><span> </span><span id="span_11_164">dt</span><span> </span><span class="symbol" id="span_11_165">.*</span><span> </span><span id="span_11_167">dz0</span><span> </span><span class="symbol" id="span_11_168">+</span><span> </span><span class="literal" id="span_11_170">2.</span><span> </span><span class="symbol" id="span_11_171">*</span><span> </span><span id="span_11_173">dt</span><span> </span><span class="symbol" id="span_11_174">.*</span><span> </span><span id="span_11_176">dz1</span><span> </span><span class="symbol" id="span_11_177">-</span><span>  </span><span class="literal" id="span_11_179">8.</span><span> </span><span class="symbol" id="span_11_180">.*</span><span> </span><span id="span_11_182">z0</span><span> </span><span class="symbol" id="span_11_183">-</span><span>  </span><span class="literal" id="span_11_185">8.</span><span> </span><span class="symbol" id="span_11_186">.*</span><span> </span><span id="span_11_188">z1</span><span> </span><span class="symbol" id="span_11_189">+</span><span> </span><span class="literal" id="span_11_191">16.</span><span> </span><span class="symbol" id="span_11_192">.*</span><span> </span><span id="span_11_194">z_mid</span><span class="comment">
  </span><span id="span_11_196">b</span><span> </span><span class="symbol" id="span_11_197">=</span><span>  </span><span class="literal" id="span_11_198">5.</span><span> </span><span class="symbol" id="span_11_199">*</span><span> </span><span id="span_11_201">dt</span><span> </span><span class="symbol" id="span_11_202">.*</span><span> </span><span id="span_11_204">dz0</span><span> </span><span class="symbol" id="span_11_205">-</span><span> </span><span class="literal" id="span_11_207">3.</span><span> </span><span class="symbol" id="span_11_208">*</span><span> </span><span id="span_11_210">dt</span><span> </span><span class="symbol" id="span_11_211">.*</span><span> </span><span id="span_11_213">dz1</span><span> </span><span class="symbol" id="span_11_214">+</span><span> </span><span class="literal" id="span_11_216">18.</span><span> </span><span class="symbol" id="span_11_217">.*</span><span> </span><span id="span_11_219">z0</span><span> </span><span class="symbol" id="span_11_220">+</span><span> </span><span class="literal" id="span_11_222">14.</span><span> </span><span class="symbol" id="span_11_223">.*</span><span> </span><span id="span_11_225">z1</span><span> </span><span class="symbol" id="span_11_226">-</span><span> </span><span class="literal" id="span_11_228">32.</span><span> </span><span class="symbol" id="span_11_229">.*</span><span> </span><span id="span_11_231">z_mid</span><span class="comment">
  </span><span id="span_11_233">c</span><span> </span><span class="symbol" id="span_11_234">=</span><span> </span><span class="symbol" id="span_11_235">-</span><span class="literal" id="span_11_237">4.</span><span> </span><span class="symbol" id="span_11_238">*</span><span> </span><span id="span_11_240">dt</span><span> </span><span class="symbol" id="span_11_241">.*</span><span> </span><span id="span_11_243">dz0</span><span> </span><span class="symbol" id="span_11_244">+</span><span>      </span><span id="span_11_246">dt</span><span> </span><span class="symbol" id="span_11_247">.*</span><span> </span><span id="span_11_249">dz1</span><span> </span><span class="symbol" id="span_11_250">-</span><span> </span><span class="literal" id="span_11_252">11.</span><span> </span><span class="symbol" id="span_11_253">.*</span><span> </span><span id="span_11_255">z0</span><span> </span><span class="symbol" id="span_11_256">-</span><span>  </span><span class="literal" id="span_11_258">5.</span><span> </span><span class="symbol" id="span_11_259">.*</span><span> </span><span id="span_11_261">z1</span><span> </span><span class="symbol" id="span_11_262">+</span><span> </span><span class="literal" id="span_11_264">16.</span><span> </span><span class="symbol" id="span_11_265">.*</span><span> </span><span id="span_11_267">z_mid</span><span class="comment">
  </span><span id="span_11_269">d</span><span> </span><span class="symbol" id="span_11_270">=</span><span> </span><span id="span_11_271">dt</span><span> </span><span class="symbol" id="span_11_272">.*</span><span> </span><span id="span_11_274">dz0</span><span class="comment">
  </span><span id="span_11_276">e</span><span> </span><span class="symbol" id="span_11_277">=</span><span> </span><span id="span_11_278">z0</span><span class="comment">
  </span><span class="symbol" id="span_11_281">[</span><span id="span_11_282">a</span><span class="symbol" id="span_11_283">,</span><span> </span><span id="span_11_284">b</span><span class="symbol" id="span_11_285">,</span><span> </span><span id="span_11_286">c</span><span class="symbol" id="span_11_287">,</span><span> </span><span id="span_11_288">d</span><span class="symbol" id="span_11_289">,</span><span> </span><span id="span_11_290">e</span><span class="symbol" id="span_11_291">]</span><span class="comment">  # polynomial coefficients.
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_13_293">dps_c_mid</span><span> </span><span class="symbol" id="span_13_294">=</span><span> </span><span class="symbol" id="span_13_296">[</span><span class="comment">
   </span><span class="literal" id="span_13_297">6025192743.</span><span> </span><span class="symbol" id="span_13_298">/</span><span class="literal" id="span_13_300">30085553152.</span><span> </span><span class="symbol" id="span_13_301">/</span><span class="literal" id="span_13_303">2.</span><span class="symbol" id="span_13_304">,</span><span> </span><span class="literal" id="span_13_305">0.</span><span class="symbol" id="span_13_306">,</span><span> </span><span class="literal" id="span_13_307">51252292925.</span><span> </span><span class="symbol" id="span_13_308">/</span><span class="literal" id="span_13_310">65400821598.</span><span> </span><span class="symbol" id="span_13_311">/</span><span class="literal" id="span_13_313">2.</span><span class="symbol" id="span_13_314">,</span><span class="comment">
  </span><span class="symbol" id="span_13_315">-</span><span class="literal" id="span_13_317">2691868925.</span><span> </span><span class="symbol" id="span_13_318">/</span><span class="literal" id="span_13_320">45128329728.</span><span> </span><span class="symbol" id="span_13_321">/</span><span class="literal" id="span_13_323">2.</span><span class="symbol" id="span_13_324">,</span><span> </span><span class="literal" id="span_13_325">187940372067.</span><span> </span><span class="symbol" id="span_13_326">/</span><span class="literal" id="span_13_328">1594534317056.</span><span> </span><span class="symbol" id="span_13_329">/</span><span class="literal" id="span_13_331">2.</span><span class="symbol" id="span_13_332">,</span><span class="comment">
  </span><span class="symbol" id="span_13_333">-</span><span class="literal" id="span_13_335">1776094331.</span><span> </span><span class="symbol" id="span_13_336">/</span><span class="literal" id="span_13_338">19743644256.</span><span> </span><span class="symbol" id="span_13_339">/</span><span class="literal" id="span_13_341">2.</span><span class="symbol" id="span_13_342">,</span><span> </span><span class="literal" id="span_13_343">11237099.</span><span> </span><span class="symbol" id="span_13_344">/</span><span class="literal" id="span_13_346">235043384.</span><span> </span><span class="symbol" id="span_13_347">/</span><span class="literal" id="span_13_349">2.</span><span class="symbol" id="span_13_350">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_15_352">def</span><span> </span><span id="span_15_353">interp_fit_dopri</span><span class="symbol" id="span_15_355">(</span><span id="span_15_356">z0</span><span class="symbol" id="span_15_357">:</span><span id="span_15_359">v</span><span class="symbol" id="span_15_360">,</span><span> </span><span id="span_15_361">z1</span><span class="symbol" id="span_15_362">:</span><span id="span_15_364">v</span><span class="symbol" id="span_15_365">,</span><span> </span><span id="span_15_366">k</span><span class="symbol" id="span_15_367">:</span><span class="symbol" id="span_15_370">(</span><span id="span_15_371">Fin</span><span> </span><span class="literal" id="span_15_373">7</span><span class="symbol" id="span_15_374">)</span><span class="symbol" id="span_15_375">=&gt;</span><span id="span_15_377">v</span><span class="symbol" id="span_15_378">,</span><span> </span><span id="span_15_379">dt</span><span class="symbol" id="span_15_380">:</span><span id="span_15_382">Time</span><span class="symbol" id="span_15_383">)</span><span class="comment">
    </span><span class="symbol" id="span_15_384">-&gt;</span><span> </span><span class="symbol" id="span_15_386">(</span><span id="span_15_387">Fin</span><span> </span><span class="literal" id="span_15_389">5</span><span class="symbol" id="span_15_390">)</span><span class="symbol" id="span_15_391">=&gt;</span><span id="span_15_393">v</span><span> </span><span class="keyword" id="span_15_394">given</span><span> </span><span class="symbol" id="span_15_396">(</span><span id="span_15_397">v</span><span class="symbol" id="span_15_398">|</span><span id="span_15_400">VSpace</span><span class="symbol" id="span_15_401">)</span><span> </span><span class="symbol" id="span_15_402">=</span><span class="comment">
  # Fit a polynomial to the results of a Runge-Kutta step.
  </span><span id="span_15_405">z_mid</span><span> </span><span class="symbol" id="span_15_406">=</span><span> </span><span id="span_15_407">z0</span><span> </span><span class="symbol" id="span_15_408">+</span><span> </span><span id="span_15_410">dt</span><span> </span><span class="symbol" id="span_15_411">.*</span><span> </span><span class="symbol" id="span_15_414">(</span><span id="span_15_415">dot</span><span> </span><span id="span_15_417">dps_c_mid</span><span> </span><span id="span_15_419">k</span><span class="symbol" id="span_15_420">)</span><span class="comment">
  </span><span id="span_15_422">fit_4th_order_polynomial</span><span> </span><span id="span_15_424">z0</span><span> </span><span id="span_15_426">z1</span><span> </span><span id="span_15_428">z_mid</span><span> </span><span id="span_15_430">k</span><span class="symbol" id="span_15_433">[</span><span class="literal" id="span_15_434">0</span><span class="symbol" id="span_15_435">@</span><span class="symbol" id="span_15_438">_</span><span class="symbol" id="span_15_439">]</span><span> </span><span id="span_15_441">k</span><span class="symbol" id="span_15_444">[</span><span class="literal" id="span_15_445">1</span><span class="symbol" id="span_15_446">@</span><span class="symbol" id="span_15_449">_</span><span class="symbol" id="span_15_450">]</span><span> </span><span id="span_15_452">dt</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_17_454">def</span><span> </span><span id="span_17_455">initial_step_size</span><span class="symbol" id="span_17_457">(</span><span class="comment">
    </span><span id="span_17_458">fun</span><span class="symbol" id="span_17_459">:</span><span class="symbol" id="span_17_462">(</span><span id="span_17_463">d</span><span class="symbol" id="span_17_464">=&gt;</span><span id="span_17_466">Float</span><span class="symbol" id="span_17_467">,</span><span> </span><span id="span_17_468">Time</span><span class="symbol" id="span_17_469">)</span><span> </span><span class="symbol" id="span_17_470">-&gt;</span><span> </span><span id="span_17_472">d</span><span class="symbol" id="span_17_473">=&gt;</span><span id="span_17_475">Float</span><span class="symbol" id="span_17_476">,</span><span class="comment">
    </span><span id="span_17_477">t0</span><span class="symbol" id="span_17_478">:</span><span id="span_17_480">Time</span><span class="symbol" id="span_17_481">,</span><span> </span><span id="span_17_482">z0</span><span class="symbol" id="span_17_483">:</span><span id="span_17_485">d</span><span class="symbol" id="span_17_486">=&gt;</span><span id="span_17_488">Float</span><span class="symbol" id="span_17_489">,</span><span class="comment">
    </span><span id="span_17_490">order</span><span class="symbol" id="span_17_491">:</span><span id="span_17_493">Int</span><span class="symbol" id="span_17_494">,</span><span> </span><span id="span_17_495">rtol</span><span class="symbol" id="span_17_496">:</span><span id="span_17_498">Float</span><span class="symbol" id="span_17_499">,</span><span> </span><span id="span_17_500">atol</span><span class="symbol" id="span_17_501">:</span><span id="span_17_503">Float</span><span class="symbol" id="span_17_504">,</span><span> </span><span id="span_17_505">f0</span><span class="symbol" id="span_17_506">:</span><span id="span_17_508">d</span><span class="symbol" id="span_17_509">=&gt;</span><span id="span_17_511">Float</span><span class="comment">
    </span><span class="symbol" id="span_17_512">)</span><span> </span><span class="symbol" id="span_17_513">-&gt;</span><span> </span><span id="span_17_514">Time</span><span> </span><span class="keyword" id="span_17_515">given</span><span> </span><span class="symbol" id="span_17_517">(</span><span id="span_17_518">d</span><span class="symbol" id="span_17_519">|</span><span id="span_17_521">Ix</span><span class="symbol" id="span_17_522">)</span><span> </span><span class="symbol" id="span_17_523">=</span><span class="comment">
  # Algorithm from: E. Hairer, S. P. Norsett G. Wanner,
  # Solving Ordinary Differential Equations I: Nonstiff Problems, Sec. II.4.
  </span><span id="span_17_526">scale</span><span> </span><span class="symbol" id="span_17_527">=</span><span> </span><span class="keyword" id="span_17_529">for</span><span> </span><span id="span_17_530">i</span><span class="symbol" id="span_17_531">.</span><span> </span><span id="span_17_532">atol</span><span> </span><span class="symbol" id="span_17_533">+</span><span> </span><span class="symbol" id="span_17_536">(</span><span class="symbol" id="span_17_538">(</span><span id="span_17_539">abs</span><span> </span><span id="span_17_541">z0</span><span class="symbol" id="span_17_544">[</span><span id="span_17_545">i</span><span class="symbol" id="span_17_546">]</span><span class="symbol" id="span_17_547">)</span><span> </span><span class="symbol" id="span_17_548">*</span><span> </span><span id="span_17_550">rtol</span><span class="symbol" id="span_17_551">)</span><span class="comment">
  </span><span id="span_17_553">d0</span><span> </span><span class="symbol" id="span_17_554">=</span><span> </span><span id="span_17_555">length</span><span> </span><span class="symbol" id="span_17_558">(</span><span id="span_17_559">z0</span><span> </span><span class="symbol" id="span_17_560">./</span><span> </span><span id="span_17_562">scale</span><span class="symbol" id="span_17_563">)</span><span class="comment">
  </span><span id="span_17_565">d1</span><span> </span><span class="symbol" id="span_17_566">=</span><span> </span><span id="span_17_567">length</span><span> </span><span class="symbol" id="span_17_570">(</span><span id="span_17_571">f0</span><span> </span><span class="symbol" id="span_17_572">./</span><span> </span><span id="span_17_574">scale</span><span class="symbol" id="span_17_575">)</span><span class="comment">
  </span><span id="span_17_577">h0</span><span> </span><span class="symbol" id="span_17_578">=</span><span> </span><span id="span_17_579">select</span><span> </span><span class="symbol" id="span_17_582">(</span><span class="symbol" id="span_17_584">(</span><span id="span_17_585">d0</span><span> </span><span class="symbol" id="span_17_586">&lt;</span><span> </span><span class="literal" id="span_17_588">1.0e-5</span><span class="symbol" id="span_17_589">)</span><span> </span><span class="symbol" id="span_17_590">||</span><span> </span><span class="symbol" id="span_17_593">(</span><span id="span_17_594">d1</span><span> </span><span class="symbol" id="span_17_595">&lt;</span><span> </span><span class="literal" id="span_17_597">1.0e-5</span><span class="symbol" id="span_17_598">)</span><span class="symbol" id="span_17_599">)</span><span> </span><span class="literal" id="span_17_601">1.0e-6</span><span> </span><span class="symbol" id="span_17_604">(</span><span class="literal" id="span_17_605">0.01</span><span> </span><span class="symbol" id="span_17_606">*</span><span> </span><span class="symbol" id="span_17_609">(</span><span id="span_17_610">d0</span><span> </span><span class="symbol" id="span_17_611">/</span><span> </span><span id="span_17_613">d1</span><span class="symbol" id="span_17_614">)</span><span class="symbol" id="span_17_615">)</span><span class="comment">
  </span><span id="span_17_617">z1</span><span> </span><span class="symbol" id="span_17_618">=</span><span> </span><span id="span_17_619">z0</span><span> </span><span class="symbol" id="span_17_620">+</span><span> </span><span id="span_17_622">h0</span><span> </span><span class="symbol" id="span_17_623">.*</span><span> </span><span id="span_17_625">f0</span><span class="comment">
  </span><span id="span_17_627">f1</span><span> </span><span class="symbol" id="span_17_628">=</span><span> </span><span id="span_17_629">fun</span><span> </span><span id="span_17_631">z1</span><span> </span><span class="symbol" id="span_17_634">(</span><span id="span_17_635">t0</span><span> </span><span class="symbol" id="span_17_636">+</span><span> </span><span id="span_17_638">h0</span><span class="symbol" id="span_17_639">)</span><span class="comment">
  </span><span id="span_17_641">d2</span><span> </span><span class="symbol" id="span_17_642">=</span><span> </span><span class="symbol" id="span_17_644">(</span><span id="span_17_645">length</span><span> </span><span class="symbol" id="span_17_648">(</span><span class="symbol" id="span_17_650">(</span><span id="span_17_651">f1</span><span> </span><span class="symbol" id="span_17_652">-</span><span> </span><span id="span_17_654">f0</span><span class="symbol" id="span_17_655">)</span><span> </span><span class="symbol" id="span_17_656">./</span><span> </span><span id="span_17_658">scale</span><span class="symbol" id="span_17_659">)</span><span class="symbol" id="span_17_660">)</span><span> </span><span class="symbol" id="span_17_661">/</span><span> </span><span id="span_17_663">h0</span><span class="comment">
  </span><span id="span_17_665">left</span><span> </span><span class="symbol" id="span_17_666">=</span><span> </span><span id="span_17_667">max</span><span> </span><span class="literal" id="span_17_669">1.0e-6</span><span> </span><span class="symbol" id="span_17_672">(</span><span id="span_17_673">h0</span><span> </span><span class="symbol" id="span_17_674">*</span><span> </span><span class="literal" id="span_17_676">1.0e-3</span><span class="symbol" id="span_17_677">)</span><span class="comment">
  </span><span id="span_17_679">right</span><span> </span><span class="symbol" id="span_17_680">=</span><span> </span><span id="span_17_681">pow</span><span> </span><span class="symbol" id="span_17_684">(</span><span class="literal" id="span_17_685">0.01</span><span> </span><span class="symbol" id="span_17_686">/</span><span> </span><span class="symbol" id="span_17_689">(</span><span id="span_17_690">d1</span><span> </span><span class="symbol" id="span_17_691">+</span><span> </span><span id="span_17_693">d2</span><span class="symbol" id="span_17_694">)</span><span class="symbol" id="span_17_695">)</span><span> </span><span class="symbol" id="span_17_698">(</span><span class="literal" id="span_17_699">1.</span><span> </span><span class="symbol" id="span_17_700">/</span><span> </span><span class="symbol" id="span_17_703">(</span><span class="symbol" id="span_17_705">(</span><span id="span_17_706">i_to_f</span><span> </span><span id="span_17_708">order</span><span class="symbol" id="span_17_709">)</span><span> </span><span class="symbol" id="span_17_710">+</span><span> </span><span class="literal" id="span_17_712">1.</span><span class="symbol" id="span_17_713">)</span><span class="symbol" id="span_17_714">)</span><span class="comment">
  </span><span id="span_17_716">h1</span><span> </span><span class="symbol" id="span_17_717">=</span><span> </span><span id="span_17_718">select</span><span> </span><span class="symbol" id="span_17_721">(</span><span class="symbol" id="span_17_723">(</span><span id="span_17_724">d1</span><span> </span><span class="symbol" id="span_17_725">&lt;=</span><span> </span><span class="literal" id="span_17_727">1.0e-15</span><span class="symbol" id="span_17_728">)</span><span> </span><span class="symbol" id="span_17_729">&amp;&amp;</span><span> </span><span class="symbol" id="span_17_732">(</span><span id="span_17_733">d2</span><span> </span><span class="symbol" id="span_17_734">&lt;=</span><span> </span><span class="literal" id="span_17_736">1.0e-15</span><span class="symbol" id="span_17_737">)</span><span class="symbol" id="span_17_738">)</span><span> </span><span id="span_17_740">left</span><span> </span><span id="span_17_742">right</span><span class="comment">
  </span><span id="span_17_744">min</span><span> </span><span class="symbol" id="span_17_747">(</span><span class="literal" id="span_17_748">100.</span><span> </span><span class="symbol" id="span_17_749">*</span><span> </span><span id="span_17_751">h0</span><span class="symbol" id="span_17_752">)</span><span> </span><span id="span_17_754">h1</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># Dopri5 Butcher tableaux
</span></div>
<div class="code-block"><span id="span_20_756">alpha</span><span> </span><span class="symbol" id="span_20_757">=</span><span> </span><span class="symbol" id="span_20_759">[</span><span class="literal" id="span_20_760">1.</span><span> </span><span class="symbol" id="span_20_761">/</span><span> </span><span class="literal" id="span_20_763">5.</span><span class="symbol" id="span_20_764">,</span><span> </span><span class="literal" id="span_20_765">3.</span><span> </span><span class="symbol" id="span_20_766">/</span><span> </span><span class="literal" id="span_20_768">10.</span><span class="symbol" id="span_20_769">,</span><span> </span><span class="literal" id="span_20_770">4.</span><span> </span><span class="symbol" id="span_20_771">/</span><span> </span><span class="literal" id="span_20_773">5.</span><span class="symbol" id="span_20_774">,</span><span> </span><span class="literal" id="span_20_775">8.</span><span> </span><span class="symbol" id="span_20_776">/</span><span> </span><span class="literal" id="span_20_778">9.</span><span class="symbol" id="span_20_779">,</span><span> </span><span class="literal" id="span_20_780">1.</span><span class="symbol" id="span_20_781">,</span><span> </span><span class="literal" id="span_20_782">1.</span><span class="symbol" id="span_20_783">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block">beta : ((i:Fin 6)=&gt;(..i)=&gt;Float) =  # triangular array type.
  [coerce_table _ [1. / 5.],
   coerce_table _ [3. / 40., 9. / 40.],
   coerce_table _ [44. / 45., -56. / 15., 32.0 / 9.],
   coerce_table _ [19372. / 6561., -25360. / 2187., 64448. / 6561., -212. / 729.],
   coerce_table _ [9017./3168., -355./33., 46732./5247., 49./176., -5103./18656.],
   coerce_table _ [35. / 384., 0., 500. / 1113., 125./192., -2187./6784., 11./84.]]

</div><div class="err-result">60:23:
   |
60 | beta : ((i:Fin 6)=&gt;(..i)=&gt;Float) =  # triangular array type.
   |                       ^
unexpected &#39;i&#39;
expecting symbol name
</div>
<div class="code-block"><span id="span_23_785">c_sol</span><span> </span><span class="symbol" id="span_23_786">=</span><span> </span><span class="symbol" id="span_23_788">[</span><span class="literal" id="span_23_789">35.</span><span> </span><span class="symbol" id="span_23_790">/</span><span class="literal" id="span_23_792">384.</span><span class="symbol" id="span_23_793">,</span><span> </span><span class="literal" id="span_23_794">0.</span><span class="symbol" id="span_23_795">,</span><span> </span><span class="literal" id="span_23_796">500.</span><span> </span><span class="symbol" id="span_23_797">/</span><span class="literal" id="span_23_799">1113.</span><span class="symbol" id="span_23_800">,</span><span> </span><span class="literal" id="span_23_801">125.</span><span> </span><span class="symbol" id="span_23_802">/</span><span class="literal" id="span_23_804">192.</span><span class="symbol" id="span_23_805">,</span><span> </span><span class="symbol" id="span_23_806">-</span><span class="literal" id="span_23_808">2187.</span><span> </span><span class="symbol" id="span_23_809">/</span><span class="literal" id="span_23_811">6784.</span><span class="symbol" id="span_23_812">,</span><span> </span><span class="literal" id="span_23_813">11.</span><span> </span><span class="symbol" id="span_23_814">/</span><span> </span><span class="literal" id="span_23_816">84.</span><span class="symbol" id="span_23_817">,</span><span> </span><span class="literal" id="span_23_818">0.</span><span class="symbol" id="span_23_819">]</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_24_821">c_error</span><span> </span><span class="symbol" id="span_24_822">=</span><span class="comment">
  </span><span class="symbol" id="span_24_826">[</span><span class="literal" id="span_24_827">35.</span><span> </span><span class="symbol" id="span_24_828">/</span><span> </span><span class="literal" id="span_24_830">384.</span><span> </span><span class="symbol" id="span_24_831">-</span><span> </span><span class="literal" id="span_24_833">1951.</span><span> </span><span class="symbol" id="span_24_834">/</span><span> </span><span class="literal" id="span_24_836">21600.</span><span class="symbol" id="span_24_837">,</span><span> </span><span class="literal" id="span_24_838">0.</span><span class="symbol" id="span_24_839">,</span><span> </span><span class="literal" id="span_24_840">500.</span><span> </span><span class="symbol" id="span_24_841">/</span><span> </span><span class="literal" id="span_24_843">1113.</span><span> </span><span class="symbol" id="span_24_844">-</span><span> </span><span class="literal" id="span_24_846">22642.</span><span> </span><span class="symbol" id="span_24_847">/</span><span> </span><span class="literal" id="span_24_849">50085.</span><span class="symbol" id="span_24_850">,</span><span class="comment">
   </span><span class="literal" id="span_24_851">125.</span><span> </span><span class="symbol" id="span_24_852">/</span><span> </span><span class="literal" id="span_24_854">192.</span><span> </span><span class="symbol" id="span_24_855">-</span><span> </span><span class="literal" id="span_24_857">451.</span><span> </span><span class="symbol" id="span_24_858">/</span><span> </span><span class="literal" id="span_24_860">720.</span><span class="symbol" id="span_24_861">,</span><span> </span><span class="symbol" id="span_24_862">-</span><span class="literal" id="span_24_864">2187.</span><span> </span><span class="symbol" id="span_24_865">/</span><span> </span><span class="literal" id="span_24_867">6784.</span><span> </span><span class="symbol" id="span_24_868">+</span><span> </span><span class="literal" id="span_24_870">12231.</span><span> </span><span class="symbol" id="span_24_871">/</span><span> </span><span class="literal" id="span_24_873">42400.</span><span class="symbol" id="span_24_874">,</span><span class="comment">
   </span><span class="literal" id="span_24_875">11.</span><span> </span><span class="symbol" id="span_24_876">/</span><span> </span><span class="literal" id="span_24_878">84.</span><span> </span><span class="symbol" id="span_24_879">-</span><span> </span><span class="literal" id="span_24_881">649.</span><span> </span><span class="symbol" id="span_24_882">/</span><span> </span><span class="literal" id="span_24_884">6300.</span><span class="symbol" id="span_24_885">,</span><span> </span><span class="symbol" id="span_24_886">-</span><span class="literal" id="span_24_888">1.</span><span> </span><span class="symbol" id="span_24_889">/</span><span> </span><span class="literal" id="span_24_891">60.</span><span class="symbol" id="span_24_892">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block">def runge_kutta_step(func:(v,Time)-&gt;v, z0:v, f0:v, t0:Time, dt:Time)
    -&gt; (v, v, v, (Fin 7)=&gt;v) given (v|VSpace) =
  evals_init = yield_state zero \r.
    r!(0@_) := f0

  evals_filled = yield_state evals_init \func_evals. for i:(Fin 6).
    cur_evals = for j:(..i). get func_evals!((ordinal j)@_)
    ti = t0 + dt .* alpha[i]
    zi = z0 + dt .* dot beta[i] cur_evals
    func_evals!(((ordinal i) + 1)@_) := func zi ti

</div><div class="err-result">80:26:
   |
80 |     cur_evals = for j:(..i). get func_evals!((ordinal j)@_)
   |                          ^
unexpected &#39;i&#39;
expecting symbol name
</div>
<div class="code-block">  z_last =  z0 + dt .* dot c_sol   evals_filled
  z_last_error = dt .* dot c_error evals_filled
  f_last = evals_filled[6@_]
  (z_last, f_last, z_last_error, evals_filled)

</div><div class="err-result">85:3:
   |
85 |   z_last =  z0 + dt .* dot c_sol   evals_filled
   |   ^^
unexpected &quot;z_&quot;
expecting end of line
</div>
<div class="code-block"><span class="keyword" id="span_28_894">def</span><span> </span><span id="span_28_895">error_ratio</span><span class="symbol" id="span_28_897">(</span><span class="comment">
    </span><span id="span_28_898">error_estimates</span><span class="symbol" id="span_28_899">:</span><span id="span_28_901">d</span><span class="symbol" id="span_28_902">=&gt;</span><span id="span_28_904">Float</span><span class="symbol" id="span_28_905">,</span><span> </span><span id="span_28_906">rtol</span><span class="symbol" id="span_28_907">:</span><span id="span_28_909">Float</span><span class="symbol" id="span_28_910">,</span><span class="comment">
    </span><span id="span_28_911">atol</span><span class="symbol" id="span_28_912">:</span><span id="span_28_914">Float</span><span class="symbol" id="span_28_915">,</span><span> </span><span id="span_28_916">z0</span><span class="symbol" id="span_28_917">:</span><span id="span_28_919">d</span><span class="symbol" id="span_28_920">=&gt;</span><span id="span_28_922">Float</span><span class="symbol" id="span_28_923">,</span><span> </span><span id="span_28_924">z1</span><span class="symbol" id="span_28_925">:</span><span id="span_28_927">d</span><span class="symbol" id="span_28_928">=&gt;</span><span id="span_28_930">Float</span><span class="symbol" id="span_28_931">)</span><span class="comment">
    </span><span class="symbol" id="span_28_932">-&gt;</span><span> </span><span id="span_28_933">Float</span><span> </span><span class="keyword" id="span_28_934">given</span><span> </span><span class="symbol" id="span_28_936">(</span><span id="span_28_937">d</span><span class="symbol" id="span_28_938">|</span><span id="span_28_940">Ix</span><span class="symbol" id="span_28_941">)</span><span> </span><span class="symbol" id="span_28_942">=</span><span class="comment">
  </span><span id="span_28_945">err_tols</span><span> </span><span class="symbol" id="span_28_946">=</span><span> </span><span class="keyword" id="span_28_948">for</span><span> </span><span id="span_28_949">i</span><span class="symbol" id="span_28_950">.</span><span> </span><span id="span_28_951">atol</span><span> </span><span class="symbol" id="span_28_952">+</span><span> </span><span id="span_28_954">rtol</span><span> </span><span class="symbol" id="span_28_955">*</span><span> </span><span class="symbol" id="span_28_958">(</span><span id="span_28_959">max</span><span> </span><span class="symbol" id="span_28_962">(</span><span id="span_28_963">abs</span><span> </span><span id="span_28_965">z0</span><span class="symbol" id="span_28_968">[</span><span id="span_28_969">i</span><span class="symbol" id="span_28_970">]</span><span class="symbol" id="span_28_971">)</span><span> </span><span class="symbol" id="span_28_974">(</span><span id="span_28_975">abs</span><span> </span><span id="span_28_977">z1</span><span class="symbol" id="span_28_980">[</span><span id="span_28_981">i</span><span class="symbol" id="span_28_982">]</span><span class="symbol" id="span_28_983">)</span><span class="symbol" id="span_28_984">)</span><span class="comment">
  </span><span id="span_28_986">err_ratios</span><span> </span><span class="symbol" id="span_28_987">=</span><span> </span><span id="span_28_988">error_estimates</span><span> </span><span class="symbol" id="span_28_989">./</span><span> </span><span id="span_28_991">err_tols</span><span class="comment">
  </span><span id="span_28_993">mean</span><span> </span><span class="keyword" id="span_28_996">for</span><span> </span><span id="span_28_997">i</span><span class="symbol" id="span_28_998">.</span><span> </span><span id="span_28_999">sq</span><span> </span><span id="span_28_1001">err_ratios</span><span class="symbol" id="span_28_1004">[</span><span id="span_28_1005">i</span><span class="symbol" id="span_28_1006">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_30_1008">def</span><span> </span><span id="span_30_1009">optimal_step_size</span><span class="symbol" id="span_30_1011">(</span><span id="span_30_1012">last_step</span><span class="symbol" id="span_30_1013">:</span><span id="span_30_1015">Time</span><span class="symbol" id="span_30_1016">,</span><span> </span><span id="span_30_1017">mean_error_ratio</span><span class="symbol" id="span_30_1018">:</span><span id="span_30_1020">Float</span><span class="symbol" id="span_30_1021">)</span><span> </span><span class="symbol" id="span_30_1022">-&gt;</span><span> </span><span id="span_30_1023">Time</span><span> </span><span class="symbol" id="span_30_1024">=</span><span class="comment">
  </span><span id="span_30_1027">safety</span><span> </span><span class="symbol" id="span_30_1028">=</span><span> </span><span class="literal" id="span_30_1029">0.9</span><span class="comment">
  </span><span id="span_30_1031">ifactor</span><span> </span><span class="symbol" id="span_30_1032">=</span><span> </span><span class="literal" id="span_30_1033">10.</span><span class="comment">
  </span><span id="span_30_1035">dfactor</span><span> </span><span class="symbol" id="span_30_1036">=</span><span> </span><span class="literal" id="span_30_1037">0.2</span><span class="comment">
  </span><span id="span_30_1039">order</span><span> </span><span class="symbol" id="span_30_1040">=</span><span> </span><span class="literal" id="span_30_1041">5.</span><span class="comment">
  </span><span id="span_30_1043">dfactor</span><span> </span><span class="symbol" id="span_30_1044">=</span><span> </span><span id="span_30_1045">select</span><span> </span><span class="symbol" id="span_30_1048">(</span><span id="span_30_1049">mean_error_ratio</span><span> </span><span class="symbol" id="span_30_1050">&lt;</span><span> </span><span class="literal" id="span_30_1052">1.</span><span class="symbol" id="span_30_1053">)</span><span> </span><span class="literal" id="span_30_1055">1.</span><span> </span><span id="span_30_1057">dfactor</span><span class="comment">
  </span><span id="span_30_1059">err_ratio</span><span> </span><span class="symbol" id="span_30_1060">=</span><span> </span><span id="span_30_1061">sqrt</span><span> </span><span id="span_30_1063">mean_error_ratio</span><span class="comment">
  </span><span id="span_30_1065">minfac</span><span> </span><span class="symbol" id="span_30_1066">=</span><span> </span><span id="span_30_1067">min</span><span> </span><span class="symbol" id="span_30_1070">(</span><span> </span><span class="symbol" id="span_30_1072">(</span><span id="span_30_1073">pow</span><span> </span><span id="span_30_1075">err_ratio</span><span> </span><span class="symbol" id="span_30_1078">(</span><span class="literal" id="span_30_1079">1.</span><span> </span><span class="symbol" id="span_30_1080">/</span><span> </span><span id="span_30_1082">order</span><span class="symbol" id="span_30_1083">)</span><span class="symbol" id="span_30_1084">)</span><span> </span><span class="symbol" id="span_30_1085">/</span><span> </span><span id="span_30_1087">safety</span><span class="symbol" id="span_30_1088">)</span><span> </span><span class="symbol" id="span_30_1091">(</span><span class="literal" id="span_30_1092">1.</span><span> </span><span class="symbol" id="span_30_1093">/</span><span> </span><span id="span_30_1095">dfactor</span><span class="symbol" id="span_30_1096">)</span><span class="comment">
  </span><span id="span_30_1098">factor</span><span> </span><span class="symbol" id="span_30_1099">=</span><span> </span><span id="span_30_1100">max</span><span> </span><span class="symbol" id="span_30_1103">(</span><span class="literal" id="span_30_1104">1.</span><span> </span><span class="symbol" id="span_30_1105">/</span><span> </span><span id="span_30_1107">ifactor</span><span class="symbol" id="span_30_1108">)</span><span> </span><span id="span_30_1110">minfac</span><span class="comment">
  </span><span id="span_30_1112">select</span><span> </span><span class="symbol" id="span_30_1115">(</span><span id="span_30_1116">mean_error_ratio</span><span> </span><span class="symbol" id="span_30_1117">==</span><span> </span><span class="literal" id="span_30_1119">0.</span><span class="symbol" id="span_30_1120">)</span><span> </span><span class="symbol" id="span_30_1123">(</span><span id="span_30_1124">last_step</span><span> </span><span class="symbol" id="span_30_1125">*</span><span> </span><span id="span_30_1127">ifactor</span><span class="symbol" id="span_30_1128">)</span><span> </span><span class="symbol" id="span_30_1131">(</span><span id="span_30_1132">last_step</span><span> </span><span class="symbol" id="span_30_1133">/</span><span> </span><span id="span_30_1135">factor</span><span class="symbol" id="span_30_1136">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">

</span></div>
<div class="code-block"><span class="keyword" id="span_32_1138">struct</span><span> </span><span id="span_32_1139">ODEState</span><span class="symbol" id="span_32_1141">(</span><span id="span_32_1142">v</span><span class="symbol" id="span_32_1143">)</span><span> </span><span class="symbol" id="span_32_1144">=</span><span class="comment">
  </span><span id="span_32_1145">z</span><span>             </span><span class="symbol" id="span_32_1146">:</span><span> </span><span id="span_32_1147">v</span><span class="comment">
  </span><span id="span_32_1148">f</span><span>             </span><span class="symbol" id="span_32_1149">:</span><span> </span><span id="span_32_1150">v</span><span class="comment">
  </span><span id="span_32_1151">t</span><span>             </span><span class="symbol" id="span_32_1152">:</span><span> </span><span id="span_32_1153">Time</span><span class="comment">
  </span><span id="span_32_1154">dt</span><span>            </span><span class="symbol" id="span_32_1155">:</span><span> </span><span id="span_32_1156">Time</span><span class="comment">
  </span><span id="span_32_1157">last_t</span><span>        </span><span class="symbol" id="span_32_1158">:</span><span> </span><span id="span_32_1159">Time</span><span class="comment">
  </span><span id="span_32_1160">interp_coeffs</span><span> </span><span class="symbol" id="span_32_1161">:</span><span> </span><span id="span_32_1162">Fin</span><span> </span><span class="literal" id="span_32_1164">5</span><span> </span><span class="symbol" id="span_32_1165">=&gt;</span><span> </span><span id="span_32_1167">v</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_34_1169">def</span><span> </span><span id="span_34_1170">odeint</span><span class="symbol" id="span_34_1172">(</span><span class="comment">
    </span><span id="span_34_1173">func</span><span class="symbol" id="span_34_1174">:</span><span> </span><span class="symbol" id="span_34_1177">(</span><span id="span_34_1178">d</span><span class="symbol" id="span_34_1179">=&gt;</span><span id="span_34_1181">Float</span><span class="symbol" id="span_34_1182">,</span><span> </span><span id="span_34_1183">Time</span><span class="symbol" id="span_34_1184">)</span><span> </span><span class="symbol" id="span_34_1185">-&gt;</span><span> </span><span id="span_34_1187">d</span><span class="symbol" id="span_34_1188">=&gt;</span><span id="span_34_1190">Float</span><span class="symbol" id="span_34_1191">,</span><span class="comment">
    </span><span id="span_34_1192">z0</span><span class="symbol" id="span_34_1193">:</span><span> </span><span id="span_34_1195">d</span><span class="symbol" id="span_34_1196">=&gt;</span><span id="span_34_1198">Float</span><span class="symbol" id="span_34_1199">,</span><span> </span><span id="span_34_1200">t0</span><span class="symbol" id="span_34_1201">:</span><span> </span><span id="span_34_1203">Time</span><span class="symbol" id="span_34_1204">,</span><span> </span><span id="span_34_1205">times</span><span class="symbol" id="span_34_1206">:</span><span> </span><span id="span_34_1208">n</span><span class="symbol" id="span_34_1209">=&gt;</span><span id="span_34_1211">Time</span><span class="comment">
    </span><span class="symbol" id="span_34_1212">)</span><span> </span><span class="symbol" id="span_34_1213">-&gt;</span><span> </span><span id="span_34_1214">n</span><span class="symbol" id="span_34_1215">=&gt;</span><span id="span_34_1217">d</span><span class="symbol" id="span_34_1218">=&gt;</span><span id="span_34_1220">Float</span><span> </span><span class="keyword" id="span_34_1221">given</span><span> </span><span class="symbol" id="span_34_1223">(</span><span id="span_34_1224">n</span><span class="symbol" id="span_34_1225">|</span><span id="span_34_1227">Ix</span><span class="symbol" id="span_34_1228">,</span><span> </span><span id="span_34_1229">d</span><span class="symbol" id="span_34_1230">|</span><span id="span_34_1232">Ix</span><span class="symbol" id="span_34_1233">)</span><span> </span><span class="symbol" id="span_34_1234">=</span><span class="comment">
  # Adaptive stepsize (Dormand-Prince) Runge-Kutta odeint implementation.
  #  Args:
  #    func: time derivative of the solution z at time t.
  #    z0: the initial value for the state.
  #    t: times for evaluation. values must be strictly increasing.
  #  Returns:
  #    Values of the solution at each time point in times.
  </span><span id="span_34_1237">rtol</span><span> </span><span class="symbol" id="span_34_1238">=</span><span> </span><span class="literal" id="span_34_1239">1.4e-8</span><span class="comment"> # relative local error tolerance for solver.
  </span><span id="span_34_1241">atol</span><span> </span><span class="symbol" id="span_34_1242">=</span><span> </span><span class="literal" id="span_34_1243">1.4e-8</span><span class="comment"> # absolute local error tolerance for solver.
  </span><span id="span_34_1245">max_iters</span><span> </span><span class="symbol" id="span_34_1246">=</span><span> </span><span class="literal" id="span_34_1247">10000</span><span class="comment">
  </span><span id="span_34_1249">V</span><span> </span><span class="symbol" id="span_34_1250">:</span><span> </span><span id="span_34_1252">Type</span><span> </span><span class="symbol" id="span_34_1253">=</span><span> </span><span id="span_34_1254">d</span><span class="symbol" id="span_34_1255">=&gt;</span><span id="span_34_1257">Float</span><span class="comment">
  </span><span id="span_34_1259">S</span><span> </span><span class="symbol" id="span_34_1260">:</span><span> </span><span id="span_34_1262">Type</span><span> </span><span class="symbol" id="span_34_1263">=</span><span> </span><span id="span_34_1264">ODEState</span><span> </span><span id="span_34_1266">V</span><span class="comment">
  </span><span class="keyword" id="span_34_1268">def</span><span> </span><span id="span_34_1269">integrate_to_next_time</span><span class="symbol" id="span_34_1271">(</span><span id="span_34_1272">i</span><span class="symbol" id="span_34_1273">:</span><span id="span_34_1275">n</span><span class="symbol" id="span_34_1276">,</span><span> </span><span id="span_34_1277">init_carry</span><span class="symbol" id="span_34_1278">:</span><span id="span_34_1280">S</span><span class="symbol" id="span_34_1281">)</span><span> </span><span class="symbol" id="span_34_1282">-&gt;</span><span> </span><span class="symbol" id="span_34_1284">(</span><span id="span_34_1285">S</span><span class="symbol" id="span_34_1286">,</span><span> </span><span id="span_34_1287">V</span><span class="symbol" id="span_34_1288">)</span><span> </span><span class="symbol" id="span_34_1289">=</span><span class="comment">
    </span><span id="span_34_1292">target_t</span><span> </span><span class="symbol" id="span_34_1293">=</span><span> </span><span id="span_34_1294">times</span><span class="symbol" id="span_34_1297">[</span><span id="span_34_1298">i</span><span class="symbol" id="span_34_1299">]</span><span class="comment">

    </span><span class="keyword" id="span_34_1301">def</span><span> </span><span id="span_34_1302">continue_condition</span><span class="symbol" id="span_34_1304">(</span><span id="span_34_1305">state</span><span class="symbol" id="span_34_1306">:</span><span id="span_34_1308">S</span><span class="symbol" id="span_34_1309">)</span><span> </span><span class="symbol" id="span_34_1310">-&gt;</span><span> </span><span id="span_34_1311">Bool</span><span> </span><span class="symbol" id="span_34_1312">=</span><span class="comment">
      </span><span class="symbol" id="span_34_1316">(</span><span id="span_34_1317">state</span><span class="symbol" id="span_34_1319">.</span><span id="span_34_1320">t</span><span> </span><span class="symbol" id="span_34_1321">&lt;</span><span> </span><span id="span_34_1323">target_t</span><span class="symbol" id="span_34_1324">)</span><span> </span><span class="symbol" id="span_34_1325">&amp;&amp;</span><span> </span><span class="symbol" id="span_34_1328">(</span><span id="span_34_1329">state</span><span class="symbol" id="span_34_1331">.</span><span id="span_34_1332">dt</span><span> </span><span class="symbol" id="span_34_1333">&gt;</span><span> </span><span class="literal" id="span_34_1335">0.0</span><span class="symbol" id="span_34_1336">)</span><span> </span><span class="symbol" id="span_34_1337">&amp;&amp;</span><span> </span><span class="symbol" id="span_34_1340">(</span><span id="span_34_1341">ordinal</span><span> </span><span id="span_34_1343">i</span><span> </span><span class="symbol" id="span_34_1344">&lt;</span><span> </span><span id="span_34_1346">max_iters</span><span class="symbol" id="span_34_1347">)</span><span class="comment">

    </span><span class="keyword" id="span_34_1349">def</span><span> </span><span id="span_34_1350">possible_step</span><span class="symbol" id="span_34_1352">(</span><span id="span_34_1353">state</span><span class="symbol" id="span_34_1354">:</span><span id="span_34_1356">S</span><span class="symbol" id="span_34_1357">)</span><span> </span><span class="symbol" id="span_34_1358">-&gt;</span><span> </span><span id="span_34_1359">S</span><span> </span><span class="symbol" id="span_34_1360">=</span><span class="comment">
      </span><span id="span_34_1363">z</span><span> </span><span class="symbol" id="span_34_1364">=</span><span> </span><span id="span_34_1365">state</span><span class="symbol" id="span_34_1367">.</span><span id="span_34_1368">z</span><span class="comment">
      </span><span class="symbol" id="span_34_1371">(</span><span id="span_34_1372">next_z</span><span class="symbol" id="span_34_1373">,</span><span> </span><span id="span_34_1374">next_f</span><span class="symbol" id="span_34_1375">,</span><span> </span><span id="span_34_1376">next_z_error</span><span class="symbol" id="span_34_1377">,</span><span> </span><span id="span_34_1378">k</span><span class="symbol" id="span_34_1379">)</span><span> </span><span class="symbol" id="span_34_1380">=</span><span> </span><span id="span_34_1381">runge_kutta_step</span><span> </span><span id="span_34_1383">func</span><span> </span><span id="span_34_1385">z</span><span> </span><span id="span_34_1387">state</span><span class="symbol" id="span_34_1389">.</span><span id="span_34_1390">f</span><span> </span><span id="span_34_1392">state</span><span class="symbol" id="span_34_1394">.</span><span id="span_34_1395">t</span><span> </span><span id="span_34_1397">state</span><span class="symbol" id="span_34_1399">.</span><span id="span_34_1400">dt</span><span class="comment">
      </span><span id="span_34_1402">next_t</span><span> </span><span class="symbol" id="span_34_1403">=</span><span> </span><span id="span_34_1404">state</span><span class="symbol" id="span_34_1406">.</span><span id="span_34_1407">t</span><span> </span><span class="symbol" id="span_34_1408">+</span><span> </span><span id="span_34_1410">state</span><span class="symbol" id="span_34_1412">.</span><span id="span_34_1413">dt</span><span class="comment">
      </span><span id="span_34_1415">ratio</span><span> </span><span class="symbol" id="span_34_1416">=</span><span> </span><span id="span_34_1417">error_ratio</span><span> </span><span id="span_34_1419">next_z_error</span><span> </span><span id="span_34_1421">rtol</span><span> </span><span id="span_34_1423">atol</span><span> </span><span id="span_34_1425">z</span><span> </span><span id="span_34_1427">next_z</span><span class="comment">
      </span><span id="span_34_1429">new_interp_coeff</span><span> </span><span class="symbol" id="span_34_1430">=</span><span> </span><span id="span_34_1431">interp_fit_dopri</span><span> </span><span id="span_34_1433">z</span><span> </span><span id="span_34_1435">next_z</span><span> </span><span id="span_34_1437">k</span><span> </span><span id="span_34_1439">state</span><span class="symbol" id="span_34_1441">.</span><span id="span_34_1442">dt</span><span class="comment">
      </span><span id="span_34_1444">new_dt</span><span> </span><span class="symbol" id="span_34_1445">=</span><span> </span><span id="span_34_1446">optimal_step_size</span><span> </span><span id="span_34_1448">state</span><span class="symbol" id="span_34_1450">.</span><span id="span_34_1451">dt</span><span> </span><span id="span_34_1453">ratio</span><span class="comment">
      </span><span id="span_34_1455">move_state</span><span> </span><span class="symbol" id="span_34_1456">=</span><span> </span><span id="span_34_1457">ODEState</span><span class="symbol" id="span_34_1460">(</span><span id="span_34_1461">next_z</span><span class="symbol" id="span_34_1462">,</span><span> </span><span id="span_34_1463">next_f</span><span> </span><span class="symbol" id="span_34_1464">,</span><span>  </span><span id="span_34_1465">next_t</span><span class="symbol" id="span_34_1466">,</span><span> </span><span id="span_34_1467">new_dt</span><span class="symbol" id="span_34_1468">,</span><span> </span><span id="span_34_1469">state</span><span class="symbol" id="span_34_1471">.</span><span id="span_34_1472">t</span><span class="symbol" id="span_34_1473">,</span><span>       </span><span id="span_34_1474">new_interp_coeff</span><span class="symbol" id="span_34_1475">)</span><span class="comment">
      </span><span id="span_34_1477">stay_state</span><span> </span><span class="symbol" id="span_34_1478">=</span><span> </span><span id="span_34_1479">ODEState</span><span class="symbol" id="span_34_1482">(</span><span>     </span><span id="span_34_1483">z</span><span class="symbol" id="span_34_1484">,</span><span> </span><span id="span_34_1485">state</span><span class="symbol" id="span_34_1487">.</span><span id="span_34_1488">f</span><span class="symbol" id="span_34_1489">,</span><span> </span><span id="span_34_1490">state</span><span class="symbol" id="span_34_1492">.</span><span id="span_34_1493">t</span><span class="symbol" id="span_34_1494">,</span><span> </span><span id="span_34_1495">new_dt</span><span class="symbol" id="span_34_1496">,</span><span> </span><span id="span_34_1497">state</span><span class="symbol" id="span_34_1499">.</span><span id="span_34_1500">last_t</span><span> </span><span class="symbol" id="span_34_1501">,</span><span> </span><span id="span_34_1502">state</span><span class="symbol" id="span_34_1504">.</span><span id="span_34_1505">interp_coeffs</span><span class="symbol" id="span_34_1506">)</span><span class="comment">
      </span><span id="span_34_1508">select</span><span> </span><span class="symbol" id="span_34_1511">(</span><span id="span_34_1512">ratio</span><span> </span><span class="symbol" id="span_34_1513">&lt;=</span><span> </span><span class="literal" id="span_34_1515">1.0</span><span class="symbol" id="span_34_1516">)</span><span> </span><span id="span_34_1518">move_state</span><span> </span><span id="span_34_1520">stay_state</span><span class="comment">

    # Take steps until we pass target_t
    </span><span id="span_34_1522">new_state</span><span> </span><span class="symbol" id="span_34_1523">=</span><span> </span><span id="span_34_1524">yield_state</span><span> </span><span id="span_34_1526">init_carry</span><span> </span><span class="symbol" id="span_34_1529">\</span><span id="span_34_1530">stateRef</span><span class="symbol" id="span_34_1531">.</span><span class="comment">
      </span><span id="span_34_1534">iter</span><span> </span><span class="symbol" id="span_34_1537">\</span><span class="symbol" id="span_34_1539">_</span><span class="symbol" id="span_34_1540">.</span><span class="comment">
        </span><span id="span_34_1543">state</span><span> </span><span class="symbol" id="span_34_1544">=</span><span> </span><span id="span_34_1545">get</span><span> </span><span id="span_34_1547">stateRef</span><span class="comment">
        </span><span class="keyword" id="span_34_1550">if</span><span> </span><span id="span_34_1551">continue_condition</span><span> </span><span id="span_34_1553">state</span><span class="comment">
          </span><span class="keyword" id="span_34_1554">then</span><span class="comment">
            </span><span id="span_34_1557">stateRef</span><span> </span><span class="symbol" id="span_34_1558">:=</span><span> </span><span id="span_34_1560">possible_step</span><span> </span><span id="span_34_1562">state</span><span class="comment">
            </span><span id="span_34_1564">Continue</span><span class="comment">
          </span><span class="keyword" id="span_34_1565">else</span><span> </span><span id="span_34_1566">Done</span><span> </span><span class="symbol" id="span_34_1569">(</span><span class="symbol" id="span_34_1570">)</span><span class="comment">

    # Interpolate to the target time.
    </span><span id="span_34_1572">relative_output_time</span><span> </span><span class="symbol" id="span_34_1573">=</span><span> </span><span class="symbol" id="span_34_1575">(</span><span id="span_34_1576">target_t</span><span> </span><span class="symbol" id="span_34_1577">-</span><span> </span><span id="span_34_1579">new_state</span><span class="symbol" id="span_34_1581">.</span><span id="span_34_1582">last_t</span><span class="symbol" id="span_34_1583">)</span><span> </span><span class="symbol" id="span_34_1584">/</span><span> </span><span class="symbol" id="span_34_1587">(</span><span id="span_34_1588">new_state</span><span class="symbol" id="span_34_1590">.</span><span id="span_34_1591">t</span><span> </span><span class="symbol" id="span_34_1592">-</span><span> </span><span id="span_34_1594">new_state</span><span class="symbol" id="span_34_1596">.</span><span id="span_34_1597">last_t</span><span class="symbol" id="span_34_1598">)</span><span class="comment">
    </span><span id="span_34_1600">z_target</span><span> </span><span class="symbol" id="span_34_1601">=</span><span> </span><span id="span_34_1602">evalpoly</span><span> </span><span id="span_34_1604">new_state</span><span class="symbol" id="span_34_1606">.</span><span id="span_34_1607">interp_coeffs</span><span> </span><span id="span_34_1609">relative_output_time</span><span class="comment">
    </span><span class="symbol" id="span_34_1612">(</span><span id="span_34_1613">new_state</span><span class="symbol" id="span_34_1614">,</span><span> </span><span id="span_34_1615">z_target</span><span class="symbol" id="span_34_1616">)</span><span class="comment">

  </span><span id="span_34_1618">f0</span><span> </span><span class="symbol" id="span_34_1619">=</span><span> </span><span id="span_34_1620">func</span><span> </span><span id="span_34_1622">z0</span><span> </span><span id="span_34_1624">t0</span><span class="comment">
  </span><span id="span_34_1626">init_step</span><span> </span><span class="symbol" id="span_34_1627">=</span><span> </span><span id="span_34_1628">initial_step_size</span><span> </span><span id="span_34_1630">func</span><span> </span><span id="span_34_1632">t0</span><span> </span><span id="span_34_1634">z0</span><span> </span><span class="literal" id="span_34_1636">4</span><span> </span><span id="span_34_1638">rtol</span><span> </span><span id="span_34_1640">atol</span><span> </span><span id="span_34_1642">f0</span><span class="comment">
  </span><span id="span_34_1644">init_interp_coeff</span><span> </span><span class="symbol" id="span_34_1645">=</span><span> </span><span id="span_34_1646">zero</span><span class="comment">  # dummy vals
  </span><span id="span_34_1648">init_carry</span><span> </span><span class="symbol" id="span_34_1649">=</span><span> </span><span id="span_34_1650">ODEState</span><span class="symbol" id="span_34_1653">(</span><span id="span_34_1654">z0</span><span class="symbol" id="span_34_1655">,</span><span> </span><span id="span_34_1656">f0</span><span class="symbol" id="span_34_1657">,</span><span> </span><span id="span_34_1658">t0</span><span class="symbol" id="span_34_1659">,</span><span> </span><span id="span_34_1660">init_step</span><span class="symbol" id="span_34_1661">,</span><span> </span><span id="span_34_1662">t0</span><span class="symbol" id="span_34_1663">,</span><span> </span><span id="span_34_1664">init_interp_coeff</span><span class="symbol" id="span_34_1665">)</span><span class="comment">
  </span><span id="span_34_1667">snd</span><span> </span><span class="symbol" id="span_34_1668">$</span><span> </span><span id="span_34_1670">scan</span><span> </span><span id="span_34_1672">init_carry</span><span> </span><span id="span_34_1674">integrate_to_next_time</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="prose-block"><h2>Example: Linear dynamics</h2>
</div>
<div class="code-block"><span class="keyword" id="span_37_1676">def</span><span> </span><span id="span_37_1677">myDyn</span><span class="symbol" id="span_37_1679">(</span><span id="span_37_1680">z</span><span class="symbol" id="span_37_1681">:</span><span> </span><span id="span_37_1683">a</span><span class="symbol" id="span_37_1684">,</span><span> </span><span id="span_37_1685">t</span><span class="symbol" id="span_37_1686">:</span><span id="span_37_1688">Time</span><span class="symbol" id="span_37_1689">)</span><span> </span><span class="symbol" id="span_37_1690">-&gt;</span><span> </span><span id="span_37_1691">a</span><span> </span><span class="keyword" id="span_37_1692">given</span><span> </span><span class="symbol" id="span_37_1694">(</span><span id="span_37_1695">a</span><span class="symbol" id="span_37_1696">)</span><span> </span><span class="symbol" id="span_37_1697">=</span><span> </span><span id="span_37_1698">z</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_39_1700">z0</span><span> </span><span class="symbol" id="span_39_1701">=</span><span> </span><span class="symbol" id="span_39_1703">[</span><span class="literal" id="span_39_1704">1.0</span><span class="symbol" id="span_39_1705">]</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_40_1707">t0</span><span> </span><span class="symbol" id="span_40_1708">=</span><span> </span><span class="literal" id="span_40_1709">0.0</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_41_1711">t1</span><span> </span><span class="symbol" id="span_41_1712">=</span><span> </span><span class="symbol" id="span_41_1714">[</span><span class="literal" id="span_41_1715">1.0</span><span class="symbol" id="span_41_1716">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_43_1718">approx_e</span><span> </span><span class="symbol" id="span_43_1719">=</span><span> </span><span id="span_43_1720">odeint</span><span> </span><span id="span_43_1722">myDyn</span><span> </span><span id="span_43_1724">z0</span><span> </span><span id="span_43_1726">t0</span><span> </span><span id="span_43_1728">t1</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">:</span><span id="span_44_1729">p</span><span> </span><span id="span_44_1730">approx_e</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_46_1732">exact_e</span><span> </span><span class="symbol" id="span_46_1733">=</span><span> </span><span class="symbol" id="span_46_1735">[</span><span class="symbol" id="span_46_1737">[</span><span id="span_46_1738">exp</span><span> </span><span class="literal" id="span_46_1740">1.0</span><span class="symbol" id="span_46_1741">]</span><span class="symbol" id="span_46_1742">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment">:</span><span id="span_48_1743">p</span><span> </span><span class="symbol" id="span_48_1745">(</span><span id="span_48_1746">approx_e</span><span> </span><span class="symbol" id="span_48_1747">-</span><span> </span><span id="span_48_1749">exact_e</span><span class="symbol" id="span_48_1750">)</span><span class="comment"> # amount of numerical error
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_50_1752">times</span><span> </span><span class="symbol" id="span_50_1753">=</span><span> </span><span id="span_50_1754">linspace</span><span> </span><span class="symbol" id="span_50_1757">(</span><span id="span_50_1758">Fin</span><span> </span><span class="literal" id="span_50_1760">100</span><span class="symbol" id="span_50_1761">)</span><span> </span><span class="literal" id="span_50_1763">0.00001</span><span> </span><span class="literal" id="span_50_1765">1.0</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_51_1767">ys</span><span> </span><span class="symbol" id="span_51_1768">=</span><span> </span><span id="span_51_1769">odeint</span><span> </span><span id="span_51_1771">myDyn</span><span> </span><span id="span_51_1773">z0</span><span> </span><span id="span_51_1775">t0</span><span> </span><span id="span_51_1777">times</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment">:</span><span id="span_53_1778">html</span><span> </span><span id="span_53_1779">show_plot</span><span> </span><span class="symbol" id="span_53_1780">$</span><span> </span><span id="span_53_1782">y_plot</span><span> </span><span class="keyword" id="span_53_1785">for</span><span> </span><span id="span_53_1786">i</span><span class="symbol" id="span_53_1787">.</span><span> </span><span id="span_53_1788">ys</span><span class="symbol" id="span_53_1791">[</span><span id="span_53_1792">i</span><span class="symbol" id="span_53_1793">,</span><span> </span><span id="span_53_1794">from_ordinal</span><span> </span><span class="literal" id="span_53_1796">0</span><span class="symbol" id="span_53_1797">]</span><span class="comment">
</span></div>
</body></html>