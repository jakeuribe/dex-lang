<!DOCTYPE html><html><head><meta charset="UTF-8">
<style>
body{font-family:"SF Mono","Fira Code",monospace;max-width:960px;margin:0 auto;padding:20px;background:#0d1117;color:#c9d1d9}
.code-block{background:#161b22;padding:12px;margin:6px 0;border-radius:6px;overflow-x:auto;font-size:14px}
.prose-block{padding:8px 0} .prose-block h1{color:#58a6ff;border-bottom:1px solid #30363d;padding-bottom:8px}
.prose-block h2{color:#58a6ff}
.result{background:#1c2128;padding:10px;margin:2px 0;border-left:3px solid #3fb950;border-radius:0 4px 4px 0;font-size:13px}
.error{background:#1c0000;padding:10px;margin:2px 0;border-left:3px solid #f85149;border-radius:0 4px 4px 0}
img.plot-img{max-width:100%;height:auto;display:block;margin:12px auto;border-radius:4px;border:1px solid #30363d}
svg{max-width:100%;height:auto;display:block;margin:12px auto}
pre{margin:0;white-space:pre-wrap}
span{white-space:pre-wrap}
</style></head><body>
<h1 style="color:#58a6ff;text-align:center">02-raytrace</h1><hr style="border-color:#30363d">
<div class="code-block"><span class="comment"></span></div>
<div class="prose-block"><h1>Multi-step Ray Tracer</h1>
</div>
<div class="prose-block"><p>Based on Eric Jang's
<a href="https://github.com/ericjang/pt-jax/blob/master/jaxpt_vmap.ipynb">JAX implementation</a>,
described
<a href="https://blog.evjang.com/2019/11/jaxpt.html">here</a>.</p>
</div>
<div class="code-block"><span class="keyword" id="span_3_1">import</span><span> </span><span id="span_3_2">png</span><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_4_3">import</span><span> </span><span id="span_4_4">plot</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">

</span></div>
<div class="prose-block"><h2>Generic Helper Functions</h2>
<p>Some of these should probably go in prelude.</p>
</div>
<div class="code-block"><span class="keyword" id="span_7_6">def</span><span> </span><span id="span_7_7">Vec</span><span class="symbol" id="span_7_9">(</span><span id="span_7_10">n</span><span class="symbol" id="span_7_11">:</span><span id="span_7_13">Nat</span><span class="symbol" id="span_7_14">)</span><span> </span><span class="symbol" id="span_7_15">-&gt;</span><span> </span><span id="span_7_16">Type</span><span> </span><span class="symbol" id="span_7_17">=</span><span> </span><span id="span_7_18">Fin</span><span> </span><span id="span_7_20">n</span><span> </span><span class="symbol" id="span_7_21">=&gt;</span><span> </span><span id="span_7_23">Float</span><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_8_25">def</span><span> </span><span id="span_8_26">Mat</span><span class="symbol" id="span_8_28">(</span><span id="span_8_29">n</span><span class="symbol" id="span_8_30">:</span><span id="span_8_32">Nat</span><span class="symbol" id="span_8_33">,</span><span> </span><span id="span_8_34">m</span><span class="symbol" id="span_8_35">:</span><span id="span_8_37">Nat</span><span class="symbol" id="span_8_38">)</span><span> </span><span class="symbol" id="span_8_39">-&gt;</span><span> </span><span id="span_8_40">Type</span><span> </span><span class="symbol" id="span_8_41">=</span><span> </span><span id="span_8_42">Fin</span><span> </span><span id="span_8_44">n</span><span> </span><span class="symbol" id="span_8_45">=&gt;</span><span> </span><span id="span_8_47">Fin</span><span> </span><span id="span_8_49">m</span><span> </span><span class="symbol" id="span_8_50">=&gt;</span><span> </span><span id="span_8_52">Float</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_10_54">def</span><span> </span><span id="span_10_55">relu</span><span class="symbol" id="span_10_57">(</span><span id="span_10_58">x</span><span class="symbol" id="span_10_59">:</span><span id="span_10_61">Float</span><span class="symbol" id="span_10_62">)</span><span> </span><span class="symbol" id="span_10_63">-&gt;</span><span> </span><span id="span_10_64">Float</span><span> </span><span class="symbol" id="span_10_65">=</span><span> </span><span id="span_10_66">max</span><span> </span><span id="span_10_68">x</span><span> </span><span class="literal" id="span_10_70">0.0</span><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_11_72">def</span><span> </span><span id="span_11_73">length</span><span class="symbol" id="span_11_75">(</span><span id="span_11_76">x</span><span class="symbol" id="span_11_77">:</span><span> </span><span id="span_11_79">d</span><span class="symbol" id="span_11_80">=&gt;</span><span id="span_11_82">Float</span><span class="symbol" id="span_11_83">)</span><span> </span><span class="symbol" id="span_11_84">-&gt;</span><span> </span><span id="span_11_85">Float</span><span> </span><span class="keyword" id="span_11_86">given</span><span> </span><span class="symbol" id="span_11_88">(</span><span id="span_11_89">d</span><span class="symbol" id="span_11_90">|</span><span id="span_11_92">Ix</span><span class="symbol" id="span_11_93">)</span><span> </span><span class="symbol" id="span_11_94">=</span><span> </span><span id="span_11_95">sqrt</span><span> </span><span class="symbol" id="span_11_96">$</span><span> </span><span id="span_11_98">sum</span><span> </span><span class="keyword" id="span_11_101">for</span><span> </span><span id="span_11_102">i</span><span class="symbol" id="span_11_103">:</span><span id="span_11_105">d</span><span class="symbol" id="span_11_106">.</span><span> </span><span id="span_11_107">sq</span><span> </span><span id="span_11_109">x</span><span class="symbol" id="span_11_112">[</span><span id="span_11_113">i</span><span class="symbol" id="span_11_114">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># TODO: make a newtype for normal vectors
</span></div>
<div class="code-block"><span class="keyword" id="span_13_116">def</span><span> </span><span id="span_13_117">normalize</span><span class="symbol" id="span_13_119">(</span><span id="span_13_120">x</span><span class="symbol" id="span_13_121">:</span><span> </span><span id="span_13_123">d</span><span class="symbol" id="span_13_124">=&gt;</span><span id="span_13_126">Float</span><span class="symbol" id="span_13_127">)</span><span> </span><span class="symbol" id="span_13_128">-&gt;</span><span> </span><span id="span_13_129">d</span><span class="symbol" id="span_13_130">=&gt;</span><span id="span_13_132">Float</span><span> </span><span class="keyword" id="span_13_133">given</span><span> </span><span class="symbol" id="span_13_135">(</span><span id="span_13_136">d</span><span class="symbol" id="span_13_137">|</span><span id="span_13_139">Ix</span><span class="symbol" id="span_13_140">)</span><span> </span><span class="symbol" id="span_13_141">=</span><span> </span><span id="span_13_142">x</span><span> </span><span class="symbol" id="span_13_143">/</span><span> </span><span class="symbol" id="span_13_146">(</span><span id="span_13_147">length</span><span> </span><span id="span_13_149">x</span><span class="symbol" id="span_13_150">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_14_152">def</span><span> </span><span id="span_14_153">directionAndLength</span><span class="symbol" id="span_14_155">(</span><span id="span_14_156">x</span><span class="symbol" id="span_14_157">:</span><span> </span><span id="span_14_159">d</span><span class="symbol" id="span_14_160">=&gt;</span><span id="span_14_162">Float</span><span class="symbol" id="span_14_163">)</span><span> </span><span class="symbol" id="span_14_164">-&gt;</span><span> </span><span class="symbol" id="span_14_166">(</span><span id="span_14_167">d</span><span class="symbol" id="span_14_168">=&gt;</span><span id="span_14_170">Float</span><span class="symbol" id="span_14_171">,</span><span> </span><span id="span_14_172">Float</span><span class="symbol" id="span_14_173">)</span><span> </span><span class="keyword" id="span_14_174">given</span><span> </span><span class="symbol" id="span_14_176">(</span><span id="span_14_177">d</span><span class="symbol" id="span_14_178">|</span><span id="span_14_180">Ix</span><span class="symbol" id="span_14_181">)</span><span> </span><span class="symbol" id="span_14_182">=</span><span class="comment">
  </span><span id="span_14_185">l</span><span> </span><span class="symbol" id="span_14_186">=</span><span> </span><span id="span_14_187">length</span><span> </span><span id="span_14_189">x</span><span class="comment">
  </span><span class="symbol" id="span_14_192">(</span><span id="span_14_193">x</span><span> </span><span class="symbol" id="span_14_194">/</span><span> </span><span class="symbol" id="span_14_197">(</span><span id="span_14_198">length</span><span> </span><span id="span_14_200">x</span><span class="symbol" id="span_14_201">)</span><span class="symbol" id="span_14_202">,</span><span> </span><span id="span_14_203">l</span><span class="symbol" id="span_14_204">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_16_206">def</span><span> </span><span id="span_16_207">randuniform</span><span class="symbol" id="span_16_209">(</span><span id="span_16_210">lower</span><span class="symbol" id="span_16_211">:</span><span id="span_16_213">Float</span><span class="symbol" id="span_16_214">,</span><span> </span><span id="span_16_215">upper</span><span class="symbol" id="span_16_216">:</span><span id="span_16_218">Float</span><span class="symbol" id="span_16_219">,</span><span> </span><span id="span_16_220">k</span><span class="symbol" id="span_16_221">:</span><span id="span_16_223">Key</span><span class="symbol" id="span_16_224">)</span><span> </span><span class="symbol" id="span_16_225">-&gt;</span><span> </span><span id="span_16_226">Float</span><span> </span><span class="symbol" id="span_16_227">=</span><span class="comment">
  </span><span id="span_16_230">lower</span><span> </span><span class="symbol" id="span_16_231">+</span><span> </span><span class="symbol" id="span_16_234">(</span><span id="span_16_235">rand</span><span> </span><span id="span_16_237">k</span><span class="symbol" id="span_16_238">)</span><span> </span><span class="symbol" id="span_16_239">*</span><span> </span><span class="symbol" id="span_16_242">(</span><span id="span_16_243">upper</span><span> </span><span class="symbol" id="span_16_244">-</span><span> </span><span id="span_16_246">lower</span><span class="symbol" id="span_16_247">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_18_249">def</span><span> </span><span id="span_18_250">sampleAveraged</span><span class="symbol" id="span_18_252">(</span><span id="span_18_253">sample</span><span class="symbol" id="span_18_254">:</span><span class="symbol" id="span_18_257">(</span><span id="span_18_258">Key</span><span class="symbol" id="span_18_259">)</span><span> </span><span class="symbol" id="span_18_260">-&gt;</span><span> </span><span id="span_18_262">a</span><span class="symbol" id="span_18_263">,</span><span> </span><span id="span_18_264">n</span><span class="symbol" id="span_18_265">:</span><span id="span_18_267">Nat</span><span class="symbol" id="span_18_268">,</span><span> </span><span id="span_18_269">k</span><span class="symbol" id="span_18_270">:</span><span id="span_18_272">Key</span><span class="symbol" id="span_18_273">)</span><span> </span><span class="symbol" id="span_18_274">-&gt;</span><span> </span><span id="span_18_275">a</span><span> </span><span class="keyword" id="span_18_276">given</span><span> </span><span class="symbol" id="span_18_278">(</span><span id="span_18_279">a</span><span class="symbol" id="span_18_280">|</span><span id="span_18_282">VSpace</span><span class="symbol" id="span_18_283">)</span><span> </span><span class="symbol" id="span_18_284">=</span><span class="comment">
  </span><span id="span_18_287">yield_state</span><span> </span><span id="span_18_289">zero</span><span> </span><span class="symbol" id="span_18_292">\</span><span id="span_18_293">total</span><span class="symbol" id="span_18_294">.</span><span class="comment">
    </span><span class="keyword" id="span_18_298">for</span><span> </span><span id="span_18_299">i</span><span class="symbol" id="span_18_300">:</span><span class="symbol" id="span_18_303">(</span><span id="span_18_304">Fin</span><span> </span><span id="span_18_306">n</span><span class="symbol" id="span_18_307">)</span><span class="symbol" id="span_18_308">.</span><span class="comment">
      </span><span id="span_18_311">total</span><span> </span><span class="symbol" id="span_18_312">:=</span><span> </span><span id="span_18_314">get</span><span> </span><span id="span_18_316">total</span><span> </span><span class="symbol" id="span_18_317">+</span><span> </span><span id="span_18_319">sample</span><span> </span><span class="symbol" id="span_18_322">(</span><span id="span_18_323">ixkey</span><span> </span><span id="span_18_325">k</span><span> </span><span id="span_18_327">i</span><span class="symbol" id="span_18_328">)</span><span> </span><span class="symbol" id="span_18_329">/</span><span> </span><span id="span_18_331">n_to_f</span><span> </span><span id="span_18_333">n</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_20_335">def</span><span> </span><span id="span_20_336">positiveProjection</span><span class="symbol" id="span_20_338">(</span><span id="span_20_339">x</span><span class="symbol" id="span_20_340">:</span><span id="span_20_342">n</span><span class="symbol" id="span_20_343">=&gt;</span><span id="span_20_345">Float</span><span class="symbol" id="span_20_346">,</span><span> </span><span id="span_20_347">y</span><span class="symbol" id="span_20_348">:</span><span id="span_20_350">n</span><span class="symbol" id="span_20_351">=&gt;</span><span id="span_20_353">Float</span><span class="symbol" id="span_20_354">)</span><span> </span><span class="symbol" id="span_20_355">-&gt;</span><span> </span><span id="span_20_356">Bool</span><span> </span><span class="keyword" id="span_20_357">given</span><span> </span><span class="symbol" id="span_20_359">(</span><span id="span_20_360">n</span><span class="symbol" id="span_20_361">|</span><span id="span_20_363">Ix</span><span class="symbol" id="span_20_364">)</span><span> </span><span class="symbol" id="span_20_365">=</span><span> </span><span id="span_20_366">dot</span><span> </span><span id="span_20_368">x</span><span> </span><span id="span_20_370">y</span><span> </span><span class="symbol" id="span_20_371">&gt;</span><span> </span><span class="literal" id="span_20_373">0.0</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="prose-block"><h2>3D Helper Functions</h2>
</div>
<div class="code-block"><span class="keyword" id="span_23_375">def</span><span> </span><span id="span_23_376">cross</span><span class="symbol" id="span_23_378">(</span><span id="span_23_379">a</span><span class="symbol" id="span_23_380">:</span><span id="span_23_382">Vec</span><span> </span><span class="literal" id="span_23_384">3</span><span class="symbol" id="span_23_385">,</span><span> </span><span id="span_23_386">b</span><span class="symbol" id="span_23_387">:</span><span id="span_23_389">Vec</span><span> </span><span class="literal" id="span_23_391">3</span><span class="symbol" id="span_23_392">)</span><span> </span><span class="symbol" id="span_23_393">-&gt;</span><span> </span><span id="span_23_394">Vec</span><span> </span><span class="literal" id="span_23_396">3</span><span> </span><span class="symbol" id="span_23_397">=</span><span class="comment">
  </span><span class="symbol" id="span_23_401">[</span><span id="span_23_402">a1</span><span class="symbol" id="span_23_403">,</span><span> </span><span id="span_23_404">a2</span><span class="symbol" id="span_23_405">,</span><span> </span><span id="span_23_406">a3</span><span class="symbol" id="span_23_407">]</span><span> </span><span class="symbol" id="span_23_408">=</span><span> </span><span id="span_23_409">a</span><span class="comment">
  </span><span class="symbol" id="span_23_412">[</span><span id="span_23_413">b1</span><span class="symbol" id="span_23_414">,</span><span> </span><span id="span_23_415">b2</span><span class="symbol" id="span_23_416">,</span><span> </span><span id="span_23_417">b3</span><span class="symbol" id="span_23_418">]</span><span> </span><span class="symbol" id="span_23_419">=</span><span> </span><span id="span_23_420">b</span><span class="comment">
  </span><span class="symbol" id="span_23_423">[</span><span id="span_23_424">a2</span><span> </span><span class="symbol" id="span_23_425">*</span><span> </span><span id="span_23_427">b3</span><span> </span><span class="symbol" id="span_23_428">-</span><span> </span><span id="span_23_430">a3</span><span> </span><span class="symbol" id="span_23_431">*</span><span> </span><span id="span_23_433">b2</span><span class="symbol" id="span_23_434">,</span><span> </span><span id="span_23_435">a3</span><span> </span><span class="symbol" id="span_23_436">*</span><span> </span><span id="span_23_438">b1</span><span> </span><span class="symbol" id="span_23_439">-</span><span> </span><span id="span_23_441">a1</span><span> </span><span class="symbol" id="span_23_442">*</span><span> </span><span id="span_23_444">b3</span><span class="symbol" id="span_23_445">,</span><span> </span><span id="span_23_446">a1</span><span> </span><span class="symbol" id="span_23_447">*</span><span> </span><span id="span_23_449">b2</span><span> </span><span class="symbol" id="span_23_450">-</span><span> </span><span id="span_23_452">a2</span><span> </span><span class="symbol" id="span_23_453">*</span><span> </span><span id="span_23_455">b1</span><span class="symbol" id="span_23_456">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># TODO: Use `data Color = Red | Green | Blue` and ADTs for index sets
</span></div>
<div class="code-block"><span class="keyword" id="span_26_458">enum</span><span> </span><span id="span_26_459">Image</span><span> </span><span class="symbol" id="span_26_460">=</span><span class="comment">
 </span><span id="span_26_461">MkImage</span><span class="symbol" id="span_26_463">(</span><span id="span_26_464">height</span><span class="symbol" id="span_26_465">:</span><span id="span_26_467">Nat</span><span class="symbol" id="span_26_468">,</span><span> </span><span id="span_26_469">width</span><span class="symbol" id="span_26_470">:</span><span id="span_26_472">Nat</span><span class="symbol" id="span_26_473">,</span><span> </span><span id="span_26_474">Fin</span><span> </span><span id="span_26_476">height</span><span> </span><span class="symbol" id="span_26_477">=&gt;</span><span> </span><span id="span_26_479">Fin</span><span> </span><span id="span_26_481">width</span><span> </span><span class="symbol" id="span_26_482">=&gt;</span><span> </span><span id="span_26_484">Color</span><span class="symbol" id="span_26_485">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_28_487">xHat</span><span> </span><span class="symbol" id="span_28_488">:</span><span> </span><span id="span_28_490">Vec</span><span> </span><span class="literal" id="span_28_492">3</span><span> </span><span class="symbol" id="span_28_493">=</span><span> </span><span class="symbol" id="span_28_495">[</span><span class="literal" id="span_28_496">1.</span><span class="symbol" id="span_28_497">,</span><span> </span><span class="literal" id="span_28_498">0.</span><span class="symbol" id="span_28_499">,</span><span> </span><span class="literal" id="span_28_500">0.</span><span class="symbol" id="span_28_501">]</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_29_503">yHat</span><span> </span><span class="symbol" id="span_29_504">:</span><span> </span><span id="span_29_506">Vec</span><span> </span><span class="literal" id="span_29_508">3</span><span> </span><span class="symbol" id="span_29_509">=</span><span> </span><span class="symbol" id="span_29_511">[</span><span class="literal" id="span_29_512">0.</span><span class="symbol" id="span_29_513">,</span><span> </span><span class="literal" id="span_29_514">1.</span><span class="symbol" id="span_29_515">,</span><span> </span><span class="literal" id="span_29_516">0.</span><span class="symbol" id="span_29_517">]</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_30_519">zHat</span><span> </span><span class="symbol" id="span_30_520">:</span><span> </span><span id="span_30_522">Vec</span><span> </span><span class="literal" id="span_30_524">3</span><span> </span><span class="symbol" id="span_30_525">=</span><span> </span><span class="symbol" id="span_30_527">[</span><span class="literal" id="span_30_528">0.</span><span class="symbol" id="span_30_529">,</span><span> </span><span class="literal" id="span_30_530">0.</span><span class="symbol" id="span_30_531">,</span><span> </span><span class="literal" id="span_30_532">1.</span><span class="symbol" id="span_30_533">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_32_535">Angle</span><span> </span><span class="symbol" id="span_32_536">=</span><span> </span><span id="span_32_537">Float</span><span class="comment">  # angle in radians
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_34_539">def</span><span> </span><span id="span_34_540">rotateX</span><span class="symbol" id="span_34_542">(</span><span id="span_34_543">p</span><span class="symbol" id="span_34_544">:</span><span id="span_34_546">Vec</span><span> </span><span class="literal" id="span_34_548">3</span><span class="symbol" id="span_34_549">,</span><span> </span><span id="span_34_550">angle</span><span class="symbol" id="span_34_551">:</span><span id="span_34_553">Angle</span><span class="symbol" id="span_34_554">)</span><span> </span><span class="symbol" id="span_34_555">-&gt;</span><span> </span><span id="span_34_556">Vec</span><span> </span><span class="literal" id="span_34_558">3</span><span> </span><span class="symbol" id="span_34_559">=</span><span class="comment">
  </span><span id="span_34_562">c</span><span> </span><span class="symbol" id="span_34_563">=</span><span> </span><span id="span_34_564">cos</span><span> </span><span id="span_34_566">angle</span><span class="comment">
  </span><span id="span_34_568">s</span><span> </span><span class="symbol" id="span_34_569">=</span><span> </span><span id="span_34_570">sin</span><span> </span><span id="span_34_572">angle</span><span class="comment">
  </span><span class="symbol" id="span_34_575">[</span><span id="span_34_576">px</span><span class="symbol" id="span_34_577">,</span><span> </span><span id="span_34_578">py</span><span class="symbol" id="span_34_579">,</span><span> </span><span id="span_34_580">pz</span><span class="symbol" id="span_34_581">]</span><span> </span><span class="symbol" id="span_34_582">=</span><span> </span><span id="span_34_583">p</span><span class="comment">
  </span><span class="symbol" id="span_34_586">[</span><span id="span_34_587">px</span><span class="symbol" id="span_34_588">,</span><span> </span><span id="span_34_589">c</span><span class="symbol" id="span_34_590">*</span><span id="span_34_592">py</span><span> </span><span class="symbol" id="span_34_593">-</span><span> </span><span id="span_34_595">s</span><span class="symbol" id="span_34_596">*</span><span id="span_34_598">pz</span><span class="symbol" id="span_34_599">,</span><span> </span><span id="span_34_600">s</span><span class="symbol" id="span_34_601">*</span><span id="span_34_603">py</span><span> </span><span class="symbol" id="span_34_604">+</span><span> </span><span id="span_34_606">c</span><span class="symbol" id="span_34_607">*</span><span id="span_34_609">pz</span><span class="symbol" id="span_34_610">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_36_612">def</span><span> </span><span id="span_36_613">rotateY</span><span class="symbol" id="span_36_615">(</span><span id="span_36_616">p</span><span class="symbol" id="span_36_617">:</span><span id="span_36_619">Vec</span><span> </span><span class="literal" id="span_36_621">3</span><span class="symbol" id="span_36_622">,</span><span> </span><span id="span_36_623">angle</span><span class="symbol" id="span_36_624">:</span><span id="span_36_626">Angle</span><span class="symbol" id="span_36_627">)</span><span> </span><span class="symbol" id="span_36_628">-&gt;</span><span> </span><span id="span_36_629">Vec</span><span> </span><span class="literal" id="span_36_631">3</span><span> </span><span class="symbol" id="span_36_632">=</span><span class="comment">
  </span><span id="span_36_635">c</span><span> </span><span class="symbol" id="span_36_636">=</span><span> </span><span id="span_36_637">cos</span><span> </span><span id="span_36_639">angle</span><span class="comment">
  </span><span id="span_36_641">s</span><span> </span><span class="symbol" id="span_36_642">=</span><span> </span><span id="span_36_643">sin</span><span> </span><span id="span_36_645">angle</span><span class="comment">
  </span><span class="symbol" id="span_36_648">[</span><span id="span_36_649">px</span><span class="symbol" id="span_36_650">,</span><span> </span><span id="span_36_651">py</span><span class="symbol" id="span_36_652">,</span><span> </span><span id="span_36_653">pz</span><span class="symbol" id="span_36_654">]</span><span> </span><span class="symbol" id="span_36_655">=</span><span> </span><span id="span_36_656">p</span><span class="comment">
  </span><span class="symbol" id="span_36_659">[</span><span id="span_36_660">c</span><span class="symbol" id="span_36_661">*</span><span id="span_36_663">px</span><span> </span><span class="symbol" id="span_36_664">+</span><span> </span><span id="span_36_666">s</span><span class="symbol" id="span_36_667">*</span><span id="span_36_669">pz</span><span class="symbol" id="span_36_670">,</span><span> </span><span id="span_36_671">py</span><span class="symbol" id="span_36_672">,</span><span> </span><span class="symbol" id="span_36_673">-</span><span> </span><span id="span_36_675">s</span><span class="symbol" id="span_36_676">*</span><span id="span_36_678">px</span><span class="symbol" id="span_36_679">+</span><span> </span><span id="span_36_681">c</span><span class="symbol" id="span_36_682">*</span><span id="span_36_684">pz</span><span class="symbol" id="span_36_685">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_38_687">def</span><span> </span><span id="span_38_688">rotateZ</span><span class="symbol" id="span_38_690">(</span><span id="span_38_691">p</span><span class="symbol" id="span_38_692">:</span><span id="span_38_694">Vec</span><span> </span><span class="literal" id="span_38_696">3</span><span class="symbol" id="span_38_697">,</span><span> </span><span id="span_38_698">angle</span><span class="symbol" id="span_38_699">:</span><span id="span_38_701">Angle</span><span class="symbol" id="span_38_702">)</span><span> </span><span class="symbol" id="span_38_703">-&gt;</span><span> </span><span id="span_38_704">Vec</span><span> </span><span class="literal" id="span_38_706">3</span><span> </span><span class="symbol" id="span_38_707">=</span><span class="comment">
  </span><span id="span_38_710">c</span><span> </span><span class="symbol" id="span_38_711">=</span><span> </span><span id="span_38_712">cos</span><span> </span><span id="span_38_714">angle</span><span class="comment">
  </span><span id="span_38_716">s</span><span> </span><span class="symbol" id="span_38_717">=</span><span> </span><span id="span_38_718">sin</span><span> </span><span id="span_38_720">angle</span><span class="comment">
  </span><span class="symbol" id="span_38_723">[</span><span id="span_38_724">px</span><span class="symbol" id="span_38_725">,</span><span> </span><span id="span_38_726">py</span><span class="symbol" id="span_38_727">,</span><span> </span><span id="span_38_728">pz</span><span class="symbol" id="span_38_729">]</span><span> </span><span class="symbol" id="span_38_730">=</span><span> </span><span id="span_38_731">p</span><span class="comment">
  </span><span class="symbol" id="span_38_734">[</span><span id="span_38_735">c</span><span class="symbol" id="span_38_736">*</span><span id="span_38_738">px</span><span> </span><span class="symbol" id="span_38_739">-</span><span> </span><span id="span_38_741">s</span><span class="symbol" id="span_38_742">*</span><span id="span_38_744">py</span><span class="symbol" id="span_38_745">,</span><span> </span><span id="span_38_746">s</span><span class="symbol" id="span_38_747">*</span><span id="span_38_749">px</span><span class="symbol" id="span_38_750">+</span><span id="span_38_752">c</span><span class="symbol" id="span_38_753">*</span><span id="span_38_755">py</span><span class="symbol" id="span_38_756">,</span><span> </span><span id="span_38_757">pz</span><span class="symbol" id="span_38_758">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_40_760">def</span><span> </span><span id="span_40_761">sampleCosineWeightedHemisphere</span><span class="symbol" id="span_40_763">(</span><span id="span_40_764">normal</span><span class="symbol" id="span_40_765">:</span><span> </span><span id="span_40_767">Vec</span><span> </span><span class="literal" id="span_40_769">3</span><span class="symbol" id="span_40_770">,</span><span> </span><span id="span_40_771">k</span><span class="symbol" id="span_40_772">:</span><span id="span_40_774">Key</span><span class="symbol" id="span_40_775">)</span><span> </span><span class="symbol" id="span_40_776">-&gt;</span><span> </span><span id="span_40_777">Vec</span><span> </span><span class="literal" id="span_40_779">3</span><span> </span><span class="symbol" id="span_40_780">=</span><span class="comment">
  </span><span class="symbol" id="span_40_784">[</span><span id="span_40_785">k1</span><span class="symbol" id="span_40_786">,</span><span> </span><span id="span_40_787">k2</span><span class="symbol" id="span_40_788">]</span><span> </span><span class="symbol" id="span_40_789">=</span><span> </span><span id="span_40_790">split_key</span><span class="symbol" id="span_40_793">(</span><span id="span_40_794">n</span><span class="symbol" id="span_40_795">=</span><span class="literal" id="span_40_797">2</span><span class="symbol" id="span_40_798">,</span><span> </span><span id="span_40_799">k</span><span class="symbol" id="span_40_800">)</span><span class="comment">
  </span><span id="span_40_802">u1</span><span> </span><span class="symbol" id="span_40_803">=</span><span> </span><span id="span_40_804">rand</span><span> </span><span id="span_40_806">k1</span><span class="comment">
  </span><span id="span_40_808">u2</span><span> </span><span class="symbol" id="span_40_809">=</span><span> </span><span id="span_40_810">rand</span><span> </span><span id="span_40_812">k2</span><span class="comment">
  </span><span id="span_40_814">uu</span><span> </span><span class="symbol" id="span_40_815">=</span><span> </span><span id="span_40_816">normalize</span><span> </span><span class="symbol" id="span_40_817">$</span><span> </span><span id="span_40_819">cross</span><span> </span><span id="span_40_821">normal</span><span> </span><span class="symbol" id="span_40_824">[</span><span class="literal" id="span_40_825">0.0</span><span class="symbol" id="span_40_826">,</span><span> </span><span class="literal" id="span_40_827">1.1</span><span class="symbol" id="span_40_828">,</span><span> </span><span class="literal" id="span_40_829">1.1</span><span class="symbol" id="span_40_830">]</span><span class="comment">
  </span><span id="span_40_832">vv</span><span> </span><span class="symbol" id="span_40_833">=</span><span> </span><span id="span_40_834">cross</span><span> </span><span id="span_40_836">uu</span><span> </span><span id="span_40_838">normal</span><span class="comment">
  </span><span id="span_40_840">ra</span><span> </span><span class="symbol" id="span_40_841">=</span><span> </span><span id="span_40_842">sqrt</span><span> </span><span id="span_40_844">u2</span><span class="comment">
  </span><span id="span_40_846">rx</span><span> </span><span class="symbol" id="span_40_847">=</span><span> </span><span id="span_40_848">ra</span><span> </span><span class="symbol" id="span_40_849">*</span><span> </span><span id="span_40_851">cos</span><span> </span><span class="symbol" id="span_40_854">(</span><span class="literal" id="span_40_855">2.0</span><span> </span><span class="symbol" id="span_40_856">*</span><span> </span><span id="span_40_858">pi</span><span> </span><span class="symbol" id="span_40_859">*</span><span> </span><span id="span_40_861">u1</span><span class="symbol" id="span_40_862">)</span><span class="comment">
  </span><span id="span_40_864">ry</span><span> </span><span class="symbol" id="span_40_865">=</span><span> </span><span id="span_40_866">ra</span><span> </span><span class="symbol" id="span_40_867">*</span><span> </span><span id="span_40_869">sin</span><span> </span><span class="symbol" id="span_40_872">(</span><span class="literal" id="span_40_873">2.0</span><span> </span><span class="symbol" id="span_40_874">*</span><span> </span><span id="span_40_876">pi</span><span> </span><span class="symbol" id="span_40_877">*</span><span> </span><span id="span_40_879">u1</span><span class="symbol" id="span_40_880">)</span><span class="comment">
  </span><span id="span_40_882">rz</span><span> </span><span class="symbol" id="span_40_883">=</span><span> </span><span id="span_40_884">sqrt</span><span> </span><span class="symbol" id="span_40_887">(</span><span class="literal" id="span_40_888">1.0</span><span> </span><span class="symbol" id="span_40_889">-</span><span> </span><span id="span_40_891">u2</span><span class="symbol" id="span_40_892">)</span><span class="comment">
  </span><span id="span_40_894">rr</span><span> </span><span class="symbol" id="span_40_895">=</span><span> </span><span class="symbol" id="span_40_897">(</span><span id="span_40_898">rx</span><span> </span><span class="symbol" id="span_40_899">.*</span><span> </span><span id="span_40_901">uu</span><span class="symbol" id="span_40_902">)</span><span> </span><span class="symbol" id="span_40_903">+</span><span> </span><span class="symbol" id="span_40_906">(</span><span id="span_40_907">ry</span><span> </span><span class="symbol" id="span_40_908">.*</span><span> </span><span id="span_40_910">vv</span><span class="symbol" id="span_40_911">)</span><span> </span><span class="symbol" id="span_40_912">+</span><span> </span><span class="symbol" id="span_40_915">(</span><span id="span_40_916">rz</span><span> </span><span class="symbol" id="span_40_917">.*</span><span> </span><span id="span_40_919">normal</span><span class="symbol" id="span_40_920">)</span><span class="comment">
  </span><span id="span_40_922">normalize</span><span> </span><span id="span_40_924">rr</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="prose-block"><h2>Raytracer</h2>
</div>
<div class="code-block"><span id="span_43_926">Distance</span><span> </span><span class="symbol" id="span_43_927">=</span><span> </span><span id="span_43_928">Float</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_45_930">Position</span><span>  </span><span class="symbol" id="span_45_931">=</span><span> </span><span id="span_45_932">Vec</span><span> </span><span class="literal" id="span_45_934">3</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_46_936">Direction</span><span> </span><span class="symbol" id="span_46_937">=</span><span> </span><span id="span_46_938">Vec</span><span> </span><span class="literal" id="span_46_940">3</span><span class="comment">  # Should be normalized. TODO: use a newtype wrapper
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_48_942">BlockHalfWidths</span><span> </span><span class="symbol" id="span_48_943">=</span><span> </span><span id="span_48_944">Vec</span><span> </span><span class="literal" id="span_48_946">3</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_49_948">Radius</span><span> </span><span class="symbol" id="span_49_949">=</span><span> </span><span id="span_49_950">Float</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_50_952">Radiance</span><span> </span><span class="symbol" id="span_50_953">=</span><span> </span><span id="span_50_954">Color</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_52_956">enum</span><span> </span><span id="span_52_957">ObjectGeom</span><span> </span><span class="symbol" id="span_52_958">=</span><span class="comment">
  </span><span id="span_52_959">Wall</span><span class="symbol" id="span_52_961">(</span><span id="span_52_962">Direction</span><span class="symbol" id="span_52_963">,</span><span> </span><span id="span_52_964">Distance</span><span class="symbol" id="span_52_965">)</span><span class="comment">
  </span><span id="span_52_966">Block</span><span class="symbol" id="span_52_968">(</span><span id="span_52_969">Position</span><span class="symbol" id="span_52_970">,</span><span> </span><span id="span_52_971">BlockHalfWidths</span><span class="symbol" id="span_52_972">,</span><span> </span><span id="span_52_973">Angle</span><span class="symbol" id="span_52_974">)</span><span class="comment">
  </span><span id="span_52_975">Sphere</span><span class="symbol" id="span_52_977">(</span><span id="span_52_978">Position</span><span class="symbol" id="span_52_979">,</span><span> </span><span id="span_52_980">Radius</span><span class="symbol" id="span_52_981">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_54_983">enum</span><span> </span><span id="span_54_984">Surface</span><span> </span><span class="symbol" id="span_54_985">=</span><span class="comment">
  </span><span id="span_54_986">Matte</span><span class="symbol" id="span_54_988">(</span><span id="span_54_989">Color</span><span class="symbol" id="span_54_990">)</span><span class="comment">
  </span><span id="span_54_991">Mirror</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_56_993">struct</span><span> </span><span id="span_56_994">OrientedSurface</span><span> </span><span class="symbol" id="span_56_995">=</span><span class="comment">
  </span><span id="span_56_996">normal</span><span>  </span><span class="symbol" id="span_56_997">:</span><span> </span><span id="span_56_998">Direction</span><span class="comment">
  </span><span id="span_56_999">surface</span><span> </span><span class="symbol" id="span_56_1000">:</span><span> </span><span id="span_56_1001">Surface</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_58_1003">enum</span><span> </span><span id="span_58_1004">Object</span><span> </span><span class="symbol" id="span_58_1005">=</span><span class="comment">
  </span><span id="span_58_1006">PassiveObject</span><span class="symbol" id="span_58_1008">(</span><span id="span_58_1009">ObjectGeom</span><span class="symbol" id="span_58_1010">,</span><span> </span><span id="span_58_1011">Surface</span><span class="symbol" id="span_58_1012">)</span><span class="comment">
  # position, half-width, intensity (assumed to point down)
  </span><span id="span_58_1013">Light</span><span class="symbol" id="span_58_1015">(</span><span id="span_58_1016">Position</span><span class="symbol" id="span_58_1017">,</span><span> </span><span id="span_58_1018">Float</span><span class="symbol" id="span_58_1019">,</span><span> </span><span id="span_58_1020">Radiance</span><span class="symbol" id="span_58_1021">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_60_1023">struct</span><span> </span><span id="span_60_1024">Ray</span><span> </span><span class="symbol" id="span_60_1025">=</span><span class="comment">
  </span><span id="span_60_1026">origin</span><span> </span><span class="symbol" id="span_60_1027">:</span><span> </span><span id="span_60_1028">Position</span><span class="comment">
  </span><span id="span_60_1029">dir</span><span>    </span><span class="symbol" id="span_60_1030">:</span><span> </span><span id="span_60_1031">Direction</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_62_1033">Filter</span><span> </span><span class="symbol" id="span_62_1034">=</span><span> </span><span id="span_62_1035">Color</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_64_1037">struct</span><span> </span><span id="span_64_1038">Params</span><span> </span><span class="symbol" id="span_64_1039">=</span><span class="comment">
 </span><span id="span_64_1040">numSamples</span><span> </span><span class="symbol" id="span_64_1041">:</span><span> </span><span id="span_64_1042">Nat</span><span class="comment">
 </span><span id="span_64_1043">maxBounces</span><span> </span><span class="symbol" id="span_64_1044">:</span><span> </span><span id="span_64_1045">Nat</span><span class="comment">
 </span><span id="span_64_1046">shareSeed</span><span>  </span><span class="symbol" id="span_64_1047">:</span><span> </span><span id="span_64_1048">Bool</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># TODO: use a list instead, once they work
</span></div>
<div class="code-block"><span class="keyword" id="span_67_1050">struct</span><span> </span><span id="span_67_1051">Scene</span><span class="symbol" id="span_67_1053">(</span><span id="span_67_1054">n</span><span class="symbol" id="span_67_1055">|</span><span id="span_67_1057">Ix</span><span class="symbol" id="span_67_1058">)</span><span> </span><span class="symbol" id="span_67_1059">=</span><span class="comment">
  </span><span id="span_67_1060">objects</span><span> </span><span class="symbol" id="span_67_1061">:</span><span> </span><span id="span_67_1062">n</span><span class="symbol" id="span_67_1063">=&gt;</span><span id="span_67_1065">Object</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_69_1067">def</span><span> </span><span id="span_69_1068">sampleReflection</span><span class="symbol" id="span_69_1070">(</span><span id="span_69_1071">surf</span><span class="symbol" id="span_69_1072">:</span><span id="span_69_1074">OrientedSurface</span><span class="symbol" id="span_69_1075">,</span><span> </span><span id="span_69_1076">ray</span><span class="symbol" id="span_69_1077">:</span><span id="span_69_1079">Ray</span><span class="symbol" id="span_69_1080">,</span><span> </span><span id="span_69_1081">k</span><span class="symbol" id="span_69_1082">:</span><span id="span_69_1084">Key</span><span class="symbol" id="span_69_1085">)</span><span> </span><span class="symbol" id="span_69_1086">-&gt;</span><span> </span><span id="span_69_1087">Ray</span><span> </span><span class="symbol" id="span_69_1088">=</span><span class="comment">
  </span><span id="span_69_1091">nor</span><span> </span><span class="symbol" id="span_69_1092">=</span><span> </span><span id="span_69_1093">surf</span><span class="symbol" id="span_69_1095">.</span><span id="span_69_1096">normal</span><span class="comment">
  </span><span id="span_69_1098">newDir</span><span> </span><span class="symbol" id="span_69_1099">=</span><span> </span><span class="keyword" id="span_69_1101">case</span><span> </span><span id="span_69_1102">surf</span><span class="symbol" id="span_69_1104">.</span><span id="span_69_1105">surface</span><span> </span><span class="keyword" id="span_69_1106">of</span><span class="comment">
    </span><span id="span_69_1107">Matte</span><span> </span><span class="symbol" id="span_69_1110">_</span><span> </span><span class="symbol" id="span_69_1111">-&gt;</span><span> </span><span id="span_69_1112">sampleCosineWeightedHemisphere</span><span> </span><span id="span_69_1114">nor</span><span> </span><span id="span_69_1116">k</span><span class="comment">
    # TODO: surely there&#39;s some change-of-solid-angle correction we need to
    # consider when reflecting off a curved surface.
    </span><span id="span_69_1117">Mirror</span><span>  </span><span class="symbol" id="span_69_1118">-&gt;</span><span> </span><span id="span_69_1119">ray</span><span class="symbol" id="span_69_1121">.</span><span id="span_69_1122">dir</span><span> </span><span class="symbol" id="span_69_1123">-</span><span> </span><span class="symbol" id="span_69_1126">(</span><span class="literal" id="span_69_1127">2.0</span><span> </span><span class="symbol" id="span_69_1128">*</span><span> </span><span id="span_69_1130">dot</span><span> </span><span id="span_69_1132">ray</span><span class="symbol" id="span_69_1134">.</span><span id="span_69_1135">dir</span><span> </span><span id="span_69_1137">nor</span><span class="symbol" id="span_69_1138">)</span><span> </span><span class="symbol" id="span_69_1139">.*</span><span> </span><span id="span_69_1141">nor</span><span class="comment">
  </span><span id="span_69_1143">Ray</span><span class="symbol" id="span_69_1146">(</span><span id="span_69_1147">ray</span><span class="symbol" id="span_69_1149">.</span><span id="span_69_1150">origin</span><span class="symbol" id="span_69_1151">,</span><span> </span><span id="span_69_1152">newDir</span><span class="symbol" id="span_69_1153">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_71_1155">def</span><span> </span><span id="span_71_1156">probReflection</span><span class="symbol" id="span_71_1158">(</span><span id="span_71_1159">surf</span><span class="symbol" id="span_71_1160">:</span><span id="span_71_1162">OrientedSurface</span><span class="symbol" id="span_71_1163">,</span><span> </span><span class="symbol" id="span_71_1165">_</span><span class="symbol" id="span_71_1166">:</span><span id="span_71_1168">Ray</span><span class="symbol" id="span_71_1169">,</span><span> </span><span id="span_71_1170">out_ray</span><span class="symbol" id="span_71_1171">:</span><span id="span_71_1173">Ray</span><span class="symbol" id="span_71_1174">)</span><span> </span><span class="symbol" id="span_71_1175">-&gt;</span><span> </span><span id="span_71_1176">Float</span><span> </span><span class="symbol" id="span_71_1177">=</span><span class="comment">
  </span><span class="keyword" id="span_71_1181">case</span><span> </span><span id="span_71_1182">surf</span><span class="symbol" id="span_71_1184">.</span><span id="span_71_1185">surface</span><span> </span><span class="keyword" id="span_71_1186">of</span><span class="comment">
    </span><span id="span_71_1187">Matte</span><span> </span><span class="symbol" id="span_71_1190">_</span><span> </span><span class="symbol" id="span_71_1191">-&gt;</span><span> </span><span id="span_71_1192">relu</span><span> </span><span class="symbol" id="span_71_1193">$</span><span> </span><span id="span_71_1195">dot</span><span> </span><span id="span_71_1197">surf</span><span class="symbol" id="span_71_1199">.</span><span id="span_71_1200">normal</span><span> </span><span id="span_71_1202">out_ray</span><span class="symbol" id="span_71_1204">.</span><span id="span_71_1205">dir</span><span class="comment">
    </span><span id="span_71_1206">Mirror</span><span>  </span><span class="symbol" id="span_71_1207">-&gt;</span><span> </span><span class="literal" id="span_71_1208">0.0</span><span class="comment">  # TODO: this should be a delta function of some sort
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_73_1210">def</span><span> </span><span id="span_73_1211">applyFilter</span><span class="symbol" id="span_73_1213">(</span><span id="span_73_1214">filter</span><span class="symbol" id="span_73_1215">:</span><span id="span_73_1217">Filter</span><span class="symbol" id="span_73_1218">,</span><span> </span><span id="span_73_1219">radiance</span><span class="symbol" id="span_73_1220">:</span><span id="span_73_1222">Radiance</span><span class="symbol" id="span_73_1223">)</span><span> </span><span class="symbol" id="span_73_1224">-&gt;</span><span> </span><span id="span_73_1225">Radiance</span><span> </span><span class="symbol" id="span_73_1226">=</span><span class="comment">
  </span><span class="keyword" id="span_73_1230">for</span><span> </span><span id="span_73_1231">i</span><span class="symbol" id="span_73_1232">.</span><span> </span><span id="span_73_1233">filter</span><span class="symbol" id="span_73_1236">[</span><span id="span_73_1237">i</span><span class="symbol" id="span_73_1238">]</span><span> </span><span class="symbol" id="span_73_1239">*</span><span> </span><span id="span_73_1241">radiance</span><span class="symbol" id="span_73_1244">[</span><span id="span_73_1245">i</span><span class="symbol" id="span_73_1246">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_75_1248">def</span><span> </span><span id="span_75_1249">surfaceFilter</span><span class="symbol" id="span_75_1251">(</span><span id="span_75_1252">filter</span><span class="symbol" id="span_75_1253">:</span><span id="span_75_1255">Filter</span><span class="symbol" id="span_75_1256">,</span><span> </span><span id="span_75_1257">surf</span><span class="symbol" id="span_75_1258">:</span><span id="span_75_1260">Surface</span><span class="symbol" id="span_75_1261">)</span><span> </span><span class="symbol" id="span_75_1262">-&gt;</span><span> </span><span id="span_75_1263">Filter</span><span> </span><span class="symbol" id="span_75_1264">=</span><span class="comment">
  </span><span class="keyword" id="span_75_1268">case</span><span> </span><span id="span_75_1269">surf</span><span> </span><span class="keyword" id="span_75_1270">of</span><span class="comment">
    </span><span id="span_75_1271">Matte</span><span> </span><span id="span_75_1273">color</span><span> </span><span class="symbol" id="span_75_1274">-&gt;</span><span> </span><span class="keyword" id="span_75_1276">for</span><span> </span><span id="span_75_1277">i</span><span class="symbol" id="span_75_1278">.</span><span> </span><span id="span_75_1279">filter</span><span class="symbol" id="span_75_1282">[</span><span id="span_75_1283">i</span><span class="symbol" id="span_75_1284">]</span><span> </span><span class="symbol" id="span_75_1285">*</span><span> </span><span id="span_75_1287">color</span><span class="symbol" id="span_75_1290">[</span><span id="span_75_1291">i</span><span class="symbol" id="span_75_1292">]</span><span class="comment">
    </span><span id="span_75_1293">Mirror</span><span>      </span><span class="symbol" id="span_75_1294">-&gt;</span><span> </span><span id="span_75_1295">filter</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_77_1297">def</span><span> </span><span id="span_77_1298">sdObject</span><span class="symbol" id="span_77_1300">(</span><span id="span_77_1301">pos</span><span class="symbol" id="span_77_1302">:</span><span id="span_77_1304">Position</span><span class="symbol" id="span_77_1305">,</span><span> </span><span id="span_77_1306">obj</span><span class="symbol" id="span_77_1307">:</span><span id="span_77_1309">Object</span><span class="symbol" id="span_77_1310">)</span><span> </span><span class="symbol" id="span_77_1311">-&gt;</span><span> </span><span id="span_77_1312">Distance</span><span> </span><span class="symbol" id="span_77_1313">=</span><span class="comment">
  </span><span class="keyword" id="span_77_1317">case</span><span> </span><span id="span_77_1318">obj</span><span> </span><span class="keyword" id="span_77_1319">of</span><span class="comment">
    </span><span id="span_77_1320">PassiveObject</span><span class="symbol" id="span_77_1323">(</span><span id="span_77_1324">geom</span><span class="symbol" id="span_77_1325">,</span><span> </span><span class="symbol" id="span_77_1327">_</span><span class="symbol" id="span_77_1328">)</span><span> </span><span class="symbol" id="span_77_1329">-&gt;</span><span> </span><span class="keyword" id="span_77_1331">case</span><span> </span><span id="span_77_1332">geom</span><span> </span><span class="keyword" id="span_77_1333">of</span><span class="comment">
      </span><span id="span_77_1334">Wall</span><span class="symbol" id="span_77_1337">(</span><span id="span_77_1338">nor</span><span class="symbol" id="span_77_1339">,</span><span> </span><span id="span_77_1340">d</span><span class="symbol" id="span_77_1341">)</span><span> </span><span class="symbol" id="span_77_1342">-&gt;</span><span> </span><span id="span_77_1343">d</span><span> </span><span class="symbol" id="span_77_1344">+</span><span> </span><span id="span_77_1346">dot</span><span> </span><span id="span_77_1348">nor</span><span> </span><span id="span_77_1350">pos</span><span class="comment">
      </span><span id="span_77_1351">Block</span><span class="symbol" id="span_77_1354">(</span><span id="span_77_1355">blockPos</span><span class="symbol" id="span_77_1356">,</span><span> </span><span id="span_77_1357">halfWidths</span><span class="symbol" id="span_77_1358">,</span><span> </span><span id="span_77_1359">angle</span><span class="symbol" id="span_77_1360">)</span><span> </span><span class="symbol" id="span_77_1361">-&gt;</span><span class="comment">
        </span><span id="span_77_1364">pos&#39;</span><span> </span><span class="symbol" id="span_77_1365">=</span><span> </span><span id="span_77_1366">rotateY</span><span> </span><span class="symbol" id="span_77_1369">(</span><span id="span_77_1370">pos</span><span> </span><span class="symbol" id="span_77_1371">-</span><span> </span><span id="span_77_1373">blockPos</span><span class="symbol" id="span_77_1374">)</span><span> </span><span id="span_77_1376">angle</span><span class="comment">
        </span><span id="span_77_1378">length</span><span> </span><span class="symbol" id="span_77_1379">$</span><span> </span><span class="keyword" id="span_77_1382">for</span><span> </span><span id="span_77_1383">i</span><span class="symbol" id="span_77_1384">:</span><span class="symbol" id="span_77_1387">(</span><span id="span_77_1388">Fin</span><span> </span><span class="literal" id="span_77_1390">3</span><span class="symbol" id="span_77_1391">)</span><span class="symbol" id="span_77_1392">.</span><span> </span><span id="span_77_1393">max</span><span> </span><span class="symbol" id="span_77_1396">(</span><span class="symbol" id="span_77_1398">(</span><span id="span_77_1399">abs</span><span> </span><span id="span_77_1401">pos&#39;</span><span class="symbol" id="span_77_1404">[</span><span id="span_77_1405">i</span><span class="symbol" id="span_77_1406">]</span><span class="symbol" id="span_77_1407">)</span><span> </span><span class="symbol" id="span_77_1408">-</span><span> </span><span id="span_77_1410">halfWidths</span><span class="symbol" id="span_77_1413">[</span><span id="span_77_1414">i</span><span class="symbol" id="span_77_1415">]</span><span class="symbol" id="span_77_1416">)</span><span> </span><span class="literal" id="span_77_1418">0.0</span><span class="comment">
      </span><span id="span_77_1419">Sphere</span><span class="symbol" id="span_77_1422">(</span><span id="span_77_1423">spherePos</span><span class="symbol" id="span_77_1424">,</span><span> </span><span id="span_77_1425">r</span><span class="symbol" id="span_77_1426">)</span><span> </span><span class="symbol" id="span_77_1427">-&gt;</span><span class="comment">
        </span><span id="span_77_1430">pos&#39;</span><span> </span><span class="symbol" id="span_77_1431">=</span><span> </span><span id="span_77_1432">pos</span><span> </span><span class="symbol" id="span_77_1433">-</span><span> </span><span id="span_77_1435">spherePos</span><span class="comment">
        </span><span id="span_77_1437">max</span><span> </span><span class="symbol" id="span_77_1440">(</span><span id="span_77_1441">length</span><span> </span><span id="span_77_1443">pos&#39;</span><span> </span><span class="symbol" id="span_77_1444">-</span><span> </span><span id="span_77_1446">r</span><span class="symbol" id="span_77_1447">)</span><span> </span><span class="literal" id="span_77_1449">0.0</span><span class="comment">
    </span><span id="span_77_1450">Light</span><span class="symbol" id="span_77_1453">(</span><span id="span_77_1454">squarePos</span><span class="symbol" id="span_77_1455">,</span><span> </span><span id="span_77_1456">hw</span><span class="symbol" id="span_77_1457">,</span><span> </span><span class="symbol" id="span_77_1459">_</span><span class="symbol" id="span_77_1460">)</span><span> </span><span class="symbol" id="span_77_1461">-&gt;</span><span class="comment">
      </span><span id="span_77_1464">pos&#39;</span><span> </span><span class="symbol" id="span_77_1465">=</span><span> </span><span id="span_77_1466">pos</span><span> </span><span class="symbol" id="span_77_1467">-</span><span> </span><span id="span_77_1469">squarePos</span><span class="comment">
      </span><span id="span_77_1471">halfWidths</span><span> </span><span class="symbol" id="span_77_1472">=</span><span> </span><span class="symbol" id="span_77_1474">[</span><span id="span_77_1475">hw</span><span class="symbol" id="span_77_1476">,</span><span> </span><span class="literal" id="span_77_1477">0.01</span><span class="symbol" id="span_77_1478">,</span><span> </span><span id="span_77_1479">hw</span><span class="symbol" id="span_77_1480">]</span><span class="comment">
      </span><span id="span_77_1482">length</span><span> </span><span class="symbol" id="span_77_1483">$</span><span> </span><span class="keyword" id="span_77_1486">for</span><span> </span><span id="span_77_1487">i</span><span class="symbol" id="span_77_1488">:</span><span class="symbol" id="span_77_1491">(</span><span id="span_77_1492">Fin</span><span> </span><span class="literal" id="span_77_1494">3</span><span class="symbol" id="span_77_1495">)</span><span class="symbol" id="span_77_1496">.</span><span> </span><span id="span_77_1497">max</span><span> </span><span class="symbol" id="span_77_1500">(</span><span class="symbol" id="span_77_1502">(</span><span id="span_77_1503">abs</span><span> </span><span id="span_77_1505">pos&#39;</span><span class="symbol" id="span_77_1508">[</span><span id="span_77_1509">i</span><span class="symbol" id="span_77_1510">]</span><span class="symbol" id="span_77_1511">)</span><span> </span><span class="symbol" id="span_77_1512">-</span><span> </span><span id="span_77_1514">halfWidths</span><span class="symbol" id="span_77_1517">[</span><span id="span_77_1518">i</span><span class="symbol" id="span_77_1519">]</span><span class="symbol" id="span_77_1520">)</span><span> </span><span class="literal" id="span_77_1522">0.0</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_79_1524">def</span><span> </span><span id="span_79_1525">sdScene</span><span class="symbol" id="span_79_1527">(</span><span id="span_79_1528">scene</span><span class="symbol" id="span_79_1529">:</span><span id="span_79_1531">Scene</span><span> </span><span id="span_79_1533">n</span><span class="symbol" id="span_79_1534">,</span><span> </span><span id="span_79_1535">pos</span><span class="symbol" id="span_79_1536">:</span><span id="span_79_1538">Position</span><span class="symbol" id="span_79_1539">)</span><span> </span><span class="symbol" id="span_79_1540">-&gt;</span><span> </span><span class="symbol" id="span_79_1542">(</span><span id="span_79_1543">Object</span><span class="symbol" id="span_79_1544">,</span><span> </span><span id="span_79_1545">Distance</span><span class="symbol" id="span_79_1546">)</span><span> </span><span class="keyword" id="span_79_1547">given</span><span> </span><span class="symbol" id="span_79_1549">(</span><span id="span_79_1550">n</span><span class="symbol" id="span_79_1551">|</span><span id="span_79_1553">Ix</span><span class="symbol" id="span_79_1554">)</span><span> </span><span class="symbol" id="span_79_1555">=</span><span class="comment">
  </span><span class="symbol" id="span_79_1559">(</span><span id="span_79_1560">i</span><span class="symbol" id="span_79_1561">,</span><span> </span><span id="span_79_1562">d</span><span class="symbol" id="span_79_1563">)</span><span> </span><span class="symbol" id="span_79_1564">=</span><span> </span><span id="span_79_1565">minimum_by</span><span class="symbol" id="span_79_1568">(</span><span class="keyword" id="span_79_1570">for</span><span> </span><span id="span_79_1571">i</span><span class="symbol" id="span_79_1572">:</span><span id="span_79_1574">n</span><span class="symbol" id="span_79_1575">.</span><span> </span><span class="symbol" id="span_79_1577">(</span><span id="span_79_1578">i</span><span class="symbol" id="span_79_1579">,</span><span> </span><span id="span_79_1580">sdObject</span><span> </span><span id="span_79_1582">pos</span><span> </span><span id="span_79_1584">scene</span><span class="symbol" id="span_79_1586">.</span><span id="span_79_1587">objects</span><span class="symbol" id="span_79_1590">[</span><span id="span_79_1591">i</span><span class="symbol" id="span_79_1592">]</span><span class="symbol" id="span_79_1593">)</span><span class="symbol" id="span_79_1594">,</span><span> </span><span id="span_79_1595">snd</span><span class="symbol" id="span_79_1596">)</span><span class="comment">
  </span><span class="symbol" id="span_79_1599">(</span><span id="span_79_1600">scene</span><span class="symbol" id="span_79_1602">.</span><span id="span_79_1603">objects</span><span class="symbol" id="span_79_1606">[</span><span id="span_79_1607">i</span><span class="symbol" id="span_79_1608">]</span><span class="symbol" id="span_79_1609">,</span><span> </span><span id="span_79_1610">d</span><span class="symbol" id="span_79_1611">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_81_1613">def</span><span> </span><span id="span_81_1614">calcNormal</span><span class="symbol" id="span_81_1616">(</span><span id="span_81_1617">obj</span><span class="symbol" id="span_81_1618">:</span><span id="span_81_1620">Object</span><span class="symbol" id="span_81_1621">,</span><span> </span><span id="span_81_1622">pos</span><span class="symbol" id="span_81_1623">:</span><span id="span_81_1625">Position</span><span class="symbol" id="span_81_1626">)</span><span> </span><span class="symbol" id="span_81_1627">-&gt;</span><span> </span><span id="span_81_1628">Direction</span><span> </span><span class="symbol" id="span_81_1629">=</span><span class="comment">
  </span><span id="span_81_1632">grad</span><span class="symbol" id="span_81_1635">(</span><span class="symbol" id="span_81_1637">\</span><span id="span_81_1638">p</span><span class="symbol" id="span_81_1639">:</span><span id="span_81_1641">Position</span><span class="symbol" id="span_81_1642">.</span><span> </span><span id="span_81_1643">sdObject</span><span class="symbol" id="span_81_1646">(</span><span id="span_81_1647">p</span><span class="symbol" id="span_81_1648">,</span><span> </span><span id="span_81_1649">obj</span><span class="symbol" id="span_81_1650">)</span><span class="symbol" id="span_81_1651">)</span><span> </span><span id="span_81_1653">pos</span><span> </span><span class="symbol" id="span_81_1654">|</span><span> </span><span id="span_81_1656">normalize</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_83_1658">enum</span><span> </span><span id="span_83_1659">RayMarchResult</span><span> </span><span class="symbol" id="span_83_1660">=</span><span class="comment">
  # incident ray, surface normal, surface properties
  </span><span id="span_83_1661">HitObj</span><span class="symbol" id="span_83_1663">(</span><span id="span_83_1664">Ray</span><span class="symbol" id="span_83_1665">,</span><span> </span><span id="span_83_1666">OrientedSurface</span><span class="symbol" id="span_83_1667">)</span><span class="comment">
  </span><span id="span_83_1668">HitLight</span><span class="symbol" id="span_83_1670">(</span><span id="span_83_1671">Radiance</span><span class="symbol" id="span_83_1672">)</span><span class="comment">
  # Could refine with failure reason (beyond horizon, failed to converge etc)
  </span><span id="span_83_1673">HitNothing</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_85_1675">def</span><span> </span><span id="span_85_1676">raymarch</span><span class="symbol" id="span_85_1678">(</span><span id="span_85_1679">scene</span><span class="symbol" id="span_85_1680">:</span><span id="span_85_1682">Scene</span><span> </span><span id="span_85_1684">n</span><span class="symbol" id="span_85_1685">,</span><span> </span><span id="span_85_1686">ray</span><span class="symbol" id="span_85_1687">:</span><span id="span_85_1689">Ray</span><span class="symbol" id="span_85_1690">)</span><span> </span><span class="symbol" id="span_85_1691">-&gt;</span><span> </span><span id="span_85_1692">RayMarchResult</span><span> </span><span class="keyword" id="span_85_1693">given</span><span> </span><span class="symbol" id="span_85_1695">(</span><span id="span_85_1696">n</span><span class="symbol" id="span_85_1697">|</span><span id="span_85_1699">Ix</span><span class="symbol" id="span_85_1700">)</span><span> </span><span class="symbol" id="span_85_1701">=</span><span class="comment">
  </span><span id="span_85_1704">maxIters</span><span> </span><span class="symbol" id="span_85_1705">:</span><span> </span><span id="span_85_1707">Nat</span><span> </span><span class="symbol" id="span_85_1708">=</span><span> </span><span class="literal" id="span_85_1709">100</span><span class="comment">
  </span><span id="span_85_1711">tol</span><span> </span><span class="symbol" id="span_85_1712">=</span><span> </span><span class="literal" id="span_85_1713">0.01</span><span class="comment">
  </span><span id="span_85_1715">startLength</span><span> </span><span class="symbol" id="span_85_1716">=</span><span> </span><span class="literal" id="span_85_1717">10.0</span><span> </span><span class="symbol" id="span_85_1718">*</span><span> </span><span id="span_85_1720">tol</span><span class="comment">  # trying to escape the current surface
  </span><span id="span_85_1722">with_state</span><span> </span><span class="symbol" id="span_85_1725">(</span><span class="literal" id="span_85_1726">10.0</span><span> </span><span class="symbol" id="span_85_1727">*</span><span> </span><span id="span_85_1729">tol</span><span class="symbol" id="span_85_1730">)</span><span> </span><span class="symbol" id="span_85_1733">\</span><span id="span_85_1734">rayLength</span><span class="symbol" id="span_85_1735">.</span><span class="comment">
    </span><span id="span_85_1738">bounded_iter</span><span> </span><span id="span_85_1740">maxIters</span><span> </span><span id="span_85_1742">HitNothing</span><span> </span><span class="symbol" id="span_85_1745">\</span><span class="symbol" id="span_85_1747">_</span><span class="symbol" id="span_85_1748">.</span><span class="comment">
      </span><span id="span_85_1751">rayPos</span><span> </span><span class="symbol" id="span_85_1752">=</span><span> </span><span id="span_85_1753">ray</span><span class="symbol" id="span_85_1755">.</span><span id="span_85_1756">origin</span><span> </span><span class="symbol" id="span_85_1757">+</span><span> </span><span id="span_85_1759">get</span><span> </span><span id="span_85_1761">rayLength</span><span> </span><span class="symbol" id="span_85_1762">.*</span><span> </span><span id="span_85_1764">ray</span><span class="symbol" id="span_85_1766">.</span><span id="span_85_1767">dir</span><span class="comment">
      </span><span class="symbol" id="span_85_1770">(</span><span id="span_85_1771">obj</span><span class="symbol" id="span_85_1772">,</span><span> </span><span id="span_85_1773">d</span><span class="symbol" id="span_85_1774">)</span><span> </span><span class="symbol" id="span_85_1775">=</span><span> </span><span id="span_85_1776">sdScene</span><span> </span><span id="span_85_1778">scene</span><span> </span><span class="symbol" id="span_85_1779">$</span><span> </span><span id="span_85_1781">rayPos</span><span class="comment">
      # 0.9 ensures we come close to the surface but don&#39;t touch it
      </span><span id="span_85_1783">rayLength</span><span> </span><span class="symbol" id="span_85_1784">:=</span><span> </span><span id="span_85_1786">get</span><span> </span><span id="span_85_1788">rayLength</span><span> </span><span class="symbol" id="span_85_1789">+</span><span> </span><span class="literal" id="span_85_1791">0.9</span><span> </span><span class="symbol" id="span_85_1792">*</span><span> </span><span id="span_85_1794">d</span><span class="comment">
      </span><span class="keyword" id="span_85_1797">case</span><span> </span><span id="span_85_1798">d</span><span> </span><span class="symbol" id="span_85_1799">&lt;</span><span> </span><span id="span_85_1801">tol</span><span> </span><span class="keyword" id="span_85_1802">of</span><span class="comment">
        </span><span id="span_85_1803">False</span><span> </span><span class="symbol" id="span_85_1804">-&gt;</span><span> </span><span id="span_85_1805">Continue</span><span class="comment">
        </span><span id="span_85_1806">True</span><span> </span><span class="symbol" id="span_85_1807">-&gt;</span><span class="comment">
          </span><span id="span_85_1810">surfNorm</span><span> </span><span class="symbol" id="span_85_1811">=</span><span> </span><span id="span_85_1812">calcNormal</span><span> </span><span id="span_85_1814">obj</span><span> </span><span id="span_85_1816">rayPos</span><span class="comment">
          </span><span class="keyword" id="span_85_1819">case</span><span> </span><span id="span_85_1820">positiveProjection</span><span> </span><span id="span_85_1822">ray</span><span class="symbol" id="span_85_1824">.</span><span id="span_85_1825">dir</span><span> </span><span id="span_85_1827">surfNorm</span><span> </span><span class="keyword" id="span_85_1828">of</span><span class="comment">
            </span><span id="span_85_1829">True</span><span> </span><span class="symbol" id="span_85_1830">-&gt;</span><span class="comment">
              # Oops, we didn&#39;t escape the surface we&#39;re leaving..
              # (Is there a more standard way to do this?)
              </span><span id="span_85_1833">Continue</span><span class="comment">
            </span><span id="span_85_1834">False</span><span> </span><span class="symbol" id="span_85_1835">-&gt;</span><span class="comment">
              # We made it!
              </span><span id="span_85_1838">Done</span><span> </span><span class="symbol" id="span_85_1839">$</span><span> </span><span class="keyword" id="span_85_1842">case</span><span> </span><span id="span_85_1843">obj</span><span> </span><span class="keyword" id="span_85_1844">of</span><span class="comment">
                </span><span id="span_85_1845">PassiveObject</span><span class="symbol" id="span_85_1848">(</span><span class="symbol" id="span_85_1850">_</span><span class="symbol" id="span_85_1851">,</span><span> </span><span id="span_85_1852">surf</span><span class="symbol" id="span_85_1853">)</span><span> </span><span class="symbol" id="span_85_1854">-&gt;</span><span class="comment">
                  </span><span id="span_85_1857">newRay</span><span> </span><span class="symbol" id="span_85_1858">=</span><span> </span><span id="span_85_1859">Ray</span><span class="symbol" id="span_85_1862">(</span><span id="span_85_1863">rayPos</span><span class="symbol" id="span_85_1864">,</span><span> </span><span id="span_85_1865">ray</span><span class="symbol" id="span_85_1867">.</span><span id="span_85_1868">dir</span><span class="symbol" id="span_85_1869">)</span><span class="comment">
                  </span><span id="span_85_1871">HitObj</span><span class="symbol" id="span_85_1874">(</span><span id="span_85_1875">newRay</span><span class="symbol" id="span_85_1876">,</span><span> </span><span id="span_85_1877">OrientedSurface</span><span class="symbol" id="span_85_1880">(</span><span id="span_85_1881">surfNorm</span><span class="symbol" id="span_85_1882">,</span><span> </span><span id="span_85_1883">surf</span><span class="symbol" id="span_85_1884">)</span><span class="symbol" id="span_85_1885">)</span><span class="comment">
                </span><span id="span_85_1886">Light</span><span class="symbol" id="span_85_1889">(</span><span class="symbol" id="span_85_1891">_</span><span class="symbol" id="span_85_1892">,</span><span> </span><span class="symbol" id="span_85_1894">_</span><span class="symbol" id="span_85_1895">,</span><span> </span><span id="span_85_1896">radiance</span><span class="symbol" id="span_85_1897">)</span><span>  </span><span class="symbol" id="span_85_1898">-&gt;</span><span> </span><span id="span_85_1899">HitLight</span><span> </span><span id="span_85_1901">radiance</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_87_1903">def</span><span> </span><span id="span_87_1904">rayDirectRadiance</span><span class="symbol" id="span_87_1906">(</span><span id="span_87_1907">scene</span><span class="symbol" id="span_87_1908">:</span><span id="span_87_1910">Scene</span><span> </span><span id="span_87_1912">n</span><span class="symbol" id="span_87_1913">,</span><span> </span><span id="span_87_1914">ray</span><span class="symbol" id="span_87_1915">:</span><span id="span_87_1917">Ray</span><span class="symbol" id="span_87_1918">)</span><span> </span><span class="symbol" id="span_87_1919">-&gt;</span><span> </span><span id="span_87_1920">Radiance</span><span> </span><span class="keyword" id="span_87_1921">given</span><span> </span><span class="symbol" id="span_87_1923">(</span><span id="span_87_1924">n</span><span class="symbol" id="span_87_1925">|</span><span id="span_87_1927">Ix</span><span class="symbol" id="span_87_1928">)</span><span> </span><span class="symbol" id="span_87_1929">=</span><span class="comment">
  </span><span class="keyword" id="span_87_1933">case</span><span> </span><span id="span_87_1934">raymarch</span><span> </span><span id="span_87_1936">scene</span><span> </span><span id="span_87_1938">ray</span><span> </span><span class="keyword" id="span_87_1939">of</span><span class="comment">
    </span><span id="span_87_1940">HitLight</span><span> </span><span id="span_87_1942">intensity</span><span> </span><span class="symbol" id="span_87_1943">-&gt;</span><span> </span><span id="span_87_1944">intensity</span><span class="comment">
    </span><span id="span_87_1945">HitNothing</span><span> </span><span class="symbol" id="span_87_1946">-&gt;</span><span> </span><span id="span_87_1947">zero</span><span class="comment">
    </span><span id="span_87_1948">HitObj</span><span class="symbol" id="span_87_1951">(</span><span class="symbol" id="span_87_1953">_</span><span class="symbol" id="span_87_1954">,</span><span> </span><span class="symbol" id="span_87_1956">_</span><span class="symbol" id="span_87_1957">)</span><span> </span><span class="symbol" id="span_87_1958">-&gt;</span><span> </span><span id="span_87_1959">zero</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_89_1961">def</span><span> </span><span id="span_89_1962">sampleSquare</span><span class="symbol" id="span_89_1964">(</span><span id="span_89_1965">hw</span><span class="symbol" id="span_89_1966">:</span><span id="span_89_1968">Float</span><span class="symbol" id="span_89_1969">,</span><span> </span><span id="span_89_1970">k</span><span class="symbol" id="span_89_1971">:</span><span id="span_89_1973">Key</span><span class="symbol" id="span_89_1974">)</span><span> </span><span class="symbol" id="span_89_1975">-&gt;</span><span> </span><span id="span_89_1976">Position</span><span> </span><span class="symbol" id="span_89_1977">=</span><span class="comment">
 </span><span class="symbol" id="span_89_1981">[</span><span id="span_89_1982">kx</span><span class="symbol" id="span_89_1983">,</span><span> </span><span id="span_89_1984">kz</span><span class="symbol" id="span_89_1985">]</span><span> </span><span class="symbol" id="span_89_1986">:</span><span> </span><span id="span_89_1988">Fin</span><span> </span><span class="literal" id="span_89_1990">2</span><span> </span><span class="symbol" id="span_89_1991">=&gt;</span><span> </span><span id="span_89_1993">Key</span><span> </span><span class="symbol" id="span_89_1994">=</span><span> </span><span id="span_89_1995">split_key</span><span> </span><span id="span_89_1997">k</span><span class="comment">
 </span><span id="span_89_1999">x</span><span> </span><span class="symbol" id="span_89_2000">=</span><span> </span><span id="span_89_2001">randuniform</span><span> </span><span class="symbol" id="span_89_2004">(</span><span class="symbol" id="span_89_2005">-</span><span> </span><span id="span_89_2007">hw</span><span class="symbol" id="span_89_2008">)</span><span> </span><span id="span_89_2010">hw</span><span> </span><span id="span_89_2012">kx</span><span class="comment">
 </span><span id="span_89_2014">z</span><span> </span><span class="symbol" id="span_89_2015">=</span><span> </span><span id="span_89_2016">randuniform</span><span> </span><span class="symbol" id="span_89_2019">(</span><span class="symbol" id="span_89_2020">-</span><span> </span><span id="span_89_2022">hw</span><span class="symbol" id="span_89_2023">)</span><span> </span><span id="span_89_2025">hw</span><span> </span><span id="span_89_2027">kz</span><span class="comment">
 </span><span class="symbol" id="span_89_2030">[</span><span id="span_89_2031">x</span><span class="symbol" id="span_89_2032">,</span><span> </span><span class="literal" id="span_89_2033">0.0</span><span class="symbol" id="span_89_2034">,</span><span> </span><span id="span_89_2035">z</span><span class="symbol" id="span_89_2036">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_91_2038">def</span><span> </span><span id="span_91_2039">sampleLightRadiance</span><span class="symbol" id="span_91_2041">(</span><span class="comment">
    </span><span id="span_91_2042">scene</span><span class="symbol" id="span_91_2043">:</span><span id="span_91_2045">Scene</span><span> </span><span id="span_91_2047">n</span><span class="symbol" id="span_91_2048">,</span><span class="comment">
    </span><span id="span_91_2049">osurf</span><span class="symbol" id="span_91_2050">:</span><span id="span_91_2052">OrientedSurface</span><span class="symbol" id="span_91_2053">,</span><span class="comment">
    </span><span id="span_91_2054">inRay</span><span class="symbol" id="span_91_2055">:</span><span id="span_91_2057">Ray</span><span class="symbol" id="span_91_2058">,</span><span class="comment">
    </span><span id="span_91_2059">k</span><span class="symbol" id="span_91_2060">:</span><span id="span_91_2062">Key</span><span class="symbol" id="span_91_2063">)</span><span> </span><span class="symbol" id="span_91_2064">-&gt;</span><span> </span><span id="span_91_2065">Radiance</span><span> </span><span class="keyword" id="span_91_2066">given</span><span> </span><span class="symbol" id="span_91_2068">(</span><span id="span_91_2069">n</span><span class="symbol" id="span_91_2070">|</span><span id="span_91_2072">Ix</span><span class="symbol" id="span_91_2073">)</span><span> </span><span class="symbol" id="span_91_2074">=</span><span class="comment">
  </span><span id="span_91_2077">yield_accum</span><span> </span><span class="symbol" id="span_91_2080">(</span><span id="span_91_2081">AddMonoid</span><span> </span><span id="span_91_2083">Float</span><span class="symbol" id="span_91_2084">)</span><span> </span><span class="symbol" id="span_91_2087">\</span><span id="span_91_2088">radiance</span><span class="symbol" id="span_91_2089">.</span><span class="comment">
    </span><span id="span_91_2092">each</span><span> </span><span id="span_91_2094">scene</span><span class="symbol" id="span_91_2096">.</span><span id="span_91_2097">objects</span><span> </span><span class="symbol" id="span_91_2100">\</span><span id="span_91_2101">obj</span><span class="symbol" id="span_91_2102">.</span><span> </span><span class="keyword" id="span_91_2104">case</span><span> </span><span id="span_91_2105">obj</span><span> </span><span class="keyword" id="span_91_2106">of</span><span class="comment">
      </span><span id="span_91_2107">PassiveObject</span><span class="symbol" id="span_91_2110">(</span><span class="symbol" id="span_91_2112">_</span><span class="symbol" id="span_91_2113">,</span><span> </span><span class="symbol" id="span_91_2115">_</span><span class="symbol" id="span_91_2116">)</span><span> </span><span class="symbol" id="span_91_2117">-&gt;</span><span> </span><span class="symbol" id="span_91_2119">(</span><span class="symbol" id="span_91_2120">)</span><span class="comment">
      </span><span id="span_91_2121">Light</span><span class="symbol" id="span_91_2124">(</span><span id="span_91_2125">lightPos</span><span class="symbol" id="span_91_2126">,</span><span> </span><span id="span_91_2127">hw</span><span class="symbol" id="span_91_2128">,</span><span> </span><span class="symbol" id="span_91_2130">_</span><span class="symbol" id="span_91_2131">)</span><span> </span><span class="symbol" id="span_91_2132">-&gt;</span><span class="comment">
        </span><span class="symbol" id="span_91_2136">(</span><span id="span_91_2137">dirToLight</span><span class="symbol" id="span_91_2138">,</span><span> </span><span id="span_91_2139">distToLight</span><span class="symbol" id="span_91_2140">)</span><span> </span><span class="symbol" id="span_91_2141">=</span><span> </span><span id="span_91_2142">directionAndLength</span><span> </span><span class="symbol" id="span_91_2143">$</span><span class="comment">
                                      </span><span id="span_91_2145">lightPos</span><span> </span><span class="symbol" id="span_91_2146">+</span><span> </span><span id="span_91_2148">sampleSquare</span><span> </span><span id="span_91_2150">hw</span><span> </span><span id="span_91_2152">k</span><span> </span><span class="symbol" id="span_91_2153">-</span><span> </span><span id="span_91_2155">inRay</span><span class="symbol" id="span_91_2157">.</span><span id="span_91_2158">origin</span><span class="comment">
        </span><span class="keyword" id="span_91_2161">if</span><span> </span><span id="span_91_2162">positiveProjection</span><span> </span><span id="span_91_2164">dirToLight</span><span> </span><span id="span_91_2166">osurf</span><span class="symbol" id="span_91_2168">.</span><span id="span_91_2169">normal</span><span> </span><span class="keyword" id="span_91_2170">then</span><span class="comment">
          # light on this far side of current surface
          </span><span id="span_91_2173">fracSolidAngle</span><span> </span><span class="symbol" id="span_91_2174">=</span><span> </span><span class="symbol" id="span_91_2176">(</span><span id="span_91_2177">relu</span><span> </span><span class="symbol" id="span_91_2178">$</span><span> </span><span id="span_91_2180">dot</span><span> </span><span id="span_91_2182">dirToLight</span><span> </span><span id="span_91_2184">yHat</span><span class="symbol" id="span_91_2185">)</span><span> </span><span class="symbol" id="span_91_2186">*</span><span> </span><span id="span_91_2188">sq</span><span> </span><span id="span_91_2190">hw</span><span> </span><span class="symbol" id="span_91_2191">/</span><span> </span><span class="symbol" id="span_91_2194">(</span><span id="span_91_2195">pi</span><span> </span><span class="symbol" id="span_91_2196">*</span><span> </span><span id="span_91_2198">sq</span><span> </span><span id="span_91_2200">distToLight</span><span class="symbol" id="span_91_2201">)</span><span class="comment">
          </span><span id="span_91_2203">outRay</span><span> </span><span class="symbol" id="span_91_2204">=</span><span> </span><span id="span_91_2205">Ray</span><span class="symbol" id="span_91_2208">(</span><span id="span_91_2209">inRay</span><span class="symbol" id="span_91_2211">.</span><span id="span_91_2212">origin</span><span class="symbol" id="span_91_2213">,</span><span> </span><span id="span_91_2214">dirToLight</span><span class="symbol" id="span_91_2215">)</span><span class="comment">
          </span><span id="span_91_2217">coeff</span><span> </span><span class="symbol" id="span_91_2218">=</span><span> </span><span id="span_91_2219">fracSolidAngle</span><span> </span><span class="symbol" id="span_91_2220">*</span><span> </span><span id="span_91_2222">probReflection</span><span> </span><span id="span_91_2224">osurf</span><span> </span><span id="span_91_2226">inRay</span><span> </span><span id="span_91_2228">outRay</span><span class="comment">
          </span><span id="span_91_2230">radiance</span><span> </span><span class="symbol" id="span_91_2231">+=</span><span> </span><span id="span_91_2233">coeff</span><span> </span><span class="symbol" id="span_91_2234">.*</span><span> </span><span id="span_91_2236">rayDirectRadiance</span><span> </span><span id="span_91_2238">scene</span><span> </span><span id="span_91_2240">outRay</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_93_2242">def</span><span> </span><span id="span_93_2243">trace</span><span class="symbol" id="span_93_2245">(</span><span id="span_93_2246">params</span><span class="symbol" id="span_93_2247">:</span><span id="span_93_2249">Params</span><span class="symbol" id="span_93_2250">,</span><span> </span><span id="span_93_2251">scene</span><span class="symbol" id="span_93_2252">:</span><span id="span_93_2254">Scene</span><span> </span><span id="span_93_2256">n</span><span class="symbol" id="span_93_2257">,</span><span> </span><span id="span_93_2258">initRay</span><span class="symbol" id="span_93_2259">:</span><span id="span_93_2261">Ray</span><span class="symbol" id="span_93_2262">,</span><span> </span><span id="span_93_2263">k</span><span class="symbol" id="span_93_2264">:</span><span id="span_93_2266">Key</span><span class="symbol" id="span_93_2267">)</span><span> </span><span class="symbol" id="span_93_2268">-&gt;</span><span> </span><span id="span_93_2269">Color</span><span> </span><span class="keyword" id="span_93_2270">given</span><span> </span><span class="symbol" id="span_93_2272">(</span><span id="span_93_2273">n</span><span class="symbol" id="span_93_2274">|</span><span id="span_93_2276">Ix</span><span class="symbol" id="span_93_2277">)</span><span> </span><span class="symbol" id="span_93_2278">=</span><span class="comment">
  </span><span id="span_93_2281">noFilter</span><span> </span><span class="symbol" id="span_93_2282">=</span><span> </span><span class="symbol" id="span_93_2284">[</span><span class="literal" id="span_93_2285">1.0</span><span class="symbol" id="span_93_2286">,</span><span> </span><span class="literal" id="span_93_2287">1.0</span><span class="symbol" id="span_93_2288">,</span><span> </span><span class="literal" id="span_93_2289">1.0</span><span class="symbol" id="span_93_2290">]</span><span class="comment">
  </span><span id="span_93_2292">yield_accum</span><span> </span><span class="symbol" id="span_93_2295">(</span><span id="span_93_2296">AddMonoid</span><span> </span><span id="span_93_2298">Float</span><span class="symbol" id="span_93_2299">)</span><span> </span><span class="symbol" id="span_93_2302">\</span><span id="span_93_2303">radiance</span><span class="symbol" id="span_93_2304">.</span><span class="comment">
    </span><span id="span_93_2307">run_state</span><span>  </span><span id="span_93_2309">noFilter</span><span> </span><span class="symbol" id="span_93_2312">\</span><span id="span_93_2313">filter</span><span class="symbol" id="span_93_2314">.</span><span class="comment">
     </span><span id="span_93_2317">run_state</span><span> </span><span id="span_93_2319">initRay</span><span>  </span><span class="symbol" id="span_93_2322">\</span><span id="span_93_2323">ray</span><span class="symbol" id="span_93_2324">.</span><span class="comment">
      </span><span id="span_93_2327">bounded_iter</span><span> </span><span id="span_93_2329">params</span><span class="symbol" id="span_93_2331">.</span><span id="span_93_2332">maxBounces</span><span> </span><span class="symbol" id="span_93_2335">(</span><span class="symbol" id="span_93_2336">)</span><span> </span><span class="symbol" id="span_93_2339">\</span><span id="span_93_2340">i</span><span class="symbol" id="span_93_2341">.</span><span class="comment">
        </span><span class="keyword" id="span_93_2345">case</span><span> </span><span id="span_93_2346">raymarch</span><span> </span><span id="span_93_2348">scene</span><span> </span><span class="symbol" id="span_93_2349">$</span><span> </span><span id="span_93_2351">get</span><span> </span><span id="span_93_2353">ray</span><span> </span><span class="keyword" id="span_93_2354">of</span><span class="comment">
          </span><span id="span_93_2355">HitNothing</span><span> </span><span class="symbol" id="span_93_2356">-&gt;</span><span> </span><span id="span_93_2357">Done</span><span> </span><span class="symbol" id="span_93_2360">(</span><span class="symbol" id="span_93_2361">)</span><span class="comment">
          </span><span id="span_93_2362">HitLight</span><span> </span><span id="span_93_2364">intensity</span><span> </span><span class="symbol" id="span_93_2365">-&gt;</span><span class="comment">
            </span><span class="keyword" id="span_93_2369">if</span><span> </span><span id="span_93_2370">i</span><span> </span><span class="symbol" id="span_93_2371">==</span><span> </span><span class="literal" id="span_93_2373">0</span><span> </span><span class="keyword" id="span_93_2374">then</span><span> </span><span id="span_93_2375">radiance</span><span> </span><span class="symbol" id="span_93_2376">+=</span><span> </span><span id="span_93_2378">intensity</span><span class="comment">   # TODO: scale etc
            </span><span id="span_93_2380">Done</span><span> </span><span class="symbol" id="span_93_2383">(</span><span class="symbol" id="span_93_2384">)</span><span class="comment">
          </span><span id="span_93_2385">HitObj</span><span class="symbol" id="span_93_2388">(</span><span id="span_93_2389">incidentRay</span><span class="symbol" id="span_93_2390">,</span><span> </span><span id="span_93_2391">osurf</span><span class="symbol" id="span_93_2392">)</span><span> </span><span class="symbol" id="span_93_2393">-&gt;</span><span class="comment">
            </span><span class="symbol" id="span_93_2397">[</span><span id="span_93_2398">k1</span><span class="symbol" id="span_93_2399">,</span><span> </span><span id="span_93_2400">k2</span><span class="symbol" id="span_93_2401">]</span><span> </span><span class="symbol" id="span_93_2402">=</span><span> </span><span id="span_93_2403">split_key</span><span class="symbol" id="span_93_2406">(</span><span id="span_93_2407">n</span><span class="symbol" id="span_93_2408">=</span><span class="literal" id="span_93_2410">2</span><span class="symbol" id="span_93_2411">,</span><span> </span><span id="span_93_2412">hash</span><span> </span><span id="span_93_2414">k</span><span> </span><span id="span_93_2416">i</span><span class="symbol" id="span_93_2417">)</span><span class="comment">
            </span><span id="span_93_2419">lightRadiance</span><span> </span><span class="symbol" id="span_93_2420">=</span><span> </span><span id="span_93_2421">sampleLightRadiance</span><span> </span><span id="span_93_2423">scene</span><span> </span><span id="span_93_2425">osurf</span><span> </span><span id="span_93_2427">incidentRay</span><span> </span><span id="span_93_2429">k1</span><span class="comment">
            </span><span id="span_93_2431">ray</span><span>    </span><span class="symbol" id="span_93_2432">:=</span><span> </span><span id="span_93_2434">sampleReflection</span><span> </span><span id="span_93_2436">osurf</span><span> </span><span id="span_93_2438">incidentRay</span><span> </span><span id="span_93_2440">k2</span><span class="comment">
            </span><span id="span_93_2442">filter</span><span> </span><span class="symbol" id="span_93_2443">:=</span><span> </span><span id="span_93_2445">surfaceFilter</span><span> </span><span class="symbol" id="span_93_2448">(</span><span id="span_93_2449">get</span><span> </span><span id="span_93_2451">filter</span><span class="symbol" id="span_93_2452">)</span><span> </span><span id="span_93_2454">osurf</span><span class="symbol" id="span_93_2456">.</span><span id="span_93_2457">surface</span><span class="comment">
            </span><span id="span_93_2459">radiance</span><span> </span><span class="symbol" id="span_93_2460">+=</span><span> </span><span id="span_93_2462">applyFilter</span><span> </span><span class="symbol" id="span_93_2465">(</span><span id="span_93_2466">get</span><span> </span><span id="span_93_2468">filter</span><span class="symbol" id="span_93_2469">)</span><span> </span><span id="span_93_2471">lightRadiance</span><span class="comment">
            </span><span id="span_93_2473">Continue</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># Assumes we&#39;re looking towards -z.
</span></div>
<div class="code-block"><span class="keyword" id="span_96_2475">struct</span><span> </span><span id="span_96_2476">Camera</span><span> </span><span class="symbol" id="span_96_2477">=</span><span class="comment">
  </span><span id="span_96_2478">numPix</span><span>     </span><span class="symbol" id="span_96_2479">:</span><span> </span><span id="span_96_2480">Nat</span><span class="comment">
  </span><span id="span_96_2481">pos</span><span>        </span><span class="symbol" id="span_96_2482">:</span><span> </span><span id="span_96_2483">Position</span><span class="comment">  # pinhole position
  </span><span id="span_96_2484">halfWidth</span><span>  </span><span class="symbol" id="span_96_2485">:</span><span> </span><span id="span_96_2486">Float</span><span class="comment">     # sensor half-width
  </span><span id="span_96_2487">sensorDist</span><span> </span><span class="symbol" id="span_96_2488">:</span><span> </span><span id="span_96_2489">Float</span><span class="comment">     # pinhole-sensor distance
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># TODO: might be better with an anonymous dependent pair for the result
</span></div>
<div class="code-block"><span class="keyword" id="span_99_2491">def</span><span> </span><span id="span_99_2492">cameraRays</span><span class="symbol" id="span_99_2494">(</span><span id="span_99_2495">n</span><span class="symbol" id="span_99_2496">:</span><span id="span_99_2498">Nat</span><span class="symbol" id="span_99_2499">,</span><span> </span><span id="span_99_2500">camera</span><span class="symbol" id="span_99_2501">:</span><span id="span_99_2503">Camera</span><span class="symbol" id="span_99_2504">)</span><span> </span><span class="symbol" id="span_99_2505">-&gt;</span><span> </span><span id="span_99_2506">Fin</span><span> </span><span id="span_99_2508">n</span><span> </span><span class="symbol" id="span_99_2509">=&gt;</span><span> </span><span id="span_99_2511">Fin</span><span> </span><span id="span_99_2513">n</span><span> </span><span class="symbol" id="span_99_2514">=&gt;</span><span> </span><span class="symbol" id="span_99_2517">(</span><span class="symbol" id="span_99_2519">(</span><span id="span_99_2520">Key</span><span class="symbol" id="span_99_2521">)</span><span> </span><span class="symbol" id="span_99_2522">-&gt;</span><span> </span><span id="span_99_2524">Ray</span><span class="symbol" id="span_99_2525">)</span><span> </span><span class="symbol" id="span_99_2526">=</span><span class="comment">
  # images indexed from top-left
  </span><span id="span_99_2529">halfWidth</span><span> </span><span class="symbol" id="span_99_2530">=</span><span> </span><span id="span_99_2531">camera</span><span class="symbol" id="span_99_2533">.</span><span id="span_99_2534">halfWidth</span><span class="comment">
  </span><span id="span_99_2536">pixHalfWidth</span><span> </span><span class="symbol" id="span_99_2537">=</span><span> </span><span id="span_99_2538">halfWidth</span><span> </span><span class="symbol" id="span_99_2539">/</span><span> </span><span id="span_99_2541">n_to_f</span><span> </span><span id="span_99_2543">n</span><span class="comment">
  </span><span id="span_99_2545">ys</span><span> </span><span class="symbol" id="span_99_2546">=</span><span> </span><span id="span_99_2547">reverse</span><span> </span><span class="symbol" id="span_99_2548">$</span><span> </span><span id="span_99_2550">linspace</span><span> </span><span class="symbol" id="span_99_2553">(</span><span id="span_99_2554">Fin</span><span> </span><span id="span_99_2556">n</span><span class="symbol" id="span_99_2557">)</span><span> </span><span class="symbol" id="span_99_2560">(</span><span id="span_99_2561">neg</span><span> </span><span id="span_99_2563">halfWidth</span><span class="symbol" id="span_99_2564">)</span><span> </span><span id="span_99_2566">halfWidth</span><span class="comment">
  </span><span id="span_99_2568">xs</span><span> </span><span class="symbol" id="span_99_2569">=</span><span>           </span><span id="span_99_2570">linspace</span><span> </span><span class="symbol" id="span_99_2573">(</span><span id="span_99_2574">Fin</span><span> </span><span id="span_99_2576">n</span><span class="symbol" id="span_99_2577">)</span><span> </span><span class="symbol" id="span_99_2580">(</span><span id="span_99_2581">neg</span><span> </span><span id="span_99_2583">halfWidth</span><span class="symbol" id="span_99_2584">)</span><span> </span><span id="span_99_2586">halfWidth</span><span class="comment">
  </span><span class="keyword" id="span_99_2589">for</span><span> </span><span id="span_99_2590">i</span><span class="symbol" id="span_99_2591">:</span><span class="symbol" id="span_99_2594">(</span><span id="span_99_2595">Fin</span><span> </span><span id="span_99_2597">n</span><span class="symbol" id="span_99_2598">)</span><span> </span><span id="span_99_2599">j</span><span class="symbol" id="span_99_2600">:</span><span class="symbol" id="span_99_2603">(</span><span id="span_99_2604">Fin</span><span> </span><span id="span_99_2606">n</span><span class="symbol" id="span_99_2607">)</span><span class="symbol" id="span_99_2608">.</span><span> </span><span class="symbol" id="span_99_2610">\</span><span id="span_99_2611">key</span><span class="symbol" id="span_99_2612">.</span><span class="comment">
    </span><span class="symbol" id="span_99_2616">[</span><span id="span_99_2617">kx</span><span class="symbol" id="span_99_2618">,</span><span> </span><span id="span_99_2619">ky</span><span class="symbol" id="span_99_2620">]</span><span> </span><span class="symbol" id="span_99_2621">=</span><span> </span><span id="span_99_2622">split_key</span><span class="symbol" id="span_99_2625">(</span><span id="span_99_2626">n</span><span class="symbol" id="span_99_2627">=</span><span class="literal" id="span_99_2629">2</span><span class="symbol" id="span_99_2630">,</span><span> </span><span id="span_99_2631">key</span><span class="symbol" id="span_99_2632">)</span><span class="comment">
    </span><span id="span_99_2634">x</span><span> </span><span class="symbol" id="span_99_2635">=</span><span> </span><span id="span_99_2636">xs</span><span class="symbol" id="span_99_2639">[</span><span id="span_99_2640">j</span><span class="symbol" id="span_99_2641">]</span><span> </span><span class="symbol" id="span_99_2642">+</span><span> </span><span id="span_99_2644">randuniform</span><span> </span><span class="symbol" id="span_99_2647">(</span><span class="symbol" id="span_99_2648">-</span><span id="span_99_2650">pixHalfWidth</span><span class="symbol" id="span_99_2651">)</span><span> </span><span id="span_99_2653">pixHalfWidth</span><span> </span><span id="span_99_2655">kx</span><span class="comment">
    </span><span id="span_99_2657">y</span><span> </span><span class="symbol" id="span_99_2658">=</span><span> </span><span id="span_99_2659">ys</span><span class="symbol" id="span_99_2662">[</span><span id="span_99_2663">i</span><span class="symbol" id="span_99_2664">]</span><span> </span><span class="symbol" id="span_99_2665">+</span><span> </span><span id="span_99_2667">randuniform</span><span> </span><span class="symbol" id="span_99_2670">(</span><span class="symbol" id="span_99_2671">-</span><span id="span_99_2673">pixHalfWidth</span><span class="symbol" id="span_99_2674">)</span><span> </span><span id="span_99_2676">pixHalfWidth</span><span> </span><span id="span_99_2678">ky</span><span class="comment">
    </span><span id="span_99_2680">Ray</span><span class="symbol" id="span_99_2683">(</span><span id="span_99_2684">camera</span><span class="symbol" id="span_99_2686">.</span><span id="span_99_2687">pos</span><span class="symbol" id="span_99_2688">,</span><span> </span><span id="span_99_2689">normalize</span><span> </span><span class="symbol" id="span_99_2692">[</span><span id="span_99_2693">x</span><span class="symbol" id="span_99_2694">,</span><span> </span><span id="span_99_2695">y</span><span class="symbol" id="span_99_2696">,</span><span> </span><span id="span_99_2697">neg</span><span> </span><span id="span_99_2699">camera</span><span class="symbol" id="span_99_2701">.</span><span id="span_99_2702">sensorDist</span><span class="symbol" id="span_99_2703">]</span><span class="symbol" id="span_99_2704">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="keyword" id="span_101_2706">def</span><span> </span><span id="span_101_2707">takePicture</span><span class="symbol" id="span_101_2709">(</span><span id="span_101_2710">params</span><span class="symbol" id="span_101_2711">:</span><span id="span_101_2713">Params</span><span class="symbol" id="span_101_2714">,</span><span> </span><span id="span_101_2715">scene</span><span class="symbol" id="span_101_2716">:</span><span id="span_101_2718">Scene</span><span> </span><span id="span_101_2720">m</span><span class="symbol" id="span_101_2721">,</span><span> </span><span id="span_101_2722">camera</span><span class="symbol" id="span_101_2723">:</span><span id="span_101_2725">Camera</span><span class="symbol" id="span_101_2726">)</span><span> </span><span class="symbol" id="span_101_2727">-&gt;</span><span> </span><span id="span_101_2728">Image</span><span> </span><span class="keyword" id="span_101_2729">given</span><span> </span><span class="symbol" id="span_101_2731">(</span><span id="span_101_2732">m</span><span class="symbol" id="span_101_2733">|</span><span id="span_101_2735">Ix</span><span class="symbol" id="span_101_2736">)</span><span> </span><span class="symbol" id="span_101_2737">=</span><span class="comment">
  </span><span id="span_101_2740">rays</span><span> </span><span class="symbol" id="span_101_2741">=</span><span> </span><span id="span_101_2742">cameraRays</span><span> </span><span id="span_101_2744">camera</span><span class="symbol" id="span_101_2746">.</span><span id="span_101_2747">numPix</span><span> </span><span id="span_101_2749">camera</span><span class="comment">
  </span><span id="span_101_2751">rootKey</span><span> </span><span class="symbol" id="span_101_2752">=</span><span> </span><span id="span_101_2753">new_key</span><span> </span><span class="literal" id="span_101_2755">0</span><span class="comment">
  </span><span id="span_101_2757">image</span><span> </span><span class="symbol" id="span_101_2758">=</span><span> </span><span class="keyword" id="span_101_2760">for</span><span> </span><span id="span_101_2761">i</span><span class="symbol" id="span_101_2762">:</span><span class="symbol" id="span_101_2765">(</span><span id="span_101_2766">Fin</span><span> </span><span id="span_101_2768">camera</span><span class="symbol" id="span_101_2770">.</span><span id="span_101_2771">numPix</span><span class="symbol" id="span_101_2772">)</span><span> </span><span id="span_101_2773">j</span><span class="symbol" id="span_101_2774">:</span><span class="symbol" id="span_101_2777">(</span><span id="span_101_2778">Fin</span><span> </span><span id="span_101_2780">camera</span><span class="symbol" id="span_101_2782">.</span><span id="span_101_2783">numPix</span><span class="symbol" id="span_101_2784">)</span><span class="symbol" id="span_101_2785">.</span><span class="comment">
    </span><span id="span_101_2788">pixKey</span><span> </span><span class="symbol" id="span_101_2789">=</span><span> </span><span class="keyword" id="span_101_2791">if</span><span> </span><span id="span_101_2792">params</span><span class="symbol" id="span_101_2794">.</span><span id="span_101_2795">shareSeed</span><span class="comment">
      </span><span class="keyword" id="span_101_2796">then</span><span> </span><span id="span_101_2797">rootKey</span><span class="comment">
      </span><span class="keyword" id="span_101_2798">else</span><span> </span><span id="span_101_2799">ixkey</span><span> </span><span class="symbol" id="span_101_2802">(</span><span id="span_101_2803">ixkey</span><span> </span><span id="span_101_2805">rootKey</span><span> </span><span id="span_101_2807">i</span><span class="symbol" id="span_101_2808">)</span><span> </span><span id="span_101_2810">j</span><span class="comment">
    </span><span class="keyword" id="span_101_2812">def</span><span> </span><span id="span_101_2813">sampleRayColor</span><span class="symbol" id="span_101_2815">(</span><span id="span_101_2816">k</span><span class="symbol" id="span_101_2817">:</span><span id="span_101_2819">Key</span><span class="symbol" id="span_101_2820">)</span><span> </span><span class="symbol" id="span_101_2821">-&gt;</span><span> </span><span id="span_101_2822">Color</span><span> </span><span class="symbol" id="span_101_2823">=</span><span class="comment">
      </span><span class="symbol" id="span_101_2827">[</span><span id="span_101_2828">k1</span><span class="symbol" id="span_101_2829">,</span><span> </span><span id="span_101_2830">k2</span><span class="symbol" id="span_101_2831">]</span><span> </span><span class="symbol" id="span_101_2832">=</span><span> </span><span id="span_101_2833">split_key</span><span class="symbol" id="span_101_2836">(</span><span id="span_101_2837">n</span><span class="symbol" id="span_101_2838">=</span><span class="literal" id="span_101_2840">2</span><span class="symbol" id="span_101_2841">,</span><span> </span><span id="span_101_2842">k</span><span class="symbol" id="span_101_2843">)</span><span class="comment">
      </span><span id="span_101_2845">trace</span><span> </span><span id="span_101_2847">params</span><span> </span><span id="span_101_2849">scene</span><span> </span><span class="symbol" id="span_101_2852">(</span><span id="span_101_2853">rays</span><span class="symbol" id="span_101_2856">[</span><span id="span_101_2857">i</span><span class="symbol" id="span_101_2858">,</span><span id="span_101_2859">j</span><span class="symbol" id="span_101_2860">]</span><span> </span><span id="span_101_2862">k1</span><span class="symbol" id="span_101_2863">)</span><span> </span><span id="span_101_2865">k2</span><span class="comment">
    </span><span id="span_101_2867">sampleAveraged</span><span> </span><span id="span_101_2869">sampleRayColor</span><span> </span><span id="span_101_2871">params</span><span class="symbol" id="span_101_2873">.</span><span id="span_101_2874">numSamples</span><span> </span><span id="span_101_2876">pixKey</span><span class="comment">
  </span><span id="span_101_2878">MkImage</span><span> </span><span class="symbol" id="span_101_2881">_</span><span> </span><span class="symbol" id="span_101_2884">_</span><span> </span><span class="symbol" id="span_101_2885">$</span><span> </span><span id="span_101_2887">image</span><span> </span><span class="symbol" id="span_101_2888">/</span><span> </span><span id="span_101_2890">mean</span><span class="symbol" id="span_101_2893">(</span><span id="span_101_2894">flatten3D</span><span class="symbol" id="span_101_2897">(</span><span id="span_101_2898">image</span><span class="symbol" id="span_101_2899">)</span><span class="symbol" id="span_101_2900">)</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="prose-block"><h2>Define the scene and render it</h2>
</div>
<div class="code-block"><span id="span_104_2902">lightColor</span><span> </span><span class="symbol" id="span_104_2903">=</span><span> </span><span class="symbol" id="span_104_2905">[</span><span class="literal" id="span_104_2906">0.2</span><span class="symbol" id="span_104_2907">,</span><span> </span><span class="literal" id="span_104_2908">0.2</span><span class="symbol" id="span_104_2909">,</span><span> </span><span class="literal" id="span_104_2910">0.2</span><span class="symbol" id="span_104_2911">]</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_105_2913">leftWallColor</span><span>  </span><span class="symbol" id="span_105_2914">=</span><span> </span><span class="literal" id="span_105_2915">1.5</span><span> </span><span class="symbol" id="span_105_2916">.*</span><span> </span><span class="symbol" id="span_105_2919">[</span><span class="literal" id="span_105_2920">0.611</span><span class="symbol" id="span_105_2921">,</span><span> </span><span class="literal" id="span_105_2922">0.0555</span><span class="symbol" id="span_105_2923">,</span><span> </span><span class="literal" id="span_105_2924">0.062</span><span class="symbol" id="span_105_2925">]</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_106_2927">rightWallColor</span><span> </span><span class="symbol" id="span_106_2928">=</span><span> </span><span class="literal" id="span_106_2929">1.5</span><span> </span><span class="symbol" id="span_106_2930">.*</span><span> </span><span class="symbol" id="span_106_2933">[</span><span class="literal" id="span_106_2934">0.117</span><span class="symbol" id="span_106_2935">,</span><span> </span><span class="literal" id="span_106_2936">0.4125</span><span class="symbol" id="span_106_2937">,</span><span> </span><span class="literal" id="span_106_2938">0.115</span><span class="symbol" id="span_106_2939">]</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_107_2941">whiteWallColor</span><span> </span><span class="symbol" id="span_107_2942">=</span><span> </span><span class="symbol" id="span_107_2944">[</span><span class="literal" id="span_107_2945">255.0</span><span class="symbol" id="span_107_2946">,</span><span> </span><span class="literal" id="span_107_2947">239.0</span><span class="symbol" id="span_107_2948">,</span><span> </span><span class="literal" id="span_107_2949">196.0</span><span class="symbol" id="span_107_2950">]</span><span> </span><span class="symbol" id="span_107_2951">/</span><span> </span><span class="literal" id="span_107_2953">255.0</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_108_2955">blockColor</span><span>     </span><span class="symbol" id="span_108_2956">=</span><span> </span><span class="symbol" id="span_108_2958">[</span><span class="literal" id="span_108_2959">200.0</span><span class="symbol" id="span_108_2960">,</span><span> </span><span class="literal" id="span_108_2961">200.0</span><span class="symbol" id="span_108_2962">,</span><span> </span><span class="literal" id="span_108_2963">255.0</span><span class="symbol" id="span_108_2964">]</span><span> </span><span class="symbol" id="span_108_2965">/</span><span> </span><span class="literal" id="span_108_2967">255.0</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_110_2969">theScene</span><span> </span><span class="symbol" id="span_110_2970">=</span><span> </span><span id="span_110_2971">Scene</span><span> </span><span class="symbol" id="span_110_2972">$</span><span class="comment">
  </span><span class="symbol" id="span_110_2975">[</span><span> </span><span id="span_110_2976">Light</span><span> </span><span class="symbol" id="span_110_2979">(</span><span class="literal" id="span_110_2980">1.9</span><span> </span><span class="symbol" id="span_110_2981">.*</span><span> </span><span id="span_110_2983">yHat</span><span class="symbol" id="span_110_2984">)</span><span> </span><span class="literal" id="span_110_2986">0.5</span><span> </span><span id="span_110_2988">lightColor</span><span class="comment">
  </span><span class="symbol" id="span_110_2989">,</span><span> </span><span id="span_110_2990">PassiveObject</span><span> </span><span class="symbol" id="span_110_2993">(</span><span id="span_110_2994">Wall</span><span>      </span><span id="span_110_2996">xHat</span><span>  </span><span class="literal" id="span_110_2998">2.0</span><span class="symbol" id="span_110_2999">)</span><span> </span><span class="symbol" id="span_110_3002">(</span><span id="span_110_3003">Matte</span><span> </span><span id="span_110_3005">leftWallColor</span><span class="symbol" id="span_110_3006">)</span><span class="comment">
  </span><span class="symbol" id="span_110_3007">,</span><span> </span><span id="span_110_3008">PassiveObject</span><span> </span><span class="symbol" id="span_110_3011">(</span><span id="span_110_3012">Wall</span><span> </span><span class="symbol" id="span_110_3015">(</span><span id="span_110_3016">neg</span><span> </span><span id="span_110_3018">xHat</span><span class="symbol" id="span_110_3019">)</span><span> </span><span class="literal" id="span_110_3021">2.0</span><span class="symbol" id="span_110_3022">)</span><span> </span><span class="symbol" id="span_110_3025">(</span><span id="span_110_3026">Matte</span><span> </span><span id="span_110_3028">rightWallColor</span><span class="symbol" id="span_110_3029">)</span><span class="comment">
  </span><span class="symbol" id="span_110_3030">,</span><span> </span><span id="span_110_3031">PassiveObject</span><span> </span><span class="symbol" id="span_110_3034">(</span><span id="span_110_3035">Wall</span><span>      </span><span id="span_110_3037">yHat</span><span>  </span><span class="literal" id="span_110_3039">2.0</span><span class="symbol" id="span_110_3040">)</span><span> </span><span class="symbol" id="span_110_3043">(</span><span id="span_110_3044">Matte</span><span> </span><span id="span_110_3046">whiteWallColor</span><span class="symbol" id="span_110_3047">)</span><span class="comment">
  </span><span class="symbol" id="span_110_3048">,</span><span> </span><span id="span_110_3049">PassiveObject</span><span> </span><span class="symbol" id="span_110_3052">(</span><span id="span_110_3053">Wall</span><span> </span><span class="symbol" id="span_110_3056">(</span><span id="span_110_3057">neg</span><span> </span><span id="span_110_3059">yHat</span><span class="symbol" id="span_110_3060">)</span><span> </span><span class="literal" id="span_110_3062">2.0</span><span class="symbol" id="span_110_3063">)</span><span> </span><span class="symbol" id="span_110_3066">(</span><span id="span_110_3067">Matte</span><span> </span><span id="span_110_3069">whiteWallColor</span><span class="symbol" id="span_110_3070">)</span><span class="comment">
  </span><span class="symbol" id="span_110_3071">,</span><span> </span><span id="span_110_3072">PassiveObject</span><span> </span><span class="symbol" id="span_110_3075">(</span><span id="span_110_3076">Wall</span><span>      </span><span id="span_110_3078">zHat</span><span>  </span><span class="literal" id="span_110_3080">2.0</span><span class="symbol" id="span_110_3081">)</span><span> </span><span class="symbol" id="span_110_3084">(</span><span id="span_110_3085">Matte</span><span> </span><span id="span_110_3087">whiteWallColor</span><span class="symbol" id="span_110_3088">)</span><span class="comment">
  </span><span class="symbol" id="span_110_3089">,</span><span> </span><span id="span_110_3090">PassiveObject</span><span> </span><span class="symbol" id="span_110_3093">(</span><span id="span_110_3094">Block</span><span>  </span><span class="symbol" id="span_110_3097">[</span><span> </span><span class="literal" id="span_110_3098">1.0</span><span class="symbol" id="span_110_3099">,</span><span> </span><span class="symbol" id="span_110_3100">-</span><span class="literal" id="span_110_3102">1.6</span><span class="symbol" id="span_110_3103">,</span><span>  </span><span class="literal" id="span_110_3104">1.2</span><span class="symbol" id="span_110_3105">]</span><span> </span><span class="symbol" id="span_110_3108">[</span><span class="literal" id="span_110_3109">0.6</span><span class="symbol" id="span_110_3110">,</span><span> </span><span class="literal" id="span_110_3111">0.8</span><span class="symbol" id="span_110_3112">,</span><span> </span><span class="literal" id="span_110_3113">0.6</span><span class="symbol" id="span_110_3114">]</span><span> </span><span class="literal" id="span_110_3116">0.5</span><span class="symbol" id="span_110_3117">)</span><span> </span><span class="symbol" id="span_110_3120">(</span><span id="span_110_3121">Matte</span><span> </span><span id="span_110_3123">blockColor</span><span class="symbol" id="span_110_3124">)</span><span class="comment">
  </span><span class="symbol" id="span_110_3125">,</span><span> </span><span id="span_110_3126">PassiveObject</span><span> </span><span class="symbol" id="span_110_3129">(</span><span id="span_110_3130">Sphere</span><span> </span><span class="symbol" id="span_110_3133">[</span><span class="symbol" id="span_110_3134">-</span><span class="literal" id="span_110_3136">1.0</span><span class="symbol" id="span_110_3137">,</span><span> </span><span class="symbol" id="span_110_3138">-</span><span class="literal" id="span_110_3140">1.2</span><span class="symbol" id="span_110_3141">,</span><span>  </span><span class="literal" id="span_110_3142">0.2</span><span class="symbol" id="span_110_3143">]</span><span> </span><span class="literal" id="span_110_3145">0.8</span><span class="symbol" id="span_110_3146">)</span><span> </span><span class="symbol" id="span_110_3149">(</span><span id="span_110_3150">Matte</span><span> </span><span class="symbol" id="span_110_3153">(</span><span class="literal" id="span_110_3154">0.7</span><span class="symbol" id="span_110_3155">.*</span><span> </span><span id="span_110_3157">whiteWallColor</span><span class="symbol" id="span_110_3158">)</span><span class="symbol" id="span_110_3159">)</span><span class="comment">
  </span><span class="symbol" id="span_110_3160">,</span><span> </span><span id="span_110_3161">PassiveObject</span><span> </span><span class="symbol" id="span_110_3164">(</span><span id="span_110_3165">Sphere</span><span> </span><span class="symbol" id="span_110_3168">[</span><span> </span><span class="literal" id="span_110_3169">2.0</span><span class="symbol" id="span_110_3170">,</span><span>  </span><span class="literal" id="span_110_3171">2.0</span><span class="symbol" id="span_110_3172">,</span><span> </span><span class="symbol" id="span_110_3173">-</span><span class="literal" id="span_110_3175">2.0</span><span class="symbol" id="span_110_3176">]</span><span> </span><span class="literal" id="span_110_3178">1.5</span><span class="symbol" id="span_110_3179">)</span><span> </span><span class="symbol" id="span_110_3182">(</span><span id="span_110_3183">Mirror</span><span class="symbol" id="span_110_3184">)</span><span class="comment">
  </span><span class="symbol" id="span_110_3185">]</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_112_3187">defaultParams</span><span> </span><span class="symbol" id="span_112_3188">=</span><span> </span><span id="span_112_3189">Params</span><span> </span><span class="literal" id="span_112_3191">50</span><span> </span><span class="literal" id="span_112_3193">10</span><span> </span><span id="span_112_3195">True</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_114_3197">defaultCamera</span><span> </span><span class="symbol" id="span_114_3198">=</span><span> </span><span id="span_114_3199">Camera</span><span> </span><span class="literal" id="span_114_3201">250</span><span> </span><span class="symbol" id="span_114_3204">(</span><span class="literal" id="span_114_3205">10.0</span><span> </span><span class="symbol" id="span_114_3206">.*</span><span> </span><span id="span_114_3208">zHat</span><span class="symbol" id="span_114_3209">)</span><span> </span><span class="literal" id="span_114_3211">0.3</span><span> </span><span class="literal" id="span_114_3213">1.0</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span id="span_116_3215">testCamera</span><span> </span><span class="symbol" id="span_116_3216">=</span><span> </span><span id="span_116_3217">Camera</span><span> </span><span class="literal" id="span_116_3219">10</span><span> </span><span class="symbol" id="span_116_3222">(</span><span class="literal" id="span_116_3223">10.0</span><span> </span><span class="symbol" id="span_116_3224">.*</span><span> </span><span id="span_116_3226">zHat</span><span class="symbol" id="span_116_3227">)</span><span> </span><span class="literal" id="span_116_3229">0.3</span><span> </span><span class="literal" id="span_116_3231">1.0</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># We change to a small num pix here to reduce the compute needed for tests
</span></div>
<div class="code-block"><span id="span_119_3233">params</span><span> </span><span class="symbol" id="span_119_3234">=</span><span> </span><span id="span_119_3235">defaultParams</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_120_3237">camera</span><span> </span><span class="symbol" id="span_120_3238">=</span><span> </span><span class="keyword" id="span_120_3240">if</span><span> </span><span id="span_120_3241">dex_test_mode</span><span class="symbol" id="span_120_3244">(</span><span class="symbol" id="span_120_3245">)</span><span class="comment">
  </span><span class="keyword" id="span_120_3246">then</span><span> </span><span id="span_120_3247">testCamera</span><span class="comment">
  </span><span class="keyword" id="span_120_3248">else</span><span> </span><span id="span_120_3249">defaultCamera</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment"># %time
</span></div>
<div class="code-block"><span id="span_123_3251">MkImage</span><span class="symbol" id="span_123_3254">(</span><span class="symbol" id="span_123_3256">_</span><span class="symbol" id="span_123_3257">,</span><span> </span><span class="symbol" id="span_123_3259">_</span><span class="symbol" id="span_123_3260">,</span><span> </span><span id="span_123_3261">image</span><span class="symbol" id="span_123_3262">)</span><span> </span><span class="symbol" id="span_123_3263">=</span><span> </span><span id="span_123_3264">takePicture</span><span> </span><span id="span_123_3266">params</span><span> </span><span id="span_123_3268">theScene</span><span> </span><span id="span_123_3270">camera</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">:</span><span id="span_124_3271">html</span><span> </span><span id="span_124_3272">imshow</span><span> </span><span id="span_124_3274">image</span><span class="comment">
</span></div>
<div class="result"><img class="plot-img" src="data:image/png;base64, "></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="prose-block"><p>Just for fun, here's what we get with a single sample (sharing the PRNG
key among pixels)</p>
</div>
<div class="code-block"><span id="span_127_3276">params2</span><span> </span><span class="symbol" id="span_127_3277">=</span><span> </span><span id="span_127_3278">Params</span><span> </span><span class="literal" id="span_127_3280">1</span><span> </span><span class="literal" id="span_127_3282">10</span><span> </span><span id="span_127_3284">True</span><span class="comment">
</span></div>
<div class="code-block"><span id="span_128_3286">MkImage</span><span class="symbol" id="span_128_3289">(</span><span class="symbol" id="span_128_3291">_</span><span class="symbol" id="span_128_3292">,</span><span> </span><span class="symbol" id="span_128_3294">_</span><span class="symbol" id="span_128_3295">,</span><span> </span><span id="span_128_3296">image2</span><span class="symbol" id="span_128_3297">)</span><span> </span><span class="symbol" id="span_128_3298">=</span><span> </span><span id="span_128_3299">takePicture</span><span> </span><span id="span_128_3301">params2</span><span> </span><span id="span_128_3303">theScene</span><span> </span><span id="span_128_3305">camera</span><span class="comment">
</span></div>
<div class="code-block"><span class="comment">
</span></div>
<div class="code-block"><span class="comment">:</span><span id="span_130_3306">html</span><span> </span><span id="span_130_3307">imshow</span><span> </span><span id="span_130_3309">image2</span><span class="comment">
</span></div>
<div class="result"><img class="plot-img" src="data:image/png;base64, "></div>
</body></html>